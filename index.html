<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Coffee Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#index">Coffee Documentation</a>
<ul class="sectlevel1">
<li><a href="#common_architecture">1. Architecture structure</a></li>
<li><a href="#common_coffee-core">2. Coffee Core</a>
<ul class="sectlevel2">
<li><a href="#common_core_coffee-se">2.1. coffee-se</a>
<ul class="sectlevel3">
<li><a href="#common_core_coffee-se_coffee-se-logging">2.1.1. coffee-se-logging</a></li>
</ul>
</li>
<li><a href="#common_core_coffee-cdi">2.2. coffee-dto</a>
<ul class="sectlevel3">
<li><a href="#_coffee_dto_base">2.2.1. coffee-dto-base</a></li>
<li><a href="#_coffee_dto_xsd">2.2.2. coffee-dto-xsd</a></li>
<li><a href="#_coffee_dto_gen">2.2.3. coffee-dto-gen</a></li>
<li><a href="#_coffee_dto_impl">2.2.4. coffee-dto-impl</a></li>
</ul>
</li>
<li><a href="#common_core_coffee-cdi">2.3. coffee-cdi</a>
<ul class="sectlevel3">
<li><a href="#common_core_coffee-cdi_logger">2.3.1. logger</a></li>
<li><a href="#common_core_coffee-cdi_logger">2.3.2. config</a></li>
<li><a href="#common_core_coffee-cdi_trace">2.3.3. trace</a></li>
<li><a href="#common_core_coffee-cdi_metrics">2.3.4. Metrics</a></li>
</ul>
</li>
<li><a href="#common_core_coffee-configuration">2.4. coffee-configuration</a>
<ul class="sectlevel3">
<li><a href="#_configurationhelper_class">2.4.1. ConfigurationHelper class</a></li>
<li><a href="#_applicationconfiguration_class">2.4.2. ApplicationConfiguration class</a></li>
</ul>
</li>
<li><a href="#common_core_coffee-tool">2.5. coffee-tool</a></li>
<li><a href="#common_core_coffee-jpa">2.6. coffee-jpa</a>
<ul class="sectlevel3">
<li><a href="#TransactionHelper">2.6.1. TransactionHelper</a></li>
<li><a href="#_microprofile_health_support">2.6.2. microprofile-health support</a></li>
</ul>
</li>
<li><a href="#common_core_coffee-rest">2.7. coffee-rest</a>
<ul class="sectlevel3">
<li><a href="#common_core_coffee-rest_BaseRestLogger">2.7.1. BaseRestLogger</a></li>
<li><a href="#common_core_coffee-rest_optimized_BaseRestLogger">2.7.2. Optimized BaseRestLogger</a></li>
<li><a href="#common_core_coffee-rest_LogSpecifier">2.7.3. LogSpecifier</a></li>
<li><a href="#common_core_coffee-rest_JaxbTool">2.7.4. JaxbTool</a></li>
<li><a href="#_xsd_catalog_schema_management">2.7.5. XSD Catalog schema management</a></li>
<li><a href="#_json_support">2.7.6. Json support</a></li>
<li><a href="#common_core_coffee-rest_OpenAPIFilter">2.7.7. OpenApiFilter</a></li>
<li><a href="#_messagebodywriter">2.7.8. MessageBodyWriter</a></li>
<li><a href="#_projectstage">2.7.9. ProjectStage</a></li>
<li><a href="#_eviction">2.7.10. Eviction</a></li>
</ul>
</li>
<li><a href="#common_core_coffee-grpc">2.8. coffee-grpc</a>
<ul class="sectlevel3">
<li><a href="#_coffee_grpc_api">2.8.1. coffee-grpc-api</a></li>
<li><a href="#_coffee_grpc_base">2.8.2. coffee-grpc-base</a></li>
<li><a href="#_coffee_grpc_protoc">2.8.3. coffee-grpc-protoc</a></li>
<li><a href="#_coffee_grpc_server_extension">2.8.4. coffee-grpc-server-extension</a></li>
<li><a href="#_grpc_client_coffee_grpc_client_extension">2.8.5. gRPC client (coffee-grpc-client-extension)</a></li>
<li><a href="#_grpc_metrics">2.8.6. gRPC Metrics</a></li>
<li><a href="#_grpc_tracing">2.8.7. gRPC Tracing</a></li>
<li><a href="#_coffee_dtocoffee_dto_xsd2proto">2.8.8. coffee-dto/coffee-dto-xsd2proto</a></li>
<li><a href="#_coffee_dtocoffee_dto_stub_gen">2.8.9. coffee-dto/coffee-dto-stub-gen</a></li>
<li><a href="#_microprofile_health_support_2">2.8.10. microprofile-health support</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#common_coffee-model">3. Coffee model</a>
<ul class="sectlevel2">
<li><a href="#_coffee_model_base">3.1. coffee-model-base</a>
<ul class="sectlevel3">
<li><a href="#_id_generation">3.1.1. ID generation</a></li>
<li><a href="#_audit_columns">3.1.2. Audit columns</a></li>
<li><a href="#_version_column">3.1.3. Version column</a></li>
</ul>
</li>
<li><a href="#_coffee_model_security">3.2. coffee-model-security</a></li>
</ul>
</li>
<li><a href="#common_coffee-modules">4. Coffee modules</a>
<ul class="sectlevel2">
<li><a href="#common_module_coffee-module-activemq">4.1. coffee-module-activemq</a></li>
<li><a href="#common_module_coffee-module-csv">4.2. coffee-module-csv</a>
<ul class="sectlevel3">
<li><a href="#_disambiguation">4.2.1. Disambiguation</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-document">4.3. coffee-module-document</a></li>
<li><a href="#common_module_coffee-module-etcd">4.4. coffee-module-etcd</a>
<ul class="sectlevel3">
<li><a href="#_deploying_configurations_configuring_etcd_host">4.4.1. Deploying configurations, configuring ETCD host</a></li>
<li><a href="#_microprofile_config">4.4.2. Microprofile-config</a></li>
<li><a href="#_configetcdhandler_class">4.4.3. ConfigEtcdHandler class</a></li>
<li><a href="#_configetcdservice_class">4.4.4. ConfigEtcdService class</a></li>
<li><a href="#_namespaces_configuration_naming_conventions">4.4.5. Namespaces, configuration naming conventions</a></li>
<li><a href="#_configuration_management_using_command_line_tool">4.4.6. Configuration management using Command Line Tool</a></li>
<li><a href="#_logging_2">4.4.7. Logging</a></li>
<li><a href="#_microprofile_health_támogatás">4.4.8. microprofile-health támogatás</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-localization">4.5. coffee-module-localization</a>
<ul class="sectlevel3">
<li><a href="#_localization">4.5.1. Localization</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-mongodb">4.6. coffee-module-mongodb</a>
<ul class="sectlevel3">
<li><a href="#_implementation_in_the_project">4.6.1. Implementation in the project</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-notification">4.7. coffee-module-notification</a></li>
<li><a href="#common_module_coffee-module-redis">4.8. coffee-module-redis</a>
<ul class="sectlevel3">
<li><a href="#_redisconnection">4.8.1. RedisConnection</a></li>
<li><a href="#_redismanager">4.8.2. RedisManager</a></li>
<li><a href="#_redis_operations">4.8.3. Redis operations</a></li>
<li><a href="#_microprofile_health_support_3">4.8.4. microprofile-health support</a></li>
<li><a href="#coffee_module_redis-metrics">4.8.5. microprofile-metrics support</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-redisstream">4.9. coffee-module-redisstream</a>
<ul class="sectlevel3">
<li><a href="#_redisconnection_2">4.9.1. RedisConnection</a></li>
<li><a href="#_message_and_content">4.9.2. Message and content</a></li>
<li><a href="#common_module_coffee-module-redisstream-config">4.9.3. Configuration</a></li>
<li><a href="#_non_acked_messages">4.9.4. Non-ACKed messages</a></li>
<li><a href="#_graceful_shutdown_support">4.9.5. Graceful shutdown support</a></li>
<li><a href="#_metric_information">4.9.6. Metric information</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-redispubsub">4.10. coffee-module-redispubsub</a>
<ul class="sectlevel3">
<li><a href="#_redis_pubsub">4.10.1. Redis Pub/Sub</a></li>
<li><a href="#_redisconnection_3">4.10.2. RedisConnection</a></li>
<li><a href="#_microprofile_reactive_messaging">4.10.3. Microprofile-reactive-messaging</a></li>
<li><a href="#_subscriberconsumer_creation">4.10.4. Subscriber(consumer) creation</a></li>
<li><a href="#_publisher_creation">4.10.5. Publisher creation</a></li>
<li><a href="#_message">4.10.6. Message</a></li>
<li><a href="#_mp_reactive_messaging_own_shares">4.10.7. mp-reactive-messaging own shares</a></li>
<li><a href="#_examples">4.10.8. Examples</a></li>
<li><a href="#_shortcomings_possibilities_for_further_development">4.10.9. Shortcomings, possibilities for further development</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-ruleng">4.11. coffee-module-ruleng</a>
<ul class="sectlevel3">
<li><a href="#_principles">4.11.1. Principles</a></li>
<li><a href="#_rule">4.11.2. Rule</a></li>
<li><a href="#_validator">4.11.3. Validator</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-mp-opentracing">4.12. coffee-module-mp-opentracing</a>
<ul class="sectlevel3">
<li><a href="#_microprofile_opentracing">4.12.1. microprofile-opentracing</a></li>
<li><a href="#_core">4.12.2. Core</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-mp-metrics">4.13. coffee-module-mp-metrics/micrometer</a>
<ul class="sectlevel3">
<li><a href="#_coffee_core">4.13.1. coffee-core</a></li>
<li><a href="#_coffee_module_redis">4.13.2. coffee-module-redis</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-mp-restclient">4.14. coffee-module-mp-restclient</a>
<ul class="sectlevel3">
<li><a href="#_microprofile_rest_client">4.14.1. microprofile-rest-client</a></li>
<li><a href="#_core_2">4.14.2. Core</a></li>
<li><a href="#_implementation_in_the_project_2">4.14.3. Implementation in the project</a></li>
<li><a href="#_usage_examples">4.14.4. Usage examples</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-totp">4.15. coffee-module-totp</a>
<ul class="sectlevel3">
<li><a href="#_implementation_in_the_project_3">4.15.1. Implementation in the project</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-docgen-config">4.16. coffee-module-docgen-config</a>
<ul class="sectlevel3">
<li><a href="#_usage_2">4.16.1. Usage</a></li>
<li><a href="#_configuration">4.16.2. Configuration</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-docgen-sqlcatalog">4.17. coffee-module-docgen-sqlcatalog</a>
<ul class="sectlevel3">
<li><a href="#_usage_3">4.17.1. Usage</a></li>
<li><a href="#_configuration_2">4.17.2. Configuration</a></li>
</ul>
</li>
<li><a href="#common_module_coffee-module-wildfly">4.18. coffee-module-wildfly</a></li>
<li><a href="#common_module_coffee-module-quarkus">4.19. coffee-module-quarkus</a></li>
</ul>
</li>
<li><a href="#common_coffee-quarkus-extensions">5. Coffee Quarkus extensions</a>
<ul class="sectlevel2">
<li><a href="#_general">5.1. General</a></li>
<li><a href="#common_coffee-quarkus-extensions-module-mp-restclient">5.2. coffee-module-mp-restclient-extension</a></li>
<li><a href="#common_coffee-quarkus-extensions-module-etcd">5.3. coffee-module-etcd-extension</a></li>
<li><a href="#common_coffee-quarkus-extensions-tool">5.4. coffee-tool-extension</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#migration">Migration descriptions</a>
<ul class="sectlevel1">
<li><a href="#_v2_0_0">1. v2.0.0</a>
<ul class="sectlevel2">
<li><a href="#_changes">1.1. Changes</a>
<ul class="sectlevel3">
<li><a href="#_general_2">1.1.1. General</a></li>
<li><a href="#_coffee_dto">1.1.2. coffee-dto</a></li>
<li><a href="#_coffee_deltaspike">1.1.3. coffee-deltaspike</a></li>
<li><a href="#_coffee_rest">1.1.4. coffee-rest</a></li>
<li><a href="#_coffee_model_base_2">1.1.5. coffee-model-base</a></li>
<li><a href="#_coffee_jpa">1.1.6. coffee-jpa</a></li>
<li><a href="#_coffee_module_artemis">1.1.7. coffee-module-artemis</a></li>
<li><a href="#_coffee_module_notification">1.1.8. coffee-module-notification</a></li>
<li><a href="#_coffee_module_mp_opentracing">1.1.9. coffee-module-mp-opentracing</a></li>
<li><a href="#_junit_tests">1.1.10. junit tests</a></li>
<li><a href="#_coffee_module_csv">1.1.11. coffee-module-csv</a></li>
<li><a href="#_coffee_se_logging">1.1.12. coffee-se-logging</a></li>
</ul>
</li>
<li><a href="#_coffee_module_etcd">1.2. coffee-module-etcd</a>
<ul class="sectlevel4">
<li><a href="#_migration">Migration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_v2_0_0_v2_1_0">2. v2.0.0 → v2.1.0</a>
<ul class="sectlevel2">
<li><a href="#_whats_new">2.1. What&#8217;s new</a>
<ul class="sectlevel3">
<li><a href="#_coffee_grpc">2.1.1. coffee-grpc</a></li>
</ul>
</li>
<li><a href="#_changes_2">2.2. Changes</a>
<ul class="sectlevel3">
<li><a href="#_coffee_module_etcd_2">2.2.1. coffee-module-etcd</a></li>
<li><a href="#_coffee_rest_2">2.2.2. coffee-rest</a></li>
<li><a href="#_coffee_module_mp_restclient">2.2.3. coffee-module-mp-restclient</a></li>
<li><a href="#_coffee_tool">2.2.4. coffee-tool</a></li>
<li><a href="#_coffee_jpa_2">2.2.5. coffee-jpa</a></li>
<li><a href="#_batchservice">2.2.6. BatchService</a></li>
<li><a href="#_coffee_cdi">2.2.7. coffee-cdi</a></li>
<li><a href="#_coffee_deltaspike_data">2.2.8. coffee-deltaspike-data</a></li>
<li><a href="#_coffee_module_mp_opentracing_2">2.2.9. coffee-module-mp-opentracing</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_v2_1_0_v2_2_0">3. v2.1.0 → v2.2.0</a>
<ul class="sectlevel2">
<li><a href="#_whats_new_2">3.1. What&#8217;s new</a>
<ul class="sectlevel3">
<li><a href="#_coffee_tool_2">3.1.1. coffee-tool</a></li>
<li><a href="#_coffee_jpa_3">3.1.2. coffee-jpa</a></li>
<li><a href="#_coffee_module_redis_2">3.1.3. coffee-module-redis</a></li>
<li><a href="#_coffee_module_etcd_3">3.1.4. coffee-module-etcd</a></li>
<li><a href="#_coffee_module_base">3.1.5. coffee-module-base</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_v2_2_0_v2_3_0">4. v2.2.0 → v2.3.0</a>
<ul class="sectlevel3">
<li><a href="#_coffee_model_base_3">4.1. coffee-model-base</a></li>
<li><a href="#_coffee_tool_3">4.2. coffee-tool</a></li>
<li><a href="#_coffee_module_etcd_4">4.3. coffee-module-etcd</a></li>
</ul>
</li>
<li><a href="#_v2_3_0_v2_4_0">5. v2.3.0 → v2.4.0</a>
<ul class="sectlevel3">
<li><a href="#_coffee_rest_3">5.1. coffee-rest</a></li>
</ul>
</li>
<li><a href="#_v2_4_0_v2_5_0">6. v2.4.0 → v2.5.0</a>
<ul class="sectlevel2">
<li><a href="#_global">6.1. Global</a></li>
<li><a href="#_metric_independency">6.2. Metric independency</a>
<ul class="sectlevel3">
<li><a href="#_coffee_jpa_coffee_module_redis">6.2.1. coffee-jpa &amp; coffee-module-redis</a></li>
<li><a href="#_coffee_grpc_metrics_impl">6.2.2. coffee-grpc-metrics-impl</a></li>
</ul>
</li>
<li><a href="#_other_developments">6.3. Other developments</a>
<ul class="sectlevel3">
<li><a href="#_coffee_tool_4">6.3.1. coffee-tool</a></li>
<li><a href="#_coffee_module_redisstream">6.3.2. coffee-module-redisstream</a></li>
<li><a href="#_coffee_rest_4">6.3.3. coffee-rest</a></li>
<li><a href="#_coffee_module_etcd_5">6.3.4. coffee-module-etcd</a></li>
<li><a href="#_coffee_jpa_4">6.3.5. coffee-jpa</a></li>
<li><a href="#_coffee_module_configdoc">6.3.6. coffee-module-configdoc</a></li>
<li><a href="#_coffee_module_mp_restclient_2">6.3.7. coffee-module-mp-restclient</a></li>
</ul>
</li>
<li><a href="#_trace_detachment">6.4. Trace detachment</a>
<ul class="sectlevel3">
<li><a href="#_coffee_cdi_2">6.4.1. coffee-cdi</a></li>
<li><a href="#_coffee_grpc_opentracing_impl">6.4.2. coffee-grpc-opentracing-impl</a></li>
<li><a href="#_coffee_grpc_traces_api">6.4.3. coffee-grpc-traces-api</a></li>
<li><a href="#_coffee_module_mongodb">6.4.4. coffee-module-mongodb</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_v2_5_0_v2_6_0">7. v2.5.0 → v2.6.0</a>
<ul class="sectlevel2">
<li><a href="#_global_2">7.1. Global</a>
<ul class="sectlevel3">
<li><a href="#_coffee_bom">7.1.1. Coffee BOM</a></li>
<li><a href="#_hibernate">7.1.2. Hibernate</a></li>
</ul>
</li>
<li><a href="#_changes_3">7.2. Changes</a>
<ul class="sectlevel3">
<li><a href="#_coffee_jpa_5">7.2.1. coffee-jpa</a></li>
<li><a href="#_coffee_rest_5">7.2.2. coffee-rest</a></li>
<li><a href="#_coffee_module_mp_restclient_3">7.2.3. coffee-module-mp-restclient</a></li>
<li><a href="#_coffee_quarkus_extensions">7.2.4. Coffee Quarkus Extensions</a></li>
<li><a href="#_coffee_deltaspike_message">7.2.5. coffee-deltaspike-message</a></li>
<li><a href="#_coffee_model_base_4">7.2.6. coffee-model-base</a></li>
<li><a href="#_coffee_rest_6">7.2.7. coffee-rest</a></li>
<li><a href="#_coffee_module_redisstream_2">7.2.8. coffee-module-redisstream</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_v2_6_0_v2_7_0">8. v2.6.0 → v2.7.0</a>
<ul class="sectlevel2">
<li><a href="#_global_3">8.1. Global</a>
<ul class="sectlevel3">
<li><a href="#_coffee_se_api">8.1.1. coffee-se-api</a></li>
<li><a href="#_coffee_se_function">8.1.2. coffee-se-function</a></li>
<li><a href="#_coffee_tool_5">8.1.3. coffee-tool</a></li>
<li><a href="#_coffee_dto_base_2">8.1.4. coffee-dto-base</a></li>
<li><a href="#_coffee_cdi_3">8.1.5. coffee-cdi</a></li>
<li><a href="#_coffee_rest_7">8.1.6. coffee-rest</a></li>
<li><a href="#_coffee_grpc_2">8.1.7. coffee-grpc</a></li>
<li><a href="#_coffee_module_redis_3">8.1.8. coffee-module-redis</a></li>
<li><a href="#_coffee_module">8.1.9. coffee-module</a></li>
<li><a href="#_coffee_model">8.1.10. coffee-model</a></li>
<li><a href="#_coffee_deltaspike_data_2">8.1.11. coffee-deltaspike-data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_v2_7_0_v2_8_0">9. v2.7.0 → v2.8.0</a>
<ul class="sectlevel2">
<li><a href="#_global_4">9.1. Global</a>
<ul class="sectlevel3">
<li><a href="#_coffee_jpa_6">9.1.1. coffee-jpa</a></li>
<li><a href="#_coffee_dto_base_3">9.1.2. coffee-dto-base</a></li>
<li><a href="#_coffee_tool_6">9.1.3. coffee-tool</a></li>
<li><a href="#_coffee_se_api_2">9.1.4. coffee-se-api</a></li>
<li><a href="#_coffee_se_util">9.1.5. coffee-se-util</a></li>
<li><a href="#_coffee_mode_base">9.1.6. coffee-mode-base</a></li>
<li><a href="#_coffee_rest_8">9.1.7. coffee-rest</a></li>
<li><a href="#_coffee_grpc_3">9.1.8. coffee-grpc</a></li>
<li><a href="#_coffee_module_2">9.1.9. coffee-module</a></li>
<li><a href="#_coffee_dto_base_4">9.1.10. coffee-dto-base</a></li>
<li><a href="#_coffee_se_io">9.1.11. coffee-se-io</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_v2_8_0_v2_9_0">10. v2.8.0 → v2.9.0</a>
<ul class="sectlevel3">
<li><a href="#_documentation">10.1. documentation</a></li>
<li><a href="#_coffee_module_notification_2">10.2. coffee-module-notification</a></li>
<li><a href="#_coffee_grpc_4">10.3. coffee-grpc</a></li>
<li><a href="#_json_library_change">10.4. json library change</a></li>
</ul>
</li>
<li><a href="#_v2_9_0_v2_10_0">11. v2.9.0 → v2.10.0</a>
<ul class="sectlevel3">
<li><a href="#_coffee_configuration">11.1. coffee-configuration</a></li>
<li><a href="#_coffee_redisstream">11.2. coffee-redisstream</a></li>
<li><a href="#_java11_support_remove">11.3. Java11 support remove</a></li>
<li><a href="#_coffee_tool_7">11.4. coffee-tool</a></li>
<li><a href="#_coffee_model_base_5">11.5. coffee-model-base</a></li>
<li><a href="#_coffee_rest_9">11.6. coffee-rest</a></li>
<li><a href="#_coffee_deltaspike_data_extension">11.7. coffee-deltaspike-data-extension</a></li>
</ul>
</li>
<li><a href="#_v2_10_0_v2_11_0">12. v2.10.0 → v2.11.0</a>
<ul class="sectlevel3">
<li><a href="#_new_modules_added">12.1. new modules added</a></li>
<li><a href="#_coffee_tool_8">12.2. coffee-tool</a></li>
<li><a href="#_coffee_rest_10">12.3. coffee-rest</a></li>
<li><a href="#_hibernate_version_upgrade">12.4. Hibernate version upgrade</a></li>
<li><a href="#_coffee_module_etcd_extension">12.5. coffee-module-etcd-extension</a></li>
<li><a href="#_coffee_tool_extension">12.6. coffee-tool-extension</a></li>
<li><a href="#_coffee_module_redisstream_3">12.7. coffee-module-redisstream</a></li>
</ul>
</li>
<li><a href="#_v2_11_0_v2_12_0">13. v2.11.0 → v2.12.0</a>
<ul class="sectlevel3">
<li><a href="#_global_5">13.1. Global</a></li>
<li><a href="#_coffee_rest_11">13.2. coffee-rest</a></li>
<li><a href="#_coffee_module_docgen">13.3. coffee-module-docgen</a></li>
<li><a href="#_migration_77">13.4. Migration</a></li>
<li><a href="#_coffee_module_redis_4">13.5. coffee-module-redis</a></li>
<li><a href="#_coffee_quarkus_extensions_2">13.6. coffee-quarkus-extensions</a></li>
<li><a href="#_coffee_dto_base_5">13.7. coffee-dto-base</a></li>
<li><a href="#_coffee_se_api_3">13.8. coffee-se-api</a></li>
<li><a href="#_coffee_cdi_4">13.9. coffee-cdi</a></li>
</ul>
</li>
<li><a href="#_howto">14. HOWTO</a>
<ul class="sectlevel2">
<li><a href="#howto_xsd-xml-validation-depend-on-version">14.1. XML XSD version dependent validation</a>
<ul class="sectlevel3">
<li><a href="#_version_dependent_validation_outside_coffee_in_projects">14.1.1. Version dependent validation outside Coffee in projects</a></li>
<li><a href="#_also_prepare_the_providers">14.1.2. Also prepare the providers</a></li>
<li><a href="#_if_you_want_to_use_your_own_lsresourceresolver">14.1.3. If you want to use your own LSResourceResolver</a></li>
<li><a href="#_troubleshooting_at_project_level">14.1.4. Troubleshooting at project level</a></li>
<li><a href="#_if_there_has_been_no_xsd_validation_so_far">14.1.5. If there has been no XSD validation so far</a></li>
</ul>
</li>
<li><a href="#howto_xsd_catalog">14.2. XSD Catalog and generation</a>
<ul class="sectlevel3">
<li><a href="#_general_3">14.2.1. General</a></li>
<li><a href="#_sample">14.2.2. Sample</a></li>
<li><a href="#howto_xsd_catalog_CatalogMegoldas">14.2.3. Solution with catalog</a></li>
<li><a href="#_use_cases">14.2.4. Use cases</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="index" class="sect0">Coffee Documentation</h1>
<div class="paragraph">
<p>The coff:ee is a JakartaEE solution set designed to bring together common algorithms from the enterprise world,
and provide a basic solution that can be tailored to our own needs if required.</p>
</div>
<div class="paragraph">
<p>Each company develops its own solution set, which tries to bring projects together, so that the same modules don&#8217;t have to be rewritten, copied and maintained.</p>
</div>
<div class="paragraph">
<p>This solution set is suitable to serve both SOA and Microservice architecture. Its architecture is modular and can be overwritten at project level for almost everything. The framework is based on the following systems, which are crucial for the whole operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jakarta EE 10+</p>
</li>
<li>
<p>Java 17+</p>
</li>
<li>
<p>CDI 4.0+</p>
</li>
<li>
<p>Jboss logging</p>
</li>
<li>
<p>gson</p>
</li>
<li>
<p>guava</p>
</li>
<li>
<p>commons-lang3</p>
</li>
<li>
<p>apache http</p>
</li>
<li>
<p>resteasy</p>
</li>
<li>
<p>microprofile.io 6.0+</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="common_architecture">1. Architecture structure</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="pic/diag-ditaa-md5-6524fe0ab4e9b9f7f185bd9824619217.png" alt="Diagram" width="820" height="1036">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common_coffee-core">2. Coffee Core</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="common_core_coffee-se">2.1. coffee-se</h3>
<div class="paragraph">
<p>The purpose of this module is to collect classes that are as independent as possible from the Jakarta EE API.</p>
</div>
<div class="sect3">
<h4 id="common_core_coffee-se_coffee-se-logging">2.1.1. coffee-se-logging</h4>
<div class="paragraph">
<p>Module for logging- and MDC-related JakartaEE components without any dependencies.</p>
</div>
<div class="sect4">
<h5 id="_logging">Logging</h5>
<div class="paragraph">
<p>Contains a basic logging system using <code>java.util.logging.Logger</code>.</p>
</div>
<div class="listingblock">
<div class="title">sample usage in SE environment</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import hu.icellmobilsoft.coffee.se.logging.Logger;

private Logger log = Logger.getLogger(LogSample.class);

public String logMessage() {
    log.trace("sample log message");
    return "something";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more description and usage via CDI, see <a href="#common_core_coffee-cdi_logger">coffee-cdi/logger</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="common_core_coffee-se_coffee-se-logging_MDC">MDC</h5>
<div class="paragraph">
<p>The module contains its own framework for MDC (Mapped Diagnostic Context) management.
This is because there may be different MDC solutions on specific projects (e.g. jboss, slf4j, logback&#8230;&#8203;).
It is used via the static methods of the <code>hu.icellmobilsoft.coffee.se.logging.mdc.MDC</code> class.</p>
</div>
<div class="paragraph">
<p>Inside the MDC class, it tries to search for an MDC solution available on the classpath and delegate requests to the found class.
Currently the <code>org.jboss.logging.MDC</code> and <code>org.slf4j.MDC</code> implementations are supported,
but can be extended to the project level using the service loader module.</p>
</div>
<div class="sect5">
<h6 id="_mdc_extension">MDC extension</h6>
<div class="paragraph">
<p>To use unsupported MDC implementations at the Coffee level, the <code>MDCAdapter</code> and <code>MDCAdapterProvider</code>
interfaces and then load the implemented <code>MDCAdapterProvider</code> using the service loader mechanism.</p>
</div>
<div class="sect6">
<h7 id="_example_of_custommdc_connection">Example of <code>CustomMDC</code> connection:</h7>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement <code>MDCAdapter</code> for <code>CustomMDC</code>:</p>
<div class="listingblock">
<div class="title">com.project.CustomMDCAdapter</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class CustomMDCAdapter implements MDCAdapter {

    @Override
    public String get(String key){
        //The adapter delegates its calls to our CustomMdc
        return CustomMDC.get(key);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Implement <code>MDCAdapterProvider</code> to build <code>CustomMDCAdapter</code>:</p>
<div class="listingblock">
<div class="title">com.project.CustomMDCAdapterProvider</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class CustomMDCAdapterProvider implements MDCAdapterProvider {

    @Override
    public MDCAdapter getAdapter() throws Exception;{
        return new CustomMDCAdapter();
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Bind <code>CustomMDCAdapterProvider</code> via service loader:</p>
<div class="listingblock">
<div class="title">META-INF/services/hu.icellmobilsoft.coffee.se.logging.mdc.MDCAdapterProvider</div>
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">com.project.CustomMDCAdapterProvider</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_mdc_order">MDC order</h6>
<div class="paragraph">
<p>Try to list the available MDC implementations in the following order.
The MDC used inside will be the first one working:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ServiceLoader extensions</p>
</li>
<li>
<p><code>org.jboss.logging.MDC</code></p>
</li>
<li>
<p><code>org.slf4j.MDC</code> .</p>
</li>
<li>
<p><code>CoffeeMDCAdapter</code> .</p>
<div class="ulist">
<ul>
<li>
<p>coff:ee implementation, fallback only</p>
</li>
<li>
<p>values are stored in <code>ThreadLocal</code></p>
</li>
<li>
<p>must be handled separately if you want it to be logged.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_core_coffee-cdi">2.2. coffee-dto</h3>
<div class="paragraph">
<p>Module designed to summarize the ancestors of the basic DTO, Adapters and Exception classes,
mainly to be able to extract some common code into the Coffee jakartaEE solution set.
It should not have any dependencies,
except annotations serving documentation and JAXB functions.</p>
</div>
<div class="paragraph">
<p>It consists of several submodules.</p>
</div>
<div class="sect3">
<h4 id="_coffee_dto_base">2.2.1. coffee-dto-base</h4>
<div class="paragraph">
<p>Contains java classes that serve as ancestors for the entire Coffee javaEE solution set.</p>
</div>
<div class="paragraph">
<p>This is where the java.time (java 8+) class for handling XSD universal adapters and basic paths to rest endpoints is served.</p>
</div>
<div class="paragraph">
<p>The module contains the basic exception classes.
All other exceptions that are created,
can only be derived from these.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dto_xsd">2.2.2. coffee-dto-xsd</h4>
<div class="paragraph">
<p>Its content should preferably be XSDs to serve as guides on projects.
They should preferably contain very universal XSD simple and complexType,
which projects can bend to their own image.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This module does not generate DTO objects, it only adds XSDs.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dto_gen">2.2.3. coffee-dto-gen</h4>
<div class="paragraph">
<p>This module is used to generate the Coffee DTO.
It is organized separately to be easily replaced from the dependency structure.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dto_impl">2.2.4. coffee-dto-impl</h4>
<div class="paragraph">
<p>The module serves as a sample implementation for <code>coffee-dto-base</code>, <code>coffee-dto-xsd</code> and <code>coffee-dto-gen</code>.
Projects using Coffee will include it.
If the DTOs generated by Coffee do not match the target project, you will have to excelude them at this module.</p>
</div>
<div class="paragraph">
<p>By itself it is a universal, usable module.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_core_coffee-cdi">2.3. coffee-cdi</h3>
<div class="paragraph">
<p>The purpose of this module is to connect the jakarta EE, logger, deltaspike and microprofile-config.</p>
</div>
<div class="paragraph">
<p>All CDI based. Description of components and use cases below:</p>
</div>
<div class="sect3">
<h4 id="common_core_coffee-cdi_logger">2.3.1. logger</h4>
<div class="paragraph">
<p>Coffee uses its own logging system, for several reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>wraps the actual logging system (currently it is java util log)</p>
</li>
<li>
<p>collects all the logs that are logged at the request level,
logs all logging that is logged at the logging level, including logging that is not written to the console (or elsewhere) because logging is set to a higher level
(for example, if the root logger is set to INFO level, then the TRACE, DEBUG level log will not be output anywhere).
We are able to log these logs in case of an error to help the debugging process</p>
</li>
<li>
<p>other information can be put into the log request level container</p>
</li>
<li>
<p>check which level of log level is the highest logged</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each class has its own logger, loggers are not inheritable, not transferable. The CDI + jboss logger provides the basis for using it:</p>
</div>
<div class="listingblock">
<div class="title">sample use</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
@Inject
@ThisLogger
private hu.icellmobilsoft.coffee.cdi.logger.AppLogger log;


<i class="conum" data-value="2"></i><b>(2)</b>
@Inject
private hu.icellmobilsoft.coffee.se.logging.Logger log;

<i class="conum" data-value="3"></i><b>(3)</b>
import hu.icellmobilsoft.coffee.cdi.logger.LogProducer;

public static String blabla() {
    LogProducer.getStaticDefaultLogger(BlaBla.class).trace("class blabla");
    LogProducer.getStaticDefaultLogger("BlaBla").trace("class name blabla");
    return "blabla";
}

<i class="conum" data-value="4"></i><b>(4)</b>
import hu.icellmobilsoft.coffee.se.logging.Logger;

public static String blabla() {
    Logger.getLogger(BlaBla.class).trace("class blabla");
    Logger.getLogger("BlaBla").trace("class name blabla");
    return "blabla";
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>where we work with the class in @RequestScope (or higher scope) (90% of the cases)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>where there is no RequestScope</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>where inject is not used, e.g. in static methods</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>in JavaSE environments e.g. cliens jars</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If a parameter is included in the logging, it should be placed between "[parameter]" characters EXCEPT.</p>
</div>
<div class="listingblock">
<div class="title">parameter logging pattern</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">log.trace("Generated id: [{0}]", id);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The purpose of this is to be able to immediately identify the variable value when looking at the log, and also if it has a value of "" (empty String) or null.</p>
</div>
</div>
<div class="sect3">
<h4 id="common_core_coffee-cdi_logger">2.3.2. config</h4>
<div class="paragraph">
<p>As a configuration solution we use the microprofile-config solution.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
microprofile.io<br>
<a href="https://github.com/eclipse/microprofile-config" class="bare">https://github.com/eclipse/microprofile-config</a><br>
<a href="http://mirrors.ibiblio.org/eclipse/microprofile/microprofile-config-1.3/microprofile-config-spec.pdf" class="bare">http://mirrors.ibiblio.org/eclipse/microprofile/microprofile-config-1.3/microprofile-config-spec.pdf</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In short, what is it? You can specify configuration parameters in a wide range of ways. It is not enough to burn a configuration parameter into some properties file, because it may have a different value from environment to environment. The values can be specified at a separate level, be it ETCD, properties, system property, environment property or whatever. The microprofile-config can look up a given key from all available sources and use the highest priority value. Basic use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in code - when not using CDI container, static methods and other cases</p>
</li>
<li>
<p>static - at runtime of the program all</p>
</li>
<li>
<p>dynamic - the key value is searched for dynamically, each time it is used. configuration changes can be made without restarting (for example, setting some system property at runtime)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">configuration sample</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.eclipse.microprofile.config.inject.ConfigProperty;
import org.eclipse.microprofile.config.ConfigProvider;
import javax.inject.Provider;


<i class="conum" data-value="1"></i><b>(1)</b>
public String kodban() {
    Config config = ConfigProvider.getConfig();
    String keyValue = config.getValue("key", String.class);
    return keyValue;
}


<i class="conum" data-value="2"></i><b>(2)</b>
@Inject
@ConfigProperty(name="key")
String keyValue;

public String statikusan() {
    return keyValue;
}


<i class="conum" data-value="3"></i><b>(3)</b>
@Inject
@ConfigProperty(name="key")
Provider&lt;String&gt; keyValue;

public String dynamic() {
    return keyValue.get();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>value retrieved in code</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>static value input</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>dynamic value retrieval</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="common_core_coffee-cdi_trace">2.3.3. trace</h4>
<div class="paragraph">
<p>The annotations in the <code>hu.icellmobilsoft.coffee.cdi.trace.annotation</code> package allow the modules of coff::ee to provide trace information. The annotations are used to allow coff::ee modules to plug into an existing trace flow or to start a new flow.</p>
</div>
<div class="paragraph">
<p>The internal logic of coffee trace implementation is independent and selectable within the projects.
If no trace implementation is selected, then by default, no trace propagation occurs in the system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Trace usage</p>
<div class="ulist">
<ul>
<li>
<p>The <code>@Traced</code> annotation allows a method to become traceable.</p>
<div class="ulist">
<ul>
<li>
<p>SpanAttribute - links the span data of coff:ee modules to the values of mp-opentracing or by mp-telemetry</p>
<div class="ulist">
<ul>
<li>
<p>component - module identifier that is part of the trace, e.g. redis-stream</p>
</li>
<li>
<p>kind - specify type of span, e.g. CONSUMER (default INTERNAL)</p>
</li>
<li>
<p>dbType - database type, e.g. redis</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">sample IOpenTraceHandler</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
@Inject
private ITraceHandler traceHandler;
...

public Object execute(CdiQueryInvocationContext context) {
//create jpa query ...
Traced traced = new Traced.Literal(SpanAttribute.Database.COMPONENT, SpanAttribute.Database.KIND, SpanAttribute.Database.DB_TYPE);
String operation = context.getRepositoryClass() + "." + method.getName();
return traceHandler.runWithTrace(() -&gt; context.executeQuery(jpaQuery), traced, operation);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">sample @Traced</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Traced(component = SpanAttribute.Redis.Stream.COMPONENT, kind = SpanAttribute.Redis.Stream.KIND, dbType = SpanAttribute.Redis.DB_TYPE)
@Override
public void onStream(StreamEntry streamEntry) throws BaseException {
...
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="common_core_coffee-cdi_metrics">2.3.4. Metrics</h4>
<div class="paragraph">
<p>The internal logic of coffee has a metric implementation that is independent
and selectable within projects.
If no metric implementation is selected, then the default
<code>Noop*MetricsHandler</code> is activated in the system.</p>
</div>
<div class="paragraph">
<p>The choice of implementations can be found in the
<a href="#common_module_coffee-module-mp-metrics">coffee-module-mp-metrics/micrometer</a>
documentation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_core_coffee-configuration">2.4. coffee-configuration</h3>
<div class="paragraph">
<p>The purpose of this module is to complement the Microprofile config, e.g. by caching</p>
</div>
<div class="listingblock">
<div class="title">inject configuration values</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// for limited use where speed and high transaction count are not important,
// in such cases it is worth choosing one of the other methods
@Inject
@ConfigProperty(name="key")
Provider&lt;String&gt; keyValue;


// traditional microprofile-config query
public String kodban() {
    Config config = ConfigProvider.getConfig();
    String keyValue = config.getValue("key", String.class);
    return keyValue;
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_configurationhelper_class">2.4.1. ConfigurationHelper class</h4>
<div class="paragraph">
<p>This class allows you to query type specific configurations.</p>
</div>
<div class="listingblock">
<div class="title">Query configuration</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
private ConfigurationHelper configurationHelper;
...
Integer ttl = configurationHelper.getInteger("public.login.session.token.validity");</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_applicationconfiguration_class">2.4.2. ApplicationConfiguration class</h4>
<div class="paragraph">
<p>Similar to the ConfigurationHelper class, but uses @ApplicationScope level caching,
where cached values are stored for 30 minutes. It allows these cached values to be immediately
which can be used to build additional logic (e.g. change the value externally in ETCD),
and then topic JMS to forget the values and immediately read them again).</p>
</div>
<div class="listingblock">
<div class="title">ApplicationConfiguration example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
private ApplicationConfiguration applicationConfiguration;

public String kodban() {
    String minVersion = applicationConfiguration.getString(EtcdVal.KEY_PUBLIC_INVOICE_MIN_REQUEST_VERSION);
    return minVersion;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_core_coffee-tool">2.5. coffee-tool</h3>
<div class="paragraph">
<p>The purpose of this module is to collect basic util classes.</p>
</div>
<div class="paragraph">
<p>All date, String, Number or other static classes should be placed here.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>MavenURLHandler</code></dt>
<dd>
<p>Auxiliary class for XSD Catalog usage, allows to</p>
<div class="literalblock">
<div class="content">
<pre>maven:hu.icellmobilsoft.coffee.dto.xsd:coffee-dto-xsd:jar::!/xsd/en/icellmobilsoft/coffee/dto/common/common.xsd</pre>
</div>
</div>
<div class="paragraph">
<p>URL handling in the code.
It needs to be activated separately, so it&#8217;s not a complication (but it&#8217;s not activated either).</p>
</div>
</dd>
<dt class="hdlist1"><code>AesGcmUtil</code></dt>
<dd>
<p>AES 256 GCM encryption and decryption helper class. The cipher is based on <code>AES/GCM/NoPadding</code>, the key must be 256 bits long, the IV is 12 bytes long. Includes helper methods for key and IV generation.</p>
<div class="paragraph">
<p>Example usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String inputText = "test input test";
byte[] key = AesGcmUtil.generateKey(); //B64: HMTpQ4/aEDKoPGMMqMtjeTJ2s26eOEv1aUrE+syjcB8=
byte[] iv = AesGcmUtil.generateIv(); //B64: 5nqOVSjoGYk/oSwj

byte[] encoded = AesGcmUtil.encryptWithAes256GcmNoPadding(key, inputText.getBytes(StandardCharsets.UTF_8), iv);
String encodedB64 = Base64.getEncoder().encodeToString(encoded); //fRCURHp5DWXtrESNHMo1DUoAcejvKDu9Y5wd5zXblg==

byte[] decoded = AesGcmUtil.decryptWithAes256GcmNoPadding(key, encoded, iv);
String decodedString = new String(decoded, StandardCharsets.UTF_8); //test input test</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Given key-IV pair must not be reused! For this reason, encrypt/decrypt without IV should only be called with single-use keys!
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1"><code>JSON serialization/deserialization</code></dt>
<dd>
<p>Serialization and deserialization of java object to/from JSON is done by <a href="https://projects.eclipse.org/projects/ee4j.yasson">Eclipse Yasson</a>, which provides a standard binding layer between Java classes and JSON documents (Yasson is the official reference implementation of JSON Binding)</p>
<div class="paragraph">
<p>Configuration can be done via project-defaults.yml, here is an example:</p>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">coffee:
    jsonb:
        config:
            propertyVisibilityStrategyClass: hu.icellmobilsoft.coffee.tool.jsonb.FieldOnlyVisibilityStrategy <i class="conum" data-value="1"></i><b>(1)</b>
            binaryDataStrategy: BASE_64 <i class="conum" data-value="2"></i><b>(2)</b>
            nullValues: false <i class="conum" data-value="3"></i><b>(3)</b>
            formatting: false <i class="conum" data-value="4"></i><b>(4)</b>
            failOnUnknownProperties: true <i class="conum" data-value="5"></i><b>(5)</b>
            encoding: "UTF-8" <i class="conum" data-value="6"></i><b>(6)</b>
            strictIJSON: false <i class="conum" data-value="7"></i><b>(7)</b>
            propertyNamingStrategy: IDENTITY <i class="conum" data-value="8"></i><b>(8)</b>
            propertyOrderStrategy: LEXICOGRAPHICAL <i class="conum" data-value="9"></i><b>(9)</b>
            dateFormat: "yyyy-MM-dd'T'HH:mm:ss.SSSZ" <i class="conum" data-value="10"></i><b>(10)</b>
            locale: "en_US" <i class="conum" data-value="11"></i><b>(11)</b>
            customAdapters: <i class="conum" data-value="12"></i><b>(12)</b>
              - "your.custom.JsonbAdapter1"
              - "your.custom.JsonbAdapter2"
            customSerializers: <i class="conum" data-value="13"></i><b>(13)</b>
              - "your.custom.JsonbSerializer1"
              - "your.custom.JsonbSerializer2"
            customDeserializers: <i class="conum" data-value="14"></i><b>(14)</b>
              - "your.custom.JsonbDeserializer1"
              - "your.custom.JsonbDeserializer2"
            customProperties: <i class="conum" data-value="15"></i><b>(15)</b>
              - "jsonb.other-config-parameter1#value1"
              - "jsonb.other-config-parameter2#value2"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above configuration, the following elements can be set:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Property used to specify custom visibility strategy, which fields/properties should be (de)serialized. this configuration requires full class name implementing the interface PropertyVisibilityStrategy in jakarta.json.bind.config.PropertyVisibilityStrategy.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This type can take the values of the enum BinaryDataStrategy in jakarta.json.bind.config.BinaryDataStrategy to determine how binary data is handled.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Property used to specify if json should include fields with null values or not.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use this setting if you want to pretty format json content.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Property used to specify behaviour in case of unknown properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Serialized JSON output encoding format</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Enable/Disable restricted profile I-JSON (short for "Internet JSON") <a href="https://datatracker.ietf.org/doc/html/rfc7493">I-JSON rfc</a></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Set predefined naming strategy which affects serialization and deserialization <a href="https://jakarta.ee/specifications/jsonb/1.0/apidocs/javax/json/bind/config/propertynamingstrategy">javadoc</a></td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Set predefined ordering strategy which affects serialization and deserialization <a href="https://jakarta.ee/specifications/jsonb/1.0/apidocs/javax/json/bind/config/propertyorderstrategy">javadoc</a></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Customized dateFormat applied globally</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Customized local in ISO standard format applied globally</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Custom JsonbAdapter classes for additional control over JSON processing.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Custom JsonbSerializer classes for serializing specific types.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>Custom JsonbDeserializer classes for deserializing specific types.</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>Custom jsonb config parameters, key-values are separated by #</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The values mention above in the example are the default values, these are used in case of missing configuration.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>JsonUtil</code></dt>
<dd>
<p>JsonUtil is a kind of wrapper of JSONB</p>
<div class="listingblock">
<div class="title">example - deserialization of generic type</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String paramString = "[{\"key\":\"testTitleKey\",\"value\":\"testTitleValue\"}]";
Type paramListType = new TypeToken&lt;List&lt;ParameterType&gt;&gt;() {}.getType();
List&lt;ParameterType&gt; list = JsonUtil.toObject(paramString, paramListType);
System.out.println(list.get(0).getKey());</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>AbstractCache</code></dt>
<dd>
<p>It is recommended to derive the project&#8217;s cache objects from the <code>AbstractCache</code> class, as it highlights methods that no longer need to be implemented repeatedly. It also sends metrics about itself in the form of an asynchronous CDI event (<code>CacheMetricsEvent</code>), from which the following data can be extracted:
hitCount, missCount, cache size, and cache name, so that these can be displayed as a gauge.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Additionally, configuration can be done using keys under coffee.cache.guava.{cacheName}</p>
</div>
<div class="listingblock">
<div class="title">configuration</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  cache:
    guava:
      templateCache: <i class="conum" data-value="1"></i><b>(1)</b>
        disableMetrics: false # default <i class="conum" data-value="2"></i><b>(2)</b>
        specs: expireAfterWrite=12h  # default <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>name of the cache</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>enable or disable metrics</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>guava cache specification</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">receive metrics</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private final Map&lt;MetricID, Long&gt; metricValueMap = new ConcurrentHashMap&lt;&gt;();

public void onEventCacheMetrics(@ObservesAsync CacheMetricsEvent message) {
      Tag cacheNameTag = new Tag(NAME_TAG, message.getCacheName());

      updateGauge(message.getMetadataHitCountName(), message.getHitCount(), cacheNameTag);
      updateGauge(message.getMetadataMissCountName, message.getMissCount(), cacheNameTag);
      updateGauge(message.getMetadataSizeName, message.getSize(), cacheNameTag);
}

private void updateGauge(Metadata metadata, long value, Tag... tags) {
        MetricID metricID = new MetricID(metadata.getName(), tags);
        metricValueMap.put(metricID, value);
        metricRegistry.gauge(metadata, metricID, metricValueMap::get, tags);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_core_coffee-jpa">2.6. coffee-jpa</h3>
<div class="paragraph">
<p>The purpose of this module is to connect the JPA.</p>
</div>
<div class="paragraph">
<p>Includes the deltaspike jpa and hibernate hookup.
It contains the paging helper classes, transaction handling classes, and the ancestor of all *Services, the BaseService class.</p>
</div>
<div class="sect3">
<h4 id="TransactionHelper">2.6.1. TransactionHelper</h4>
<div class="paragraph">
<p>Contains helper methods with <strong>@Transactional</strong> annotations for <strong>@FunctionalInterfaces</strong> declared in the <strong>FunctionalInterfaces</strong> class.</p>
</div>
<div class="paragraph">
<p>Thus, it is possible that if the first entry point of a class is not in a transaction, but we want to run a code snippet in a transaction within it, we just need to highlight the desired snippet in a <strong>private</strong> method or in any <strong>@FunctionalInterface</strong> provided by coffee and call the corresponding method of <strong>TransactionHelper</strong>, which will perform the transactional execution.</p>
</div>
<div class="paragraph">
<p>This avoids the need to highlight the logic to be run in the transaction in a <strong>public</strong> method with <strong>@Transactional</strong> annotation and call the method created inside the class via <strong>CDI.current()</strong> or to do the same by highlighting it in a separate class.</p>
</div>
<div class="listingblock">
<div class="title">TransactionHelper usage example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import jakarta.enterprise.inject.Model;
import jakarta.inject.Inject;

import hu.icellmobilsoft.coffee.dto.exception.BaseException;
import hu.icellmobilsoft.coffee.dto.exception.InvalidParameterException;
import hu.icellmobilsoft.coffee.jpa.helper.TransactionHelper;

@Model
public class TransactionHelperExample {

    @Inject
    private InvoiceService invoiceService;

    @Inject
    private TransactionHelper transactionHelper;

    public void example(Invoice invoice) throws BaseException {
        if (invoice == null) {
            throw new InvalidParameterException("invoice is NULL!");
        }

        // operations outside the transaction
        // ...

        // BaseExceptionFunction running in transaction
        transactionHelper.executeWithTransaction(invoiceService::save, invoice);

        // in-transaction BaseExceptionRunner (e.g.: for void method)
        transactionHelper.executeWithTransaction(() -&gt; saveInvoice(invoice));

        // operations outside the transaction
        // ...
    }

    private void saveInvoice(Invoice invoice) throws BaseException {
        invoiceService.save(invoice);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_microprofile_health_support">2.6.2. microprofile-health support</h4>
<div class="paragraph">
<p>The <strong>DatabaseHealth</strong> can check if the database is reachable.
The <strong>DatabasePoolHealth</strong> can check how loaded the connection pool used for operations to the database is.</p>
</div>
<div class="paragraph">
<p>This function is based on metric data,
so it is necessary that one of the implementations is activated.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-micrometer&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/dependency&gt;
&lt;!-- or --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-metrics&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Micrometer metric implementation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Microprofile-metrics metric implementation</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Startup example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class DatabaseHealthCheck {

    @Inject
    private DatabaseHealth databaseHealth;

    @Inject
    private Config mpConfig;

    public HealthCheckResponse checkDatabaseConnection() {
        DatabaseHealthResourceConfig config = new DatabaseHealthResourceConfig();
        config.setBuilderName("oracle");
        config.setDatasourceUrl("jdbc:postgresql://service-postgredb:5432/service_db?currentSchema=service");
        String datasourceName = mpConfig.getOptionalValue(IConfigKey.DATASOURCE_DEFAULT_NAME, String.class)
                .orElse(IConfigKey.DATASOURCE_DEFAULT_NAME_VALUE);
        config.setDsName(datasourceName);
        try {
            return databaseHealth.checkDatabaseConnection(config);
        }catch (BaseException e) {
            // need to be careful with exceptions, because the probe check will fail if we don't handle the exception correctly
            return HealthCheckResponse.builder().name("oracle").up().build();
        }
    }

    @Produces
    @Startup
    public HealthCheck produceDataBaseCheck() {
        return this::checkDatabaseConnection;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Readiness example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class DatabaseHealthCheck {

    @Inject
    private DatabaseHealth databaseHealth;

    public HealthCheckResponse checkDatabasePoolUsage() {
        try {
            return databasePoolHealth.checkDatabasePoolUsage("oracle");
        }catch (BaseException e) {
            return HealthCheckResponse.builder().name("oracle").up().build();
        }
    }

    @Produces
    @Readiness
    public HealthCheck produceDataBasePoolCheck() {
        return this::checkDatabasePoolUsage;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_core_coffee-rest">2.7. coffee-rest</h3>
<div class="paragraph">
<p>Module designed for REST communication and management.</p>
</div>
<div class="paragraph">
<p>It includes the apache http client, various REST loggers and filters. It also contains the language, REST activator and Response util class.</p>
</div>
<div class="sect3">
<h4 id="common_core_coffee-rest_BaseRestLogger">2.7.1. BaseRestLogger</h4>
<div class="paragraph">
<p>This class is used to log HTTP request-response requests to the application.
It is activated manually at the project level using the following pattern:</p>
</div>
<div class="listingblock">
<div class="title">activate in project</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package hu.icellmobilsoft.project.common.rest.logger;

import javax.inject.Inject;
import javax.ws.rs.ext.Provider;

import hu.icellmobilsoft.coffee.cdi.logger.AppLogger;
import hu.icellmobilsoft.coffee.cdi.logger.ThisLogger;
import hu.icellmobilsoft.coffee.rest.log.BaseRestLogger;
import hu.icellmobilsoft.coffee.rest.log.LogConstants;

@Provider <i class="conum" data-value="1"></i><b>(1)</b>
public class RestLogger extends BaseRestLogger {

    @Inject
    @ThisLogger
    private AppLogger log;

    @Override
    public String sessionKey() { <i class="conum" data-value="2"></i><b>(2)</b>
        return LogConstants.LOG_SESSION_ID;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JAX-RS activator (this is the thing that activates it)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Session ID key name in HTTP header</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The HTTP request-response log itself is compiled by the <code>hu.icellmobilsoft.coffee.rest.log.RequestResponseLogger</code> class, and can be used in other situations if needed, for example logging an error.</p>
</div>
<div class="paragraph">
<p>During request logging, sensitive data is masked both from the headers and from the json/xml body (e.g. <code>X-PASSWORD: 1234</code> instead of <code>X_PASSWORD: *</code>).
The data is determined whether it is to be protected based on its key (key for headers and JSON content, tag for XML), which by default is a key corresponding to the regexes <code>[\w\s]*?secret[\w\s]*?</code> or <code>[\w\s]*?pass[\w\s]*?</code> (e.g. userPassword, secretToken, &#8230;&#8203;),
if needed in the project, the regex can be overwritten by specifying the configuration <code>coffee.config.log.sensitive.key.pattern</code> in one of the <strong>default</strong> microprofile-config sources (sys var, env var, META-INF/microprofile-config.properties), multiple patterns can be specified separated by commas.</p>
</div>
<div class="listingblock">
<div class="title">example request log</div>
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">2019-02-01 16:31:33.044 INFO  [thread:default task-1] [hu.icellmobilsoft.coffee.rest.log.BaseRestLogger] [sid:2G7XOSOJBCFRMW08] - * Server in-bound request
&gt; POST http://localhost:8083/external/public/sampleService/sample/interface
&gt; -- Path parameters:
&gt; -- Query parameters:
&gt; -- Header parameters:
&gt; accept: text/xml;charset=utf-8
&gt; Connection: keep-alive
&gt; Content-Length: 106420
&gt; content-type: text/xml;charset=utf-8
&gt; Host: localhost:8083
&gt; User-Agent: Apache-HttpClient/4.5.3 (Java/1.8.0_191)
&gt; X-Client-Address: 10.10.20.49
&gt; X-CustomerNumber: 10098990
&gt; X-Password: *
&gt; X-UserName: sample
&gt;
&gt; entity: [&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;SampleRequest xmlns="http://schemas.nav.gov.hu/OSA/1.0/api"&gt;
    &lt;header&gt;
        &lt;requestId&gt;RID314802331803&lt;/requestId&gt;
        &lt;timestamp&gt;2019-02-01T15:31:32.432Z&lt;/timestamp&gt;
        &lt;requestVersion&gt;1.1&lt;/requestVersion&gt;
        &lt;headerVersion&gt;1.0&lt;/headerVersion&gt;
    &lt;/header&gt;
    &lt;user&gt;
        &lt;passwordHash&gt;*&lt;/passwordHash&gt;
... // röviditve</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">example response log</div>
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">2019-02-01 16:31:34.042 INFO  [thread:default task-1] [hu.icellmobilsoft.coffee.rest.log.BaseRestLogger] [sid:2G7XOSOJBCFRMW08] - &lt; Server response from [http://localhost:8083/external/public/sampleService/sample/interface]:
&lt; Status: [200], [OK]
&lt; Media type: [text/xml;charset=UTF-8]
&lt; -- Header parameters:
&lt; Content-Type: [text/xml;charset=UTF-8]
&lt; entity: [{"transactionId":"2G7XOSYJ6VUEJJ09","header":{"requestId":"RID314802331803","timestamp":"2019-02-01T15:31:32.432Z","requestVersion":"1.1","headerVersion":"1.0"},"result":{"funcCode":"OK"},"software":{"softwareId":"123456789123456789","softwareName":"string","softwareOperation":"LOCAL_SOFTWARE","softwareMainVersion":"string","softwareDevName":"string","softwareDevContact":"string","softwareCountryCode":"HU","softwareDescription":"string"}]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="common_core_coffee-rest_optimized_BaseRestLogger">2.7.2. Optimized BaseRestLogger</h4>
<div class="paragraph">
<p>This class works similarly as the <a href="#common_core_coffee-rest_BaseRestLogger">BaseRestLogger</a>. The only difference is that it uses less memory, because it doesn&#8217;t copy the streams of the request and response entities for logging, but collects the entities while reading and writing them.</p>
</div>
<div class="paragraph">
<p>It is activated manually at the project level using the following pattern:</p>
</div>
<div class="listingblock">
<div class="title">activate in project</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package hu.icellmobilsoft.project.common.rest.logger;

import javax.inject.Inject;
import javax.ws.rs.ext.Provider;
import hu.icellmobilsoft.coffee.cdi.logger.AppLogger;
import hu.icellmobilsoft.coffee.cdi.logger.ThisLogger;
import hu.icellmobilsoft.coffee.dto.common.LogConstants;
import hu.icellmobilsoft.coffee.rest.log.optimized.BaseRestLogger;

@Provider <i class="conum" data-value="1"></i><b>(1)</b>
public class RestLogger extends BaseRestLogger {

    @Inject
    @ThisLogger
    private AppLogger log;

    @Override
    public String sessionKey() { <i class="conum" data-value="2"></i><b>(2)</b>
        return LogConstants.LOG_SESSION_ID;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JAX-RS activator (this is the thing that activates it)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Session ID key name in HTTP header</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The HTTP request-response log itself is compiled by the <code>hu.icellmobilsoft.coffee.rest.log.optimized.RequestResponseLogger</code> class, with the temprorary <code>@Named("optimized_RequestResponseLogger")</code> annotation. The request and response entity log limits are determined here according to whether the request or response entity is <code>application/octet-stream</code> or <code>multipart/form-data</code> and the REST interface is not annotated with the LogSpecifier then we limit the log size.</p>
</div>
</div>
<div class="sect3">
<h4 id="common_core_coffee-rest_LogSpecifier">2.7.3. LogSpecifier</h4>
<div class="paragraph">
<p>REST logging can be customized per endpoint with the <code>hu.icellmobilsoft.coffee.rest.log.annotation.LogSpecifier</code> annotation,
this can be specified multiple times in one place, and its scope can be limited by the <code>target</code> field,
field, of which more than one can be specified in the annotation (activated by default for all targets);
this gives the possibility to customize REST request-response, microprofile-client request-response separately.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Only one LogSpecifier per endpoint <code>LogSpecifierTarget</code> can be used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Specifiable <code>targets</code> are enum values of <code>hu.icellmobilsoft.coffee.rest.log.annotation.enumeration.LogSpecifierTarget</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">LogSpecifierTarget</th>
<th class="tableblock halign-left valign-top">Scope</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REQUEST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST endpoint request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RESPONSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST endpoint response-a</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CLIENT_REQUEST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microprofile REST Client endpoint request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CLIENT_RESPONSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microprofile REST Client endpoint response-a</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Currently the LogSpecifier is prepared for the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>logging of the request-response on the endpoint can be disabled with the <code>noLog</code> option of the <code>LogSpecifier</code> annotation.</p>
</li>
<li>
<p>on the endpoint, the size of the logged body can be limited by the <code>maxEntityLogSize</code> field of the <code>LogSpecifier</code> annotation.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
if <code>maxEntityLogSize</code> is set to a value <strong>other</strong> than <code>LogSpecifier.NO_LOG</code>, then only the first 5000 characters of the request will be written for the <code>application/octet-stream</code> mediaType received by the REST endpoint.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using the optimized <code>BaseRestLogger</code> class, if the <code>LogSpecifier</code> annotation is not specified, then in the case of <code>application/octet-stream</code> és <code>multipart/form-data</code> mediaTypes, only the first 5000 characters of the request and response entities are logged.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">LogSpecifier example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @POST
    @Produces({ MediaType.APPLICATION_JSON, MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @Consumes({ MediaType.APPLICATION_JSON, MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @LogSpecifier(target={LogSpecifierTarget.REQUEST, LogSpecifierTarget.CLIENT_REQUEST}, maxEntityLogSize = 100) <i class="conum" data-value="1"></i><b>(1)</b>
    @LogSpecifier(target=LogSpecifierTarget.RESPONSE, maxEntityLogSize = 5000) <i class="conum" data-value="2"></i><b>(2)</b>
    @LogSpecifier(target=LogSpecifierTarget.CLIENT_RESPONSE, noLog = true) <i class="conum" data-value="3"></i><b>(3)</b>
    WithoutLogResponse postWithoutLog(WithoutLogRequest withoutLogRequest) throws BaseException;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Request entity log size is limited to 100 bytes, also for REST calls and microprofile client usage</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Response entity log size limited to 5000 characters for REST calls</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disables response logging for microprofile rest client responses.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_logspecifiersannotationprocessor">LogSpecifiersAnnotationProcessor</h5>
<div class="paragraph">
<p>The <code>LogSpecifier</code> is associated with <code>hu.icellmobilsoft.coffee.rest.log.annotation.processing.LogSpecifiersAnnotationProcessor</code>,
whose purpose is to prevent multiple values from being defined for the same <code>target</code> due to the redefinability of <code>LogSpecifier</code>.
To do this, it checks at compile time how many <code>@LogSpecifier</code> have been defined per <code>LogSpecifierTarget</code>, if it finds more than one, it fails the compilation.</p>
</div>
<div class="listingblock">
<div class="title">Invalid example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @POST
    @Produces({ MediaType.APPLICATION_JSON, MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @Consumes({ MediaType.APPLICATION_JSON, MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @LogSpecifier(maxEntityLogSize =  100) <i class="conum" data-value="1"></i><b>(1)</b>
    @LogSpecifier(target = LogSpecifierTarget.RESPONSE, maxEntityLogSize =  5000) <i class="conum" data-value="2"></i><b>(2)</b>
    ValidatorResponse postValidatorTest(ValidatorRequest validatorRequest) throws BaseException;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Since no target is specified, the log size of each entity is limited to 100 bytes/character, including <code>LogSpecifierTarget.RESPONSE</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>LogSpecifierTarget.RESPONSE</strong> limits entity log size to 5000 characters.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since in the above example the size of the REST response should be 100 for the first annotation and 5000 for the second annotation, to avoid hidden logic the <code>LogSpecifiersAnnotationProcessor</code> will fail the translation with the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-log" data-lang="log">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.8.1:compile (default-compile) on project project-sample-service: Compilation failure
[ERROR] .../project-sample-service/src/main/java/hu/icellmobilsoft/project/sample/service/rest/ISampleTestRest.java:[43,23] Multiple LogSpecifiers are defined for the [RESPONSE] of [postValidatorTest]! Conflicting LogSpecifiers:[[@hu.icellmobilsoft.coffee.rest.log.annotation.LogSpecifier(noLog=false, maxEntityLogSize=100, target={REQUEST, RESPONSE, CLIENT_REQUEST, CLIENT_RESPONSE}), @hu. icellmobilsoft.coffee.rest.log.annotation.LogSpecifier(noLog=false, maxEntityLogSize=5000, target={RESPONSE})]]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="common_core_coffee-rest_JaxbTool">2.7.4. JaxbTool</h4>
<div class="paragraph">
<p>The purpose of this class is to summarize the transformations and manipulations related to XML objects.
Its structure is fully modular, you can customize everything to your project&#8217;s needs using the CDI.
Its modules provide this functionality by default:</p>
</div>
<div class="sect4">
<h5 id="_request_version_determination">Request version determination</h5>
<div class="paragraph">
<p>This is provided by the <code>IRequestVersionReader</code> interface.
It implements a built-in and replaceable class <code>hu.icellmobilsoft.coffee.rest.validation.xml.reader.XmlRequestVersionReader</code>.</p>
</div>
<div class="paragraph">
<p>Based on the pattern of the</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text"> ...&lt;header&gt;...&lt;requestVersion&gt;1.1&lt;/requestVersion&gt;...&lt;/header&gt;...</code></pre>
</div>
</div>
<div class="paragraph">
<p>XML structure, of course you are free to modify it to another structure or even read the HTTP header.</p>
</div>
</div>
<div class="sect4">
<h5 id="_xsd_error_collection">XSD error collection</h5>
<div class="paragraph">
<p>In the case of marshal (DTO &#8594; XML String) or unmarshal (XML String/Stream &#8594; DTO), you can request a check according to XSD.
In this case <code>hu.icellmobilsoft.coffee.rest.validation.xml.exception.XsdProcessingException</code>
to get a list of errors that violate XSD rules.
These errors are handled and provided by the <code><strong>IXsdValidationErrorCollector</strong></code> interface.</p>
</div>
<div class="paragraph">
<p>The implementing built-in and replaceable class is <code>hu.icellmobilsoft.coffee.rest.validation.xml.error.XsdValidationErrorCollector</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_xsd_schema_file_handling">XSD (schema) file handling</h5>
<div class="paragraph">
<p>Additional logic is required to handle XSD schema description files, since they can have various bindings.
This problem is addressed by the <code><strong>IXsdResourceResolver</strong></code> interface.</p>
</div>
<div class="paragraph">
<p>The implementor is a built-in and interchangeable class <code>hu.icellmobilsoft.coffee.rest.validation.xml.utils.XsdResourceResolver</code>.
The basic problem that XSDs import each other in a common directory is also a basic problem,
but being able to import XSDs from another project requires extra logic.
In this class this situation is handled.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_xsd_catalog_schema_management">2.7.5. XSD Catalog schema management</h4>
<div class="paragraph">
<p>The description in <a href="#howto_xsd_catalog">XSD Catalog and generation</a> deals with XSD generation.
This section focuses on the activation in the code - XML validation using XSD catalog.</p>
</div>
<div class="paragraph">
<p>The whole function is performed by the <a href="#common_core_coffee-rest_JaxbTool">JaxbTool</a> class.
It is intentionally built in a modular way so that it can be easily adapted to needs.
As described above, Coffee includes an implementation of <code><strong>IXsdResourceResolver</strong></code>,
that can read the schema structure specified in the XSD Catalog.
This class is called</p>
</div>
<div class="listingblock">
<div class="title">hu.icellmobilsoft.coffee.rest.validation.catalog.PublicCatalogResolver</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Alternative
@Priority(100)
public class PublicCatalogResolver implements LSResourceResolver, IXsdResourceResolver {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we use maven-bound dependencies to generate the XSD Catalog, such as:</p>
</div>
<div class="listingblock">
<div class="title">/xxx/super.catalog.xsd</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">...
&lt;public publicId="http://common.dto.coffee.icellmobilsoft.hu/common" uri="maven:hu.icellmobilsoft.coffee.dto.xsd:coffee-dto-xsd:jar::!/xsd/hu.icellmobilsoft.coffee/dto/common/common.xsd"/&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>So you need to be prepared to manage the <code>maven:</code> URI protocol.
This is done in the <code>hu.icellmobilsoft.coffee.tool.protocol.handler.MavenURLHandler</code> class,
which needs to be activated.
This can be done in several ways, the recommended solution is the following:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/services/java.net.spi.URLStreamHandlerProvider</div>
<div class="content">
<pre class="highlight"><code class="language-txt" data-lang="txt">hu.icellmobilsoft.coffee.rest.validation.catalog.MavenURLStreamHandlerProvider</code></pre>
</div>
</div>
<div class="paragraph">
<p>So you need to create the file <code>src/main/resources/META-INF/services/java.net.spi.URLStreamHandlerProvider</code>
and include the class that handles it (Coffee part).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
There may be systems,
which are not able to read this file in time for the application to run.
In such cases, there is another option via <code>URL.setURLStreamHandlerFactory(factory);</code>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_catalog_jaxbtool_activation">Catalog JaxbTool activation</h5>
<div class="paragraph">
<p>After the <code>maven:</code> URI protocol handling setup, there are only 2 things left to do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>activate <code>PublicCatalogResolver</code></p>
</li>
<li>
<p>Specify catalog file</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Activating <code>PublicCatalogResolver</code> is done in the classic CDI way:</p>
</div>
<div class="listingblock">
<div class="title">beans.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://xmlns.jcp.org/xml/ns/javaee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://www.oracle.com/webfolder/technetwork/jsc/xml/ns/javaee/beans_1_1.xsd"
    version="1.1" bean-discovery-mode="all"&gt;

    &lt;alternatives&gt;
        &lt;class&gt;hu.icellmobilsoft.coffee.rest.validation.catalog.PublicCatalogResolver&lt;/class&gt;
    &lt;/alternatives&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the catalog xsd file is specified via the configuration, more specifically the key</p>
</div>
<div class="literalblock">
<div class="content">
<pre>coffee.config.xml.catalog.path</pre>
</div>
</div>
<div class="paragraph">
<p>here is an example:</p>
</div>
<div class="listingblock">
<div class="title">project-defaults.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">coffee:
    config:
        xml:
            catalog:
                path: xsd/hu/icellmobilsoft/project/dto/super.catalog.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that we are ready and the XSD Catalog will do the XSD schema reading.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can add multiple catalog file separated with <code>,</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_json_support">2.7.6. Json support</h4>
<div class="paragraph">
<p>The framework supports JSON format messages in addition to XML for REST communication.
To serialize/deserialize these messages, it uses an external module, <a href="https://projects.eclipse.org/projects/ee4j.yasson">Eclipse Yasson</a>, complements/upgrades with some custom adapters.
Below is an example JSON, and its own added adapters.
The ISO 8601 standard is used for the time-related values, except in one case.
In the case of the <code><code>Date</code></code> class, the format has been changed to the universal UNIX epoch in milliseconds</p>
</div>
<div class="listingblock">
<div class="title">example.json</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "date": 1549898614051,
    "xmlGregorianCalendar": "2019-02-11T15:23:34.051Z",
    }, "bytes": "dGVzdFN0cmluZw==",
    "string": "test1",
    "clazz": "hu.icellmobilsoft.coffee.utils.json.JsonUtilTest",
    "offsetDateTime": "2019-02-11T15:23:34.051Z",
    "offsetTime": "15:23:34.051Z",
    "localDate": "2019-02-11",
    "duration": "P1Y1M1DT1H1M1S"
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. format of serialization of own added adapters for each type</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Java type</th>
<th class="tableblock halign-left valign-top">Format</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return value of the <code>Class.getName()</code>` method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>XMLGregorianCalendar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return value of the <code>XMLGregorianCalendar.toXMLFormat()</code>` method.
By default, <code>`XMLGregorianCalendarImpl</code> is the available descendant for this abstract class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the time since 1970-01-01T00:00:00.000 in milliseconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OffsetDateTime`</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return value of the <code><code>DateTimeFormatter.ISO_OFFSET_DATE_TIME</code></code> method, where offset is specified instead of zone.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OffsetTime`</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return value of the method <code><code>DateTimeFormatter.ISO_OFFSET_TIME</code></code> where offset is specified instead of zone.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return value of the <code>`DateTimeFormatter.ISO_DATE</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return value of <code><code>javax.xml.datatype.Duration.toString()</code></code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code> `</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return value of <code><code>Base64.getName().encodeToString()</code></code>.
Default encoder: RFC4648</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note: Most of the JSON-related operations are of a utility nature and are publicly available under <a href="coffee-tool.adoc">coffee-tool</a> in the <code>JsonUtil</code> class.</p>
</div>
</div>
<div class="sect3">
<h4 id="common_core_coffee-rest_OpenAPIFilter">2.7.7. OpenApiFilter</h4>
<div class="paragraph">
<p>Microprofile OpenApi provides the ability to set additional OpenApi configuration via the implementation of the org.eclipse.microprofile.openapi.OASFilter interface.
The implementation of hu.icellmobilsoft.coffee.rest.filter.OpenAPIFilter contains within the project the generic error codes related to coffee error handling and the corresponding response objects, which are generally applied to all endpoints crossed by the filter, providing more accurate documentation compared to the openapi.yml config file written in microservices using coffee, since this information is dynamically loaded.
To activate this filter in the configuration, you need to specify <code>mp.openapi.filter</code> in the configuration key <code>hu.icellmobilsoft.coffee.rest.filter.OpenAPIFilter</code>, which is the class that implements it.</p>
</div>
<div class="paragraph">
<p>Example in a microprofile default properties config:</p>
</div>
<div class="listingblock">
<div class="title">microprofile-default.properties</div>
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">mp.openapi.filter=hu.icellmobilsoft.coffee.rest.filter.OpenAPIFilter</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_customizability">Customizability</h5>
<div class="paragraph">
<p>The implementation can be further refined by adding a mapping, of which an example is given:</p>
</div>
<div class="listingblock">
<div class="title">CustomerOpenAPIFilter</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package hu.icellmobilsoft.test.rest.filter;

...

@Vetoed
public class CustomerOpenAPIFilter extends OpenAPIFilter {

    private static final String CUSTOM_999_RESPONSE = "#/components/schemas/Custom999Response";

    @Override
    protected Map&lt;Integer, APIResponse&gt; getCommonApiResponseByStatusCodeMap() { <i class="conum" data-value="1"></i><b>(1)</b>
        Map&lt;Integer, APIResponse&gt; apiResponseByStatusCodeMap = super.getCommonApiResponseByStatusCodeMap();
        APIResponse customApiResponse = OASFactory.createAPIResponse() //
                .content(OASFactory.createContent()
                        .addMediaType(MediaType.APPLICATION_JSON,
                                OASFactory.createMediaType().schema(OASFactory.createSchema().ref(CUSTOM_999_RESPONSE)))
                        .addMediaType(MediaType.APPLICATION_XML,
                                OASFactory.createMediaType().schema(OASFactory.createSchema().ref(CUSTOM_999_RESPONSE)))
                        .addMediaType(MediaType.TEXT_XML,
                                OASFactory.createMediaType().schema(OASFactory.createSchema().ref(CUSTOM_999_RESPONSE))))
                .description(Response.Status.BAD_REQUEST.getReasonPhrase() //
                        + "\n" + "* Custom 999 error" //
                        + "\n\t **resultCode** = *OPERATION_FAILED*" //
                );
        apiResponseByStatusCodeMap.put(999,customApiResponse );
        return apiResponseByStatusCodeMap;
    }

    @Override
    protected List&lt;Parameter&gt; getCommonRequestHeaderParameters() { <i class="conum" data-value="2"></i><b>(2)</b>
        Parameter xCustomHeader1 = OASFactory.createObject(Parameter.class).name("X-CUSTOM-HEADER-1").in(Parameter.In.HEADER).required(false)
                .description("Description of custom header 1").schema(OASFactory.createObject(Schema.class).type(Schema.SchemaType.STRING));
        Parameter xCustomHeader2 = OASFactory.createObject(Parameter.class).name("X-CUSTOM-HEADER-2").in(Parameter.In.HEADER).required(false)
                .description("Description of custom header 2").schema(OASFactory.createObject(Schema.class).type(Schema.SchemaType.STRING));
        List&lt;Parameter&gt; headerParams = new ArrayList();
        headerParams.add(xCustomHeader1);
        headerParams.add(xCustomHeader2);
        return headerParams;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Example of adding a custom response with http status code 999. It is important to note that Custom999Response must exist in the DTOs.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Example of specifying 2 custom headers with description schema.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>and so the configuration of the following is added:</p>
</div>
<div class="listingblock">
<div class="title">microprofile-default.properties</div>
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">mp.openapi.filter=hu.icellmobilsoft.test.rest.filter.CustomerOpenAPIFilter</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_messagebodywriter">2.7.8. MessageBodyWriter</h4>
<div class="paragraph">
<p>A module contains <code>application/octet-stream</code> + <code>BaseResultType</code> writert.
This allows the system to send an octet-stream response to any
own DTO BaseResultType object.
This is very useful, for example, when generating a file with an error.</p>
</div>
</div>
<div class="sect3">
<h4 id="_projectstage">2.7.9. ProjectStage</h4>
<div class="paragraph">
<p>The module contains a Deltaspike inspired ProjectStage object which can be injected.
Its role is to be able to specify at runtime, via configuration, whether the project is running in production, development or test mode.</p>
</div>
<div class="paragraph">
<p>It can be used by specifying 2 configurations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>coffee.app.projectStage</p>
</li>
<li>
<p>org.apache.deltaspike.ProjectStage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The values that can be specified are converted to <code>hu.icellmobilsoft.coffee.rest.projectstage.ProjectStageEnum</code>.
Each enum value contains which config value represents which enum.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is important to point out that if no config value is specified, or if no config value is found in the list of one of the enum names, they behave as PRODUCTIONs in ProjectStage!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configurations can be specified from multiple locations using Microprofile Config, but only the first one in the order described above will be considered.</p>
</div>
<div class="paragraph">
<p>Currently, in the project, if the ProjectStage value is not Production, the system will return a broader response for errors.</p>
</div>
<div class="paragraph">
<p>Using this works as follows:</p>
</div>
<div class="listingblock">
<div class="title">MyBean</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Dependent
public class MyBean {
    private @Inject ProjectStage projectStage;

    public void fn() {
        if (projectStage.isProductionStage()) {
            // do some production stuff...
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For possible further breakdowns, use as follows:</p>
</div>
<div class="listingblock">
<div class="title">MyBean</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Dependent
public class MyBean {
    private @Inject ProjectStage projectStage;

    public void fn() {
        if (projectStage.getProjectStageEnum() == ProjectStageEnum.DEVELOPMENT) {
            // do some development stuff...
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_eviction">2.7.10. Eviction</h4>
<div class="paragraph">
<p>By calling EvictAction, the cache content can be cleared. To do this, an EvictAction class must be created in the project (with the appropriate scope) and it should extend the AbstractEvictAction from Coffee. After that, the EvictAction::evict method should be called through a REST endpoint. As a result, the evict method will be invoked on all beans and config sources that implement the Evictable interface.</p>
</div>
<div class="listingblock">
<div class="title">ISystemRest</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ISystemRest {
  ...

  @GET
  @Path(SystemPath.EVICT)
  @Produces(value = { MediaType.APPLICATION_JSON, MediaType.TEXT_XML, MediaType.APPLICATION_XML })
  EvictResponse evict() throws BaseException;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">SystemRest</div>
<p>Use <a href="#common_module_coffee-module-quarkus">AbstractQuarkusSystemRest</a> or
 <a href="#common_module_coffee-module-wildfly">AbstractWildflySystemRest</a> to implement SystemRest on the project.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_core_coffee-grpc">2.8. coffee-grpc</h3>
<div class="paragraph">
<p>The purpose of this module is to support gRPC communication and handling.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>In order for the native <strong>macOS ARM64</strong> build to work, you need to install the native protoc-gen-grpc-java:</p>
<div class="literalblock">
<div class="content">
<pre>brew install protoc-gen-grpc-java[@version]</pre>
</div>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_api">2.8.1. coffee-grpc-api</h4>
<div class="paragraph">
<p>A collector for general gRPC handling of the Coff:ee API (annotations, version, &#8230;&#8203;).</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_base">2.8.2. coffee-grpc-base</h4>
<div class="paragraph">
<p>A collector for general Protobuf and gRPC classes. It includes exception handling, status handling, and other general CDI (Contexts and Dependency Injection) and Coff:ee functionalities.</p>
</div>
<div class="paragraph">
<div class="title">ExceptionMapper and ExceptionHandler</div>
<p>A generic ExceptionMapper interface following the JAX-RS pattern. It allows converting a specific Exception type to a gRPC Status using the capabilities provided by CDI.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_protoc">2.8.3. coffee-grpc-protoc</h4>
<div class="paragraph">
<p>A helper tool used for proto &#8594; class generation. The logic utilizes the <a href="https://mustache.github.io/">Mustache</a> template system, which will be present in the <code>com.salesforce.jprotoc.ProtocPlugin</code> system.</p>
</div>
<div class="paragraph">
<p>Example usage in a pom.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;com.github.os72&lt;/groupId&gt;
                &lt;artifactId&gt;protoc-jar-maven-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
...
                    &lt;outputTargets&gt;
...
                        &lt;outputTarget&gt;
                            &lt;type&gt;grpc-coffee&lt;/type&gt;
                            &lt;pluginArtifact&gt;hu.icellmobilsoft.coffee:coffee-grpc-protoc:${version.hu.icellmobilsoft.coffee}&lt;/pluginArtifact&gt;
                        &lt;/outputTarget&gt;
                    &lt;/outputTargets&gt;
                &lt;/configuration&gt;
...
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A more complex example can be found in the <a href="https://github.com/i-Cell-Mobilsoft-Open-Source/backend-sampler">backend-sampler</a> project&#8217;s <a href="https://github.com/i-Cell-Mobilsoft-Open-Source/backend-sampler/blob/main/api/api-grpc/api-grpc-stub-gen/pom.xml">pom.xml</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_server_extension">2.8.4. coffee-grpc-server-extension</h4>
<div class="paragraph">
<p>Module containing a CDI-compatible implementation of a gRPC server.</p>
</div>
<div class="paragraph">
<p>It reads all classes implementing <code>IGrpcService</code> and delegates them to the gRPC service through the <code>GrpcServerManager</code>.</p>
</div>
<div class="paragraph">
<p>Implemented features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>gRPC server configuration based on <a href="https://github.com/grpc/grpc-java/blob/master/netty/src/main/java/io/grpc/netty/NettyServerBuilder.java">NettyServerBuilder</a></p>
</li>
<li>
<p>MDC (Mapped Diagnostic Context) handling</p>
</li>
<li>
<p>Request/Response log, applicable with <a href="#common_core_coffee-rest_LogSpecifier">LogSpecifier</a>
annotation on GRPC service implementation method/class</p>
</li>
<li>
<p>Exception handling</p>
<div class="ulist">
<ul>
<li>
<p>Grpc status code mapping</p>
<div class="ulist">
<ul>
<li>
<p>General exception: <code>hu.icellmobilsoft.coffee.grpc.server.mapper.GrpcGeneralExceptionMapper</code></p>
</li>
<li>
<p>BaseException exception: <code>hu.icellmobilsoft.coffee.grpc.server.mapper.GrpcBaseExceptionMapper</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Grpc header response additions:</p>
<div class="ulist">
<ul>
<li>
<p>Business error code (<code>com.google.rpc.ErrorInfo</code>)</p>
</li>
<li>
<p>Business error code translation by request locale (<code>com.google.rpc.LocalizedMessage</code>)</p>
</li>
<li>
<p>Debug informations (<code>com.google.rpc.DebugInfo</code>)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_server_thread_pool">Server thread pool</h5>
<div class="paragraph">
<p>The thread handling is an important part of the gRPC server. Two solutions have been implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ThreadPoolExecutor</code> - default thread pool:</p>
<div class="ulist">
<ul>
<li>
<p>Configurable through the <code>coffee.grpc.server.threadpool.default</code> configuration.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ManagedExecutorService</code> - Jakarta EE managed thread pool:</p>
<div class="ulist">
<ul>
<li>
<p>A thread pool managed by the server, with context propagation support.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">gRPC server configuration</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  grpc:
    server:
      port: 8199 # default 8199
      maxConnectionAge: 60000000 # nano seconds, default Long.MAX_VALUE
      maxConnectionAgeGrace: 60000000 # nano seconds, default Long.MAX_VALUE
      maxInboundMessageSize: 4194304 # Bytes, default 4 * 1024 * 1024 (4MiB)
      maxInboundMetadataSize: 8192 # Bytes, default 8192 (8KiB)
      maxConnectionIdle: 60000000 # nano seconds, default Long.MAX_VALUE
      keepAliveTime: 5 # minutes, default 5
      keepAliveTimeout: 20 # seconds, default 20
      permitKeepAliveTime: 5 # minutes, default 5
      permitKeepAliveWithoutCalls: false

 # default false
      threadPool:
        default:
          corePoolSize: 64 # default 32
          maximumPoolSize: 64 # default 32
          keepAliveTime: 60000 # milliseconds, default 0
        jakarta:
          active: true # default false <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>if <code>true</code>, then <code>coffee.grpc.server.threadpool.default</code> is ignored.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case <code>ManagedExecutorService</code> thread pool handling an additional Wildfly configuration is required.</p>
</div>
<div class="listingblock">
<div class="title">Wildfly gRPC managed executor service configuration</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;managed-executor-services&gt;
    &lt;managed-executor-service name="grpc" jndi-name="java:jboss/ee/concurrency/executor/grpc" context-service="default" hung-task-termination-period="0" hung-task-threshold="60000" core-threads="${env.MANAGED_EXECUTOR_SERVICE_GRPC_CORE_THREADS,managed-executor-service.grpc.core-threads:16}" keepalive-time="5000"/&gt;
&lt;/managed-executor-services&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration is provided in the <a href="https://github.com/i-Cell-Mobilsoft-Open-Source/docker-wildfly">docker-wildfly</a> MicroProfile images starting from version 3.1.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The jndi-name must match the one in the example (<code>java:jboss/ee/concurrency/executor/grpc</code>).</p>
</li>
<li>
<p>The minimum number of threads (<code>core-threads</code>) can be parameterized according to the example with the <code>MANAGED_EXECUTOR_SERVICE_GRPC_CORE_THREADS</code> environment parameter or <code>managed-executor-service.grpc.core-threads</code> MicroProfile parameter.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_grpc_client_coffee_grpc_client_extension">2.8.5. gRPC client (coffee-grpc-client-extension)</h4>
<div class="paragraph">
<p>It includes support for implementing a gRPC client.
This includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuration management</p>
</li>
<li>
<p>Request logging</p>
</li>
<li>
<p>Response logging</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">gRPC client configuration</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  grpc:
    client:
      _configKey_:
        host: localhost # default localhost
        port: 8199 # default 8199
        maxInboundMetadataSize: 8192 # Bytes, default 8192 (8KiB)
        requestLogSize: 1000 # Characters, default 1000
        responseLogSize: 1000 # Characters, default 1000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">CDI inject DummyServiceGrpc usage</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
@GrpcClient(configKey = "_configKey_") <i class="conum" data-value="1"></i><b>(1)</b>
private DummyServiceGrpc.DummyServiceBlockingStub dummyGrpcService; <i class="conum" data-value="2"></i><b>(2)</b>

...
// add header
DummyServiceGrpc.DummyServiceBlockingStub stub = GrpcClientHeaderHelper
    .addHeader(dummyGrpcServiceStub, GrpcClientHeaderHelper.headerWithSid(errorLanguage)); <i class="conum" data-value="3"></i><b>(3)</b>

// equivalent with `stub.getDummy(dummyRequest);` + exception handling
DummyResponse helloResponse = GrpcClientWrapper.call(stub::getDummy, dummyRequest); <i class="conum" data-value="4"></i><b>(4)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuration key for connection parameters (e.g., server host and port)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Generated service Stub</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add custom header</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>gRPC service call + exception handling</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_grpc_metrics">2.8.6. gRPC Metrics</h4>
<div class="paragraph">
<p>The gRPC server and client can optionally activate interceptors to provide metric data.
For this, only the inclusion of the Maven dependency is required:</p>
</div>
<div class="listingblock">
<div class="title">enable gRPC server <a href="https://github.com/eclipse/microprofile-metrics">microprofile-metrics</a> implementation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-server-extension&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-metrics-mpmetrics&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">enable gRPC client <a href="https://github.com/eclipse/microprofile-metrics">microprofile-metrics</a> implementation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-client-extension&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-metrics-mpmetrics&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the metric module is not included at the dependency level, the server/client operation remains unchanged, only metric data is not provided.</p>
</div>
<div class="paragraph">
<p>Provided metrics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>gRPC server</p>
<div class="ulist">
<ul>
<li>
<p>Received request counter</p>
</li>
<li>
<p>Responded response counter</p>
</li>
<li>
<p>Request-response processing per second</p>
</li>
</ul>
</div>
</li>
<li>
<p>gRPC Client</p>
<div class="ulist">
<ul>
<li>
<p>Sent request counter</p>
</li>
<li>
<p>Responded response counter</p>
</li>
<li>
<p>Request-response processing per second</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_grpc_tracing">2.8.7. gRPC Tracing</h4>
<div class="paragraph">
<p>The gRPC server and client can optionally activate interceptors to provide tracing data.
For this, only the inclusion of the Maven dependency is required:</p>
</div>
<div class="listingblock">
<div class="title">enable gRPC server <a href="https://github.com/eclipse/microprofile-opentracing">microprofile-opentracing</a> implementation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-server-extension&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-tracing-opentracing&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">enable gRPC server <a href="https://github.com/eclipse/microprofile-telemetry" class="bare">https://github.com/eclipse/microprofile-telemetry</a> implementation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-server-extension&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-tracing-telemetry&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">enable gRPC client <a href="https://github.com/eclipse/microprofile-opentracing">microprofile-opentracing</a> implementation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-client-extension&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-tracing-opentracing&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">enable gRPC client <a href="https://github.com/eclipse/microprofile-telemetry" class="bare">https://github.com/eclipse/microprofile-telemetry</a> implementation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-client-extension&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-grpc-tracing-telemetry&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the tracing module is not included at the dependency level, the server/client operation remains unchanged, only tracing data is not provided.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dtocoffee_dto_xsd2proto">2.8.8. coffee-dto/coffee-dto-xsd2proto</h4>
<div class="paragraph">
<p>A collector of generated schema2proto for general XSD descriptors (<code>coffee-dto-xsd</code> module) and other manually created proto files. This package serves to use Coff:ee proto files, so projects don&#8217;t need to generate them again.</p>
</div>
<div class="paragraph">
<p>Unfortunately, the used schema2proto plugin is not compatible with the Windows operating system, so automatic compilation generation is not set. If there are any changes to the XSD files, the following command needs to be executed on a Linux-compatible system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn clean install -Dschema2proto -Dcopy-generated-sources</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>schema2proto</code> parameter activates XSD &#8594; proto generation, and the <code>copy-generated-sources</code> parameter activates copying the generated proto files into the sources. Afterward, the changes will appear in the git diff.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dtocoffee_dto_stub_gen">2.8.9. coffee-dto/coffee-dto-stub-gen</h4>
<div class="paragraph">
<p>Contains all Coff:ee proto files and their generated classes. The plugin generates an interface descriptor that can be implemented in a full CDI environment. It also generates a BindableService implementation that delegates gRPC calls to the implemented interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_microprofile_health_support_2">2.8.10. microprofile-health support</h4>
<div class="paragraph">
<p>The <strong>GrpcHealth</strong> can check if the gRPC server is reachable.</p>
</div>
<div class="listingblock">
<div class="title">Startup example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class GrpcHealthCheck {

    @Inject
    private GrpcHealth grpcHealth;

    public HealthCheckResponse checkGrpc() {
        try {
            return grpcHealth.check("gRPC");
        } catch (BaseException e) {
            return HealthCheckResponse.builder().name("gRPC").up().build();
        }
    }

    @Produces
    @Startup
    public HealthCheck produceGrpcStartup() {
        return this::checkGrpc;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common_coffee-model">3. Coffee model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A model module can have several submodules containing database tables for a specific purpose.</p>
</div>
<div class="sect2">
<h3 id="_coffee_model_base">3.1. coffee-model-base</h3>
<div class="paragraph">
<p>The purpose of this module is to define the base table structure.</p>
</div>
<div class="paragraph">
<p>Each table must contain common ID, AUDIT and VERSION columns.
It provides ancestor classes, id generator and audit field loader for these.
It includes the inclusion of deltaspike DATA to facilitate the criteria API,
and maven also instantiates SingularAttribute classes on these ancestors.</p>
</div>
<div class="sect3">
<h4 id="_id_generation">3.1.1. ID generation</h4>
<div class="paragraph">
<p>The purpose of ID generation is to work with unique and non-sequential ID values (strings) under all circumstances.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> For generation, we use the <code>EntityIdGenerator.java</code> class, this is used by default with annotation on the entity java class, but if needed it can be called directly with the generate() method. Operationally, the generate method will generate a new ID for the entity if the ID value is not already set (null), otherwise it will use the existing ID.</p>
</div>
<div class="paragraph">
<p>The algorithm will generate an ID of up to 16 lengths [0-9a-zA-Z] using random characters, taking into account the nanosecond part of the current time, e.g. '2ZJMG008YRR4E5NW'</p>
</div>
<div class="paragraph">
<p>Example code for an identifier used on the <code>AbstractIdentifiedEntity.java</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Id
@Column(name = "X__ID", length = 30)
@GenericGenerator(name = "entity-id-generator", strategy = "hu.icellmobilsoft.coffee.model.base.generator.EntityIdGenerator")
@GeneratedValue(generator = "entity-id-generator", strategy = GenerationType.IDENTITY)
private String id;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example code for an Entity where an identifier is required:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity
@Table(name = "SIMPLE_TABLE")
public class SimpleEntity extends AbstractIdentifiedEntity {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have the option to set the timezone through environment variable or system property. If we don&#8217;t set this, we&#8217;ll use the system&#8217;s timezone by default.</p>
</div>
<div class="paragraph">
<p>The variable: <code>COFFEE_MODEL_BASE_JAVA_TIME_TIMEZONE_ID</code></p>
</div>
<div class="listingblock">
<div class="title">Docker container</div>
<div class="content">
<pre>service:
    environment:
        COFFEE_MODEL_BASE_JAVA_TIME_TIMEZONE_ID: Europe/Budapest</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command line</div>
<div class="content">
<pre>java -Dcoffee.model.base.java.time.timezone.id=Europe/Budapest</pre>
</div>
</div>
<div class="listingblock">
<div class="title">java code</div>
<div class="content">
<pre>System.setProperty("coffee.model.base.java.time.timezone.id","Europe/Budapest");</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_audit_columns">3.1.2. Audit columns</h4>
<div class="paragraph">
<p>The audit columns are used to track all table-level movements, e.g. insertion or modification of a new record.
The columns used for this purpose are separated.
Items tracking insertions are stored in columns X__INSDATE and X__INSUSER and the value of these fields is only stored in case of an insert, not in case of an update.
The elements used for modification are stored in columns X__MODDATE and X__MODUSER.
These are predefined in the <code>AbstractAuditEntity.java</code> class and are automatically loaded using the appropriate annotation (e.g. <code>@CreatedOn</code>, <code>@ModifiedOn</code>)</p>
</div>
<div class="paragraph">
<p>Example code for an Entity where audit elements are required:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity
@Table(name = "SIMPLE_TABLE")
public class SimpleEntity extends AbstractAuditEntity {

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_version_column">3.1.3. Version column</h4>
<div class="paragraph">
<p>The version column is a strictly technical element defined in the <code>AbstractEntity.java</code> class. It is used by Hibernate via @Version annotation, ensuring that during a merge operation the entity can remain intact using optimistic lock concurrency control.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is recommended to extend each entity class with the <code>AbstractIdentifiedAuditEntity.java</code> class so that it will already contain the ID, AUDIT and VERSION columns
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity
@Table(name = "SIMPLE_TABLE")
public class SimpleEntity extends AbstractIdentifiedAuditEntity {

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coffee_model_security">3.2. coffee-model-security</h3>
<div class="paragraph">
<p>The purpose of this module is to provide a generic privilege management and collection of related entities.</p>
</div>
<div class="paragraph">
<p>Based on the logic of the different entitlement systems in previous projects, the following have been collected
entity classes of the basic tables. A project is free to use them independently,
therefore there is no relationship between entities, so as not to limit the possible combinations.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common_coffee-modules">4. Coffee modules</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="common_module_coffee-module-activemq">4.1. coffee-module-activemq</h3>
<div class="paragraph">
<p>The purpose of this module is to connect to Apache ActiveMQ.</p>
</div>
<div class="paragraph">
<p>Contains various server classes and methods for JMS management</p>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-csv">4.2. coffee-module-csv</h3>
<div class="paragraph">
<p>Module to generate a CSV file from Java beans using binding annotations,
or parse a CSV file to produce beans.</p>
</div>
<div class="paragraph">
<p>The bean annotation looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class TestBean {

    @CsvBindByNamePosition(position = 0, column = "IDENTIFIER")
    private long id;

    @CsvBindByNamePosition(position = 4)
    private String name;

    @CsvBindByNamePosition(position = 2)
    private boolean active;

    @CsvDate("yyyy-MM-dd")
    @CsvBindByNamePosition(position = 3)
    private LocalDate creationDate;

    @CsvBindByNamePosition(position = 1)
    private status status;

    // getters, setters...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The module provides a <code>@CsvBindByNamePosition</code> annotation to specify the position and name of a CSV column.</p>
</div>
<div class="paragraph">
<p>A list of instances of such a class can be converted to CSV with default csv format use the following call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String csv = CsvUtil.toCsv(beans, TestBean.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of the above call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csv" data-lang="csv">"IDENTIFIER"; "STATUS"; "ACTIVE"; "CREATIONDATE"; "NAME"
"11";"IN_PROGRESS";"true";"2021-11-23";"foo"
"12";"DONE";"false";"2020-01-02";"bar"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to change the csv format use the overloaded methods with config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CsvWriterConfig csvWriterConfig = new CsvWriterConfig.Builder()
                .withQuotechar('\'')
                .withSeparator(',')
                .build();
String csv = CsvUtil.toCsv(beans, TestBean.class, csvWriterConfig);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of the above call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csv" data-lang="csv">'IDENTIFIER','STATUS','ACTIVE','CREATIONDATE','NAME'
'11','IN_PROGRESS','true','2021-11-23','foo'
'12','DONE','false','2020-01-02','bar'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To convert backwards, the following call can be used for default csv format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">List&lt;TestBean&gt; beans = CsvUtil.toBean(csv, TestBean.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To convert backwards, the following call can be used for custom csv format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CSVParserBuilder csvParserBuilder = new CSVParserBuilder()
                .withSeparator(',')
                .withQuoteChar('\'');
List&lt;TestBean&gt; beans = CsvUtil.toBean(csv, TestBean.class, csvParserBuilder);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_disambiguation">4.2.1. Disambiguation</h4>
<div class="paragraph">
<p>The field spacing in which we want to languageize the values must be specified in the
<code>LocalizationConverter</code> , which can be done with annotations starting with <code>@CsvCustomBind</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@CsvCustomBindByNamePosition(position = 0, converter = LocalizationConverter.class)
private status status;

@CsvCustomBindByNamePosition(position = 1, converter = LocalizationConverter.class)
private boolean active;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you also want to localize custom types, or want to localize managed types
If you want to use localization types or change the logic of managed types, you can do so by deriving from <code>LocalizationConverter</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then we need to specify the language for the columns and the values of the fields we want to annotate
(e.g. in the <code>messages_en.properties</code> file):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">java.lang.Boolean.TRUE=Yes
java.lang.Boolean.FALSE=No
hu.icellmobilsoft.coffee.module.csv.LocalizedTestBean.status=Status
hu.icellmobilsoft.coffee.module.csv.LocalizedTestBean.active=Active
hu.icellmobilsoft.coffee.module.csv.LocalizedTestBean$Status.IN_PROGRESS=Progress
hu.icellmobilsoft.coffee.module.csv.LocalizedTestBean$Status.DONE=Done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you need to call the <code>CsvUtil#toLocalizedCsv</code> method with the selected language:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String csv = CsvUtil.toLocalizedCsv(beans, TestBean.class, "en");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code in the examples will result in the following CSV:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csv" data-lang="csv">"Status"; "Active"
"Progress"; "Yes"
"Done"; "No"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-document">4.3. coffee-module-document</h3>
<div class="paragraph">
<p>The purpose of this module is to store and manage template texts. So if you have a SMS, Email,
PDF or other text to be filled with variable parameters in different languages,
this module will handle it.</p>
</div>
<div class="paragraph">
<p>It contains a generic DTO submodule (optional) in which are predefined
the communication objects. The working principle is to input the code of the template,
key-value pairs of parameters to be filled in, it is substituted into the template,
and return it in response. If not all the required parameters are entered, it loads the default values,
which are also stored in the module. The module is also capable of saving files,
but this is of limited use because it saves them to a database.</p>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-etcd">4.4. coffee-module-etcd</h3>
<div class="paragraph">
<p>Module to manage ETCD, implement Microprofile ConfigSource</p>
</div>
<div class="paragraph">
<p>Functioning of the official</p>
</div>
<div class="listingblock">
<div class="title">maven</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.etcd&lt;/groupId&gt;
    &lt;artifactId&gt;jetcd-core&lt;/artifactId&gt;
    &lt;version&gt;0.7.5&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>based driver, extended with enterprise usage model options. More precise description on separate page</p>
</div>
<div class="sect3">
<h4 id="_deploying_configurations_configuring_etcd_host">4.4.1. Deploying configurations, configuring ETCD host</h4>
<div class="paragraph">
<p>To deploy ETCD configurations, the coffee-module-etcd module is pulled in as a dependency.
This will provide the auxiliary classes needed for configuration management,
and contains an <code>EtcdConfig</code> implementation to define it,
that the <code>coffee.etcd.default.url</code> property included in the configuration will be the ETCD&#8217;s reachability.
With the help of the following properties, additional optional configurations are possible for establishing the ETCD connection:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>coffee.etcd.default.connection.timeout.millis</code>: connection timeout in milliseconds</p>
</li>
<li>
<p><code>coffee.etcd.default.retry.delay</code>: retry delay</p>
</li>
<li>
<p><code>coffee.etcd.default.retry.max.delay</code>: maximum retry delay</p>
</li>
<li>
<p><code>coffee.etcd.default.keepalive.time.seconds</code>: keepalive time in seconds</p>
</li>
<li>
<p><code>coffee.etcd.default.keepalive.timeout.seconds</code>: keepalive timeout in seconds</p>
</li>
<li>
<p><code>coffee.etcd.default.keepalive.without.calls</code>: keepalive without calls (true/false)</p>
</li>
<li>
<p><code>coffee.etcd.default.retry.chrono.unit</code>: retry period unit</p>
</li>
<li>
<p><code>coffee.etcd.default.retry.max.duration.seconds</code>: maximum retry duration in seconds</p>
</li>
<li>
<p><code>coffee.etcd.default.wait.for.ready</code>: enable gRPC wait for ready semantics (true/false)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On the backend side, there are several ways to manage configurations.
These typically support and complement each other.</p>
</div>
</div>
<div class="sect3">
<h4 id="_microprofile_config">4.4.2. Microprofile-config</h4>
<div class="paragraph">
<p>The microprofile-config annotation can be used to inject specific configuration values.
In order for microprofile-config to detect ETCD storage,
in our code, we need to activate the <code>coffee-module-etcd</code> in
ConfigSource implementation in the code of your code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.module.etcd.producer.DefaultEtcdConfigSource</code> - default config source</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.etcd.producer.CachedEtcdConfigSource</code> - cached config source.
The cache will remember the retrieved value for 30 minutes,
even if the ETCD does not contain it,
so we can reduce a lot of repetitive queries.
Cache is a thread safe singleton,
it is possible to clear it by calling <code>EtcdConfigSourceCache.instance().clear()</code>.</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.etcd.producer.RuntimeEtcdConfigSource</code> -
Can be activated during runtime as needed (e.g., AfterBeanDiscovery) as follows</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">RuntimeEtcdConfigSource.setActive(true);</code></pre>
</div>
</div>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.etcd.producer.FilteredEtcdConfigSource</code> -
Decides whether to search for the key in ETCD based on configuration regex pattern parameters</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  configSource:
    FilteredEtcdConfigSource:
      pattern:
        include: ^(public|private)\\.
        exclude: ^private\\.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example works with the following logic:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>exclude</code> - is at the beginning of the processing order,
so it will be evaluated before <code>include</code>.
Optional.
If not specified, filtering will not be activated, allowing all keys to pass through.
If the searched key matches the pattern, it will not search in ETCD.</p>
</li>
<li>
<p><code>include</code> - optional.
If not specified, filtering will not be activated, allowing all keys to pass through.
It will search for the key in ETCD only if the searched key matches the pattern.</p>
</li>
<li>
<p>Patterns</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>"private.sample.key1" - it will not search for the key in ETCD because the <code>exclude</code> pattern filters it out.</p>
</li>
<li>
<p>"public.sample.key2" - it will search for the key in ETCD because the <code>exclude</code> pattern allows it and the <code>include</code> pattern matches.</p>
</li>
<li>
<p>"org.sample.key3" - it will not search for the key in ETCD because the <code>exclude</code> pattern allows it but the <code>include</code> pattern filters it out.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example ConfigSource activation:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/services/org.eclipse.microprofile.config.spi.ConfigSource</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">hu.icellmobilsoft.coffee.module.etcd.producer.CachedEtcdConfigSource</code></pre>
</div>
</div>
<div class="paragraph">
<p>The priority of ConfigSources is set to 150.</p>
</div>
<div class="paragraph">
<p>It is possible to inject String, Integer, Boolean, Long, Float and Double configurations. The ETCD always stores String, the parsing to the desired type is done after reading the value. The mechanism uses ConfigEtcdHandler in the background to read the values.
See <a href="#common_core_coffee-configuration">configuration module</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_configetcdhandler_class">4.4.3. ConfigEtcdHandler class</h4>
<div class="paragraph">
<p>Provides a way to read and write ETCD configuration values in a context.
It uses ConfigEtcdService in the background.</p>
</div>
<div class="listingblock">
<div class="title">Write configuration</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
private ConfigEtcdHandler configEtcdHandler;
...
configEtcdHandler.putValue("public.email.sender", "noreply@sample.teszt.hu");</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">query configuration</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
private ConfigEtcdHandler configEtcdHandler;
...
String adminEmail = configEtcdHandler.getValue("public.email.sender");</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_reference_to_another_configuration">Reference to another configuration</h5>
<div class="paragraph">
<p>ConfigEtcdHandler, and thus indirectly ConfigurationHelper and the @ConfigProperty annotation, also allow it,
the value of one config to refer to another config. In this case, { and } characters
to specify the referenced configuration.</p>
</div>
<div class="listingblock">
<div class="title">reference to another configuration</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
private ConfigEtcdHandler configEtcdHandler;
...
configEtcdHandler.putValue("protected.iop.url.main", "http://sample-sandbox.hu/kr_esb_gateway/services/IOPService?wsdl");
configEtcdHandler.putValue("protected.iop.url.alternate", "http://localhost:8178/SampleMockService/IOPService2?wsdl");
configEtcdHandler.putValue("public.iop.url", "{protected.iop.url.main}");
String contactEmail = configEtcdHandler.getValue("public.iop.url"); //A return value "http://sample-sandbox.hu/kr_esb_gateway/services/IOPService?wsdl"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reference must strictly refer to a specific other configuration, no other content is allowed.
For example, the embedded reference will not be resolved (<a href="http://{other.etcd.conf}:8178/SampleMockService/IOPService2?wsdl" class="bare">http://{other.etcd.conf}:8178/SampleMockService/IOPService2?wsdl</a>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configetcdservice_class">4.4.4. ConfigEtcdService class</h4>
<div class="paragraph">
<p>Provides the ability to query, write, list, search for configuration values.
The lowest class of those listed. All of the above mechanisms work through this
implement their functionality. Presumably you will only need to use it if you delete it,
list configurations.</p>
</div>
<div class="listingblock">
<div class="title">Write, query, delete a configuration</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
private ConfigEtcdService configEtcdService;
...
configEtcdService.putValue("protected.iop.url.main", "http://sample-sandbox.hu/kr_esb_gateway/services/IOPService?wsdl"); //write
String senderEmail = configEtcdService.getValue("protected.iop.url.main"); //read
configEtcdService.delete("protected.iop.url.main"); //delete</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">list configurations</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
private ConfigEtcdService configEtcdService;
...
Map&lt;String, String&gt; allConfigMap = configEtcdService.getList(); //list all configuration
Map&lt;String, String&gt; publicConfigMap = configEtcdService.searchList("public."); //list configurations with a given prefix key (cannot be an empty String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When requesting or deleting a non-existent configuration, the service throws a BONotFoundException.
Since this mechanism is used by all listed options, this is true for all of them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_namespaces_configuration_naming_conventions">4.4.5. Namespaces, configuration naming conventions</h4>
<div class="paragraph">
<p>The configuration handler does not support separate namespaces, all information stored in etcd is accessible.</p>
</div>
<div class="paragraph">
<p>Each configuration key starts with a visibility prefix.
They are managed according to the following conventions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Prefix</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>private.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only the configuration available to the backend</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>protected.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accessible for both backend and frontend, frontend read-only configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>public.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A configuration available to both backend and frontend, frontend can change its value</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_configuration_management_using_command_line_tool">4.4.6. Configuration management using Command Line Tool</h4>
<div class="paragraph">
<p>Download and unpack the ETCD package for your system: <a href="https://github.com/coreos/etcd/releases/" class="bare">https://github.com/coreos/etcd/releases/</a></p>
</div>
<div class="paragraph">
<p>Set the ETCDCTL_API environment variable to 3:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-batch" data-lang="batch">#Linux
export ETCDCTL_API=3

#Windows
set ETCDCTL_API=3</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the command line, you can use etcdctl to read and write the values in the ETCD configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-batch" data-lang="batch">#Read the whole configuration
etcdctl --endpoints=%ETCD_ENDPOINTS% get "" --from-key

#Read the value of a given configuration
etcdctl --endpoints=%ETCD_ENDPOINTS% get private.sample

#Write the value of a given configuration
etcdctl --endpoints=%ETCD_ENDPOINTS% put private.sample ertek</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_logging_2">4.4.7. Logging</h4>
<div class="paragraph">
<p>The retrieved keys and the resulting values are logged unless the key matches the regular expression <code>[\w\s]*?secret[\w\s]*?</code> or <code>[\w\s]*?pass[\w\s]*?</code>, in which case the value is masked and logged.
The default regex can be overridden by specifying <code>coffee.config.log.sensitive.key.pattern</code> in one of the <strong>default</strong> microprofile-config sources (sys var, env var, META-INF/microprofile-config.properties), multiple patterns can be specified separated by commas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_microprofile_health_támogatás">4.4.8. microprofile-health támogatás</h4>
<div class="paragraph">
<p>The <strong>EtcdHealth</strong> can check if the etcd server is reachable.</p>
</div>
<div class="listingblock">
<div class="title">Startup example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class EtcdHealthCheck {

    @Inject
    private EtcdHealth etcdHealth;

    public HealthCheckResponse check() {
        try {
            return etcdHealth.checkConnection("etcd");
        } catch (BaseException e) {
            return HealthCheckResponse.builder().name("etcd").up().build();
        }
    }

    @Produces
    @Startup
    public HealthCheck produceEtcdCheck() {
        return this::check;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-localization">4.5. coffee-module-localization</h3>
<div class="sect3">
<h4 id="_localization">4.5.1. Localization</h4>
<div class="paragraph">
<p>Localization functionality in a backend system is useful from several perspectives, for example error codes,
enum translations or even language-agnostic generation of documents.
For this purpose, deltaspike
<a href="http://deltaspike.apache.org/documentation/core.html#Messagesandi18n">Messages and i18n</a>
which is still being enhanced with newer CDI features.</p>
</div>
<div class="paragraph">
<p>It has three components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>language detection (LocaleResolver)</p>
</li>
<li>
<p>language files</p>
</li>
<li>
<p>language localization manager (LocalizedMessage)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_language_localeresolver">Language (LocaleResolver)</h5>
<div class="paragraph">
<p>By default, deltaspike includes a built-in language resolver,
which returns the running JVM locale,
of course this is not appropriate for a system,
so you have to use CDI to create <code>@Alternative</code> like this:</p>
</div>
<div class="listingblock">
<div class="title">ProjectLocaleResolver</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import java.util.Locale;

import javax.annotation.Priority;
import javax.enterprise.context.Dependent;
import javax.enterprise.inject.Alternative;
import javax.inject.Inject;
import javax.interceptor.Interceptor;

import org.apache.commons.lang3.StringUtils;
import org.apache.deltaspike.core.impl.message.DefaultLocaleResolver;

import hu.icellmobilsoft.coffee.cdi.logger.AppLogger;
import hu.icellmobilsoft.coffee.cdi.logger.ThisLogger;
import hu.icellmobilsoft.project.common.rest.header.ProjectHeader;

@Dependent
@Alternative
@Priority(Interceptor.Priority.APPLICATION + 10)
public class ProjectLocaleResolver extends DefaultLocaleResolver {

    private static final long serialVersionUID = 1L;

    public static final String DEFAULT_LANGUAGE = "hu";

    @Inject
    private ProjectHeader header;

    @Inject
    @ThisLogger
    private AppLogger log;

    @Override
    public Locale getLocale() {
        if (header != null) {
            log.debug("header language: [{0}]", header.getLanguage());
            String language = header.getLanguage();
            if (StringUtils.isNotBlank(language)) {
                return new Locale(language);
            }
        }
        return new Locale(DEFAULT_LANGUAGE);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we request the language from a CDI <code>ProjectHeader</code> managed class,
which is loaded from, for example, the REST HTTP header data.</p>
</div>
<div class="paragraph">
<p>Of course, you still need to activate this <code>@Alternative</code> in the <code>beans.xml</code> file.</p>
</div>
</div>
<div class="sect4">
<h5 id="_language_files">Language files</h5>
<div class="paragraph">
<p>The language files work on the normal Java supported renderer,
so the
<a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ResourceBundle.html">ResourceBundle.html</a>
according to.
In short, if there is a dictionary file then the file name + postfix array gives the language resolution.</p>
</div>
<div class="paragraph">
<p>The system supports the ResourceBundle name "<strong>i18n.messages</strong>" by default, example file:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/i18n/messages_hu.properties</div>
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">pattern.date.full = yyyy-MM-dd HH:mm:ss
pattern.date = yyyy-MM-dd
pattern.time = HH:mm:ss
pattern.date.time = yyyy-MM-dd HH:mm

hu.icellmobilsoft.coffee.dto.exception.enums.CoffeeFaultType.GENERIC_EXCEPTION = Nem várt hiba történt!</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the file you can see that it collects content valid for the "hu" locale.</p>
</div>
<div class="paragraph">
<p>The set of dictionary files can be freely extended with the <code><strong>coffee.config.resource.bundles</strong></code> configuration key,
where you can list more/other bundles:</p>
</div>
<div class="listingblock">
<div class="title">project-defaults.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
    config:
        resource:
            bundles: i18n.messages,i18n.validations <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>must be specified without space and quotes</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It can be seen that there are 2 groups of bundles of dictionaries, which can be for example</p>
</div>
<div class="ulist">
<ul>
<li>
<p>src/main/resources/i18n/messages.properties</p>
</li>
<li>
<p>src/main/resources/i18n/messages_en.properties</p>
</li>
<li>
<p>src/main/resources/i18n/messages_hu.properties</p>
</li>
<li>
<p>src/main/resources/i18n/validations.properties</p>
</li>
<li>
<p>src/main/resources/i18n/validations_en.properties</p>
</li>
<li>
<p>src/main/resources/i18n/validations_hu.properties</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_localization_manager_localizedmessage">Localization Manager (LocalizedMessage)</h5>
<div class="paragraph">
<p>The type-safe solution of deltaspike can be fully used,
but it is mostly not suitable for projects,
there you mainly need to answer the localized message based on dynamic keys (e.g. error codes).</p>
</div>
<div class="paragraph">
<p>For this purpose the <code>LocalizedMessage</code> class was created.
It contains a pairwise dictionary resolution for enums and classes, for example,
freely extensible, even modifiable with @Alternative.
Some samples of usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import hu.icellmobilsoft.coffee.module.localization.LocalizedMessage;

...
    @Inject
    private LocalizedMessage localizedMessage;
...
    protected String createDateTimePattern() {
        return StringUtils.defaultString(localizedMessage.message("{pattern.date.full}"), "yyyy.MM.dd HH:mm:ss");
    }

    protected String localizeEnum(Enum&lt;?&gt; enumValue) {
        return localizedMessage.message(enumValue);
    }

    protected String getMessage(String faultType) {
        return localizedMessage.message(GeneralExceptionMapper.class, faultType);
    }
...</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-mongodb">4.6. coffee-module-mongodb</h3>
<div class="paragraph">
<p>The module is designed to support the management of the MongoDB NOSQL database, for which it contains various server classes and methods.
It is based on the CDI extension <a href="http://cdi-spec.org/">cdi-spec</a>.</p>
</div>
<div class="sect3">
<h4 id="_implementation_in_the_project">4.6.1. Implementation in the project</h4>
<div class="sect4">
<h5 id="_pom_xml">pom.xml</h5>
<div class="listingblock">
<div class="title">Coffee module activation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mongodb&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_in_yml">Configuration in yml:</h5>
<div class="listingblock">
<div class="title">project-defaults.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
    mongodb:
        xmlapi: <i class="conum" data-value="1"></i><b>(1)</b>
             database: xmlapi
             uri: mongodb://sample_xmlapi:sample_xmlapi@sample-sandbox.icellmobilsoft.hu:27017/sample_xmlapi?ssl=false
             connectionsPerHost: 150 #default: 100
             minConnectionsPerHost: 1 #default: 1
             connectTimeout: 10000 #default: 10000
             serverSelectionTimeout: 5000 #default: 5000
             socketTimeout: 0 #default: 0
             maxConnectionIdleTime: 20000 #default: 20000
             maxConnectionLifeTime: 20000 #default: 20000
             heartbeatFrequency: 500 #default: 500
             minHeartbeatFrequency: 500 #default: 500
        tada:
            database: tada
            uri: mongodb://sample_tada:sample_tada@sample-sandbox.icellmobilsoft.hu:27017
            connectionsPerHost: 400 #default: 150</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Unique identifier for the mongoDB connection (configKey). Specifying "database" and "uri" is mandatory. All others have default values.
Parameters are described in detail in the MongoConfigHelper class.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can specify parameters for multiple monogDB servers. The uniqueness of configKey defines the database.</p>
</div>
</div>
<div class="sect4">
<h5 id="_usage">Usage</h5>
<div class="sect5">
<h6 id="_mongoclientconfiguration_annotation">@MongoClientConfiguration annotation</h6>
<div class="paragraph">
<p>This annotation allows you to inject a MongoDbClient object. MongoDB can be accessed through this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
@MongoClientConfiguration(configKey = "xmlapi") <i class="conum" data-value="1"></i><b>(1)</b>
private MongoDbClient mongoDbClient;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The configKey value defined in the yml. Unique identifier.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The coff:ee mongoDB module will build the MongoDbClient object based on the values specified in the yml.
The collection to use must be specified separately.
This is the default MongoService implementation which can work with BasicDBObject type.</p>
</div>
<div class="listingblock">
<div class="title">Using Service</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// specify collection
mongoDbClient.initRepositoryCollection("xmlapi_collection");

// use MongoUtils to manage typed objects
String dtoJson = MongoJsonUtil.toJson(dtoDocumentType);
BasicDBObject dtoDocument = MongoUtil.jsonToBasicDbObject(dtoJson);

// insert the element
mongoDbClient.insertOne(dtoDocument);

// get the id of the inserted element
String id = dtoDocument.getString(MongoConstants.COLUMN_MONGO_ID);

// search with filter
BasicDBObject filter = new BasicDBObject();
filter.put(MongoConstants.COLUMN_MONGO_ID, new ObjectId(mongoId));
BasicDBObject result = mongoDbClient.findFirst(filter);

// search by id
BasicDBObject result = mongoDbClient.findById(mongoId);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_mongoserviceconfiguration_annotation">@MongoServiceConfiguration annotation</h6>
<div class="paragraph">
<p>This annotation is exploited by the CDI extension, for all classes that extend the MongoService&lt;T&gt; class, it is automatically generated
an @Producer to allow injection.</p>
</div>
<div class="listingblock">
<div class="title">Using Service</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/**
 * MongoService extension, specifying POJO
 */
@Dependent
public class CustomMongoService extends MongoService&lt;MongoEntity&gt; {
    //no need to overwrite anything
}

/**
 * The extension injects CustomMongoService based on the configKey and collectionKey parameters
 */
@Inject
@MongoServiceConfiguration(configKey = "xmlapi", collectionKey = "xmlapi_collection")
private CustomMongoService customMongoService;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ancestor of CustomMongoService is MongoService&lt;T&gt;, which causes the extension to process and set the generic parameter in the background
object (MongoEntity) that CustomMongoService is working with. The operations in the ancestor can be overridden. The CustomMongoService scope value can also be overridden if the @Dependent would not be correct.
When used from @Stateless EJB, the @Model scope does not work, it is only applicable on Rest interfaces where injected MongoService instances are terminated at the end of the http call.</p>
</div>
<div class="paragraph">
<p>In use, it is not necessary to specify the collection, as this is done in the annotation. Any MongoService can use any collection, no restrictions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// query
MongoEntity entity = customMongoService.findById("mongoId");

// insert
MongoEntity mongoEntity = new MongoEntity();
customMongoService.insertOne(mongoEntity);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-notification">4.7. coffee-module-notification</h3>
<div class="paragraph">
<p>Module for central management of notifications (email, push notification,&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>The module can be tightly coupled with the coffee-module-document module, from which it collects the messages and texts to be sent.
It not only handles the sending, but also stores who sent what, to whom, when and what.
Currently it can handle these notifications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>email</p>
</li>
<li>
<p>push notification</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Includes a generic DTO submodule (optional) with predefined
communication objects.</p>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-redis">4.8. coffee-module-redis</h3>
<div class="paragraph">
<p>The purpose of this module is to manage the online key-value of Redis.</p>
</div>
<div class="paragraph">
<p>The "redis.clients:jedis" java driver based module not only serves queries and saves from Redis, but can also provide a cache management based on the CDI interceptor saved in Redis.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
with the current jedis version 5.1.2, Redis compatibility is backwards to 6.0.x
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_redisconnection">4.8.1. RedisConnection</h4>
<div class="paragraph">
<p>The <code>@RedisConnection</code> qualifier has been introduced.
Using this, there is no need to define/implement Redis configuration, UnifiedJedis, RedisService separately per Redis connection; they are all built and injected via CDI.
Configuration in yaml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
    redis:
        managedExecutorServiceCoreThreadsVariable: MANAGED_EXECUTOR_SERVICE_CORE_THREADS #default <i class="conum" data-value="1"></i><b>(1)</b>
        threadSafetyBuffer: 10 #default <i class="conum" data-value="2"></i><b>(2)</b>
        auth: <i class="conum" data-value="3"></i><b>(3)</b>
            host: sample-sandbox.icellmobilsoft.hu #default: localhost
            port: 6380 #default: 6380
            password: pass1234 #default: null
            database: 1 #default: 0
            pool:
                default: <i class="conum" data-value="4"></i><b>(4)</b>
                    maxtotal: 128 #default: 64
                    maxidle: 32 #default: 16
                custom: <i class="conum" data-value="4"></i><b>(4)</b>
                    maxtotal: 12 #default: 64
                    maxidle: 3 #default: 16
            timeout: 5000 #default: 5000
            cluster: <i class="conum" data-value="5"></i><b>(5)</b>
              - sample-sandbox.icellmobilsoft.hu:6380 #default null</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The variable name of the thread-pool.max-threads to read the appservers thread pool max thread count. Default is MANAGED_EXECUTOR_SERVICE_CORE_THREADS</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Thread safety buffer count which is used for consumer thread count checking. Default is 10</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Unique identifier of the redis connection (configKey). All fields are optional.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Unique identifier of the pool within the redis connection (poolConfigKey). All fields are optional.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>In case of using redis cluster the cluster node urls in <code>$(host):$(port)</code> format. In case of cluster field is required, otherwise it is forbidden.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The value of thread-pool.max-threads must be greater than redis consumer thread count + safety buffer</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the RedisManager associated with the above config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
@RedisConnection(configKey = "auth")
private RedisManager authRedisManager;

@Inject
@RedisConnection(configKey = "auth", poolConfigKey = "custom")
private RedisManager authRedisManagerCustomPool;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first case will use the "default" pool settings,
in the second case, the "custom" pool settings.</p>
</div>
</div>
<div class="sect3">
<h4 id="_redismanager">4.8.2. RedisManager</h4>
<div class="paragraph">
<p>The class <code>RedisManager</code> and its associated <code>RedisManagerProducer</code> are introduced. The producer will produce the RedisManager with the called configKey value, making it available UnifiedJedis when we want to perform some action on redis.
RedisManager&#8217;s job is to federate the use of UnifiedJedis functions, which handles common logging, error handling, connection usage.
The defined methods expect UnifiedJedis functions to be run, this can be done using initConnection() and closeConnection(), or through the runWithConnection methods. This approach allows Redis connections to be used as long as they are needed, saving a lot of resources.</p>
</div>
<div class="paragraph">
<p>Example of using multiple redis operations. This is typically set/get combined with expire. In such a case, no UnifiedJedis instance is requested from the pool unnecessarily and when done, it is closed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
@RedisConnection(configKey = "auth")
private RedisManager redisManager;

try (RedisManagerConnection connection = redisManager.initConnection()) { <i class="conum" data-value="1"></i><b>(1)</b>
    redisManager.run(UnifiedJedis::set, "set", "key", "value");
    redisManager.run(UnifiedJedis::expire, "expire", "key", 300);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize the UnifiedJedis instance on which the operations are performed, use try-with-resource to automatically close it</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Example of performing an operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
@RedisConnection(configKey = "auth")
private RedisManager redisManager;

redisManager.runWithConnection(UnifiedJedis::set, "set", "key", "value"); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Perform operation, framework handles opening and closing connection.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_redis_operations">4.8.3. Redis operations</h4>
<div class="sect4">
<h5 id="_hscan">hscan</h5>
<div class="paragraph">
<p>It iterates through the object in the selected redis db by key. Data may change during the operation, it does not block (this is an advantage over the SMEMBERS operation).
There is no guarantee that all items will be returned, it depends on the size of the objects stored in the redis.
If it exceeds the limit the default COUNT will be 10, it will not return more elements in a request.
It is possible to parameterize the COUNT value if the size limit is exceeded.
For more information about limits: <a href="https://redis.io/commands/scan" class="bare">https://redis.io/commands/scan</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">redisManager.runWithConnection(UnifiedJedis::hscan, "hscan", "key", 10, 100);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_rpush">rpush</h5>
<div class="paragraph">
<p>Packs the value into the list specified as the key
and sets the expiry value of the list in seconds.
In response, the amount of items in the list.
More information: <a href="https://redis.io/commands/rpush" class="bare">https://redis.io/commands/rpush</a> + <a href="https://redis.io/commands/expire" class="bare">https://redis.io/commands/expire</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">redisManager.runWithConnection(UnifiedJedis::rpush, "rpush", "key", "element", 100);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lpoprpop">lpop/rpop</h5>
<div class="paragraph">
<p>(coffee v1.4+)
Given a list of keys, retrieves and returns the first (lpop) or last (rpop) value from the list.
If the list is empty, Redis automatically deletes it.
If we ask for the data from a non-existing list (empty in the meantime and deleted by Redis) the system will return <code>Optional.empty()</code>.
For more information about the limits: <a href="https://redis.io/commands/lpop" class="bare">https://redis.io/commands/lpop</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">redisManager.runWithConnection(UnifiedJedis::lpop, "lpop", "key"); <i class="conum" data-value="1"></i><b>(1)</b>
redisManager.runWithConnection(UnifiedJedis::rpop, "rpop", "key"); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If no value is found then <code>Optional.empty()</code></td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_lmove">lmove</h5>
<div class="paragraph">
<p>Combination of pop+push in one and sets the expiration value of the list in seconds.
In effect, it moves the list item to another list.
If the list does not exist it creates it,
if the source and destination lists are the same,
it can wrap the item from the beginning of the list to the end, or however you want.
In response, the item will be.
For more information: <a href="https://redis.io/commands/lmove" class="bare">https://redis.io/commands/lmove</a> + <a href="https://redis.io/commands/expire" class="bare">https://redis.io/commands/expire</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// from the beginning of the sourceListKey to the end of the destinationListKey
redisManager.runWithConnection(UnifiedJedis::lmove, "lmove", "sourceListKey", "destinationListKey", ListDirection.LEFT, ListDirection.RIGHT);
// from the end to the beginning
redisManager.runWithConnection(UnifiedJedis::lmove, "lmove", "sourceListKey", "sourceListKey", ListDirection.RIGHT, ListDirection.LEFT);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_removevaluefromlist">removeValueFromList</h5>
<div class="paragraph">
<p>Removes all items matching the parameter from the given list.
For more information see: <a href="https://redis.io/commands/lrem" class="bare">https://redis.io/commands/lrem</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">redisManager.runWithConnection(UnifiedJedis::lrem, "removeValueFromList", listKey, 0, "removeValue");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_microprofile_health_support_3">4.8.4. microprofile-health support</h4>
<div class="paragraph">
<p>The <strong>RedisHealth</strong> can check if the Redis server is reachable.</p>
</div>
<div class="listingblock">
<div class="title">Startup example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class RedisHealthCheck {

    @Inject
    private RedisHealth databaseHealth;

    public HealthCheckResponse check(String redisConfig) {
        ManagedRedisConfig managedRedisConfig = ...
        try {
            return redisHealth.checkConnection(managedRedisConfig, "redis");
        } catch (BaseException e) {
            return HealthCheckResponse.builder().name("redis").up().build();
        }
    }

    @Produces
    @Startup
    public HealthCheck produceRedisCheck() {
        return this::check;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="coffee_module_redis-metrics">4.8.5. microprofile-metrics support</h4>
<div class="paragraph">
<p>The <strong>UnifiedJedisProducer</strong> provides metrics about the usage of the pool of UnifiedJedis.</p>
</div>
<div class="listingblock">
<div class="title">metrics example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"># HELP coffee_jedis_pool_active Active connection number
# TYPE coffee_jedis_pool_active gauge
coffee_jedis_pool_active{configKey="redisConfig",poolConfigKey="default"} 10.0
# HELP coffee_jedis_pool_idle Idle connection number
# TYPE coffee_jedis_pool_idle gauge
coffee_jedis_pool_idle{configKey="redisConfig",poolConfigKey="default"} 5.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The metrics can be overridden using the @Alternative or @Specializes annotations.</p>
</div>
<div class="listingblock">
<div class="title">metrics override example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
@Alternative
public class CustomJedisMetricsHandler extends JedisMetricsHandler {
  public void addMetric(String configKey, String poolConfigKey, JedisPool jedisPool) throws BaseException {
  ...
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-redisstream">4.9. coffee-module-redisstream</h3>
<div class="paragraph">
<p>Module designed to support the increasingly popular stream in the personification of Redis.
Redis Stream is a new feature that was added to Redis 5+.
It combines the classic Redis publisher/subscriber functionality with the JMS queue needs,
providing an alternative solution to replace JMS.
The concept description can be found at <a href="https://redis.io/topics/streams-intro">Redis streams-intro</a>,
from which this implementation was derived, with the addition of enterprise requirements.</p>
</div>
<div class="sect3">
<h4 id="_redisconnection_2">4.9.1. RedisConnection</h4>
<div class="paragraph">
<p>The coffee-module-redisstream module uses the <a href="#coffee-module-redis">[coffee-module-redis]</a> module for Redis connection management.
The Redis connection setup is the same as described for <a href="#coffee-module-redis">[coffee-module-redis]</a>,
it is based on the "key" there, only through its own annotation class,
which also allows other stream settings.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
with the current jedis version 4.2.1, Redis compatibility is backwards to 2.8.x
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_message_and_content">4.9.2. Message and content</h4>
<div class="paragraph">
<p>Since the implementation uses the jedis driver,
so there is a restriction on the format in which the
general message frame.
Normally this is an XSD which is part of an API,
but now, due to the specificity of the driver (<code>redis.clients.jedis.StreamEntry</code> object is the carrier), these are just keys.
These keys are called
<code>hu.icellmobilsoft.coffee.module.redisstream.config.IRedisStreamConstant.Common</code>
interface:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><em>message</em></strong> - business content of redis stream message.
This is preferably mostly a <strong>String ID (DB PK)</strong> for some data,
<strong>or</strong> if the need is more complicated, a <strong>JSON</strong> referring to a custom API.
You should aim to keep them to a minimum,
contain "reusable" structures.
Of course, business needs do not always allow this,
but practice tells us that in most cases only one identifier is used.</p>
</li>
<li>
<p><strong><em>ttl</em></strong> - redis stream message expiry time in Long epoch millisec format.
So a timestamp that will tell the consumer when it expires and
then the consumer just ACKs the message without processing the content.</p>
</li>
<li>
<p>hu.icellmobilsoft.coffee.dto.common.LogConstants.LOG_SESSION_ID pointer (<strong>"<em>extSessionId</em>"</strong>) -
The "process identifier" in the system,
which can be linked beyond the rest input and asynch message operations.</p>
<div class="ulist">
<ul>
<li>
<p>Attention must be paid to "uniqueness" when training the value,
especially when 1 process forks into N asynch processes.
This is the case of failower jobs for example,
so the original process identifier must be supplemented with a new unique identifier.
Expect the possibility of several such levels.
This is done by the <code>StreamMessageParameter.FLOW_ID_EXTENSION</code> (<strong>"<em>flowIdExtension</em>"</strong>) variable in the system,
currently only used for redis streams.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When browsing Redis content, this may look like this:</p>
</div>
<div class="listingblock">
<div class="title">sample of simple content:</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "extSessionId": "3OXV5ZUSUAF1KA8G_3OCISPU2RW0NWR7M",
  "flowIdExtension": "3OCISPU2RW0NWR7M",
  "message": "sample-10415900/2022-01/",
  "ttl": "1646381700045"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value of <code>extSessionId</code> here is already seen to be a "composite" process identifier,
where "3OXV5ZUSUAF1KA8G" is the original process ID,
and then appended with "3OCISPU2RW0NWR7M" which is the unique identifier of the asynch.
When browsing the logs, you can then clearly see where the process is split.</p>
</div>
<div class="listingblock">
<div class="title">sample for more complex content:</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "extSessionId": "#TEST-SimpleTest5546-3OW013B5CP8CMH07_3OW013Z1JLNPOP09",
  "message": {
    "blacklisted": false,
    "changeDate": "2022-03-03T01:50:38.035812+01:00",
    "identifier": "3OW01426SX6BP5KW",
    "inputDate": "2022-03-02T23:00:00Z",
    "version": 0
  },
  "ttl": "1646268938291"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>message</code> shown here is a more complex message content,
should belong somewhere in the API (XSD) and JSON format is recommended to use.</p>
</div>
</div>
<div class="sect3">
<h4 id="common_module_coffee-module-redisstream-config">4.9.3. Configuration</h4>
<div class="paragraph">
<p>Configuration is done via the <code>@RedisStreamConsumer</code> and <code>@RedisStreamProducer</code> qualifiers.
Configuration in yaml:</p>
</div>
<div class="listingblock">
<div class="title">yaml config file</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
   redisstream:
       sampleGroup: <i class="conum" data-value="1"></i><b>(1)</b>
           stream:
               read:
                   timeoutmillis: 60000 #default: 60000 <i class="conum" data-value="2"></i><b>(2)</b>
           producer:
               maxlen: 10000 #default none <i class="conum" data-value="3"></i><b>(3)</b>
               ttl: 300000 #millisec, default none <i class="conum" data-value="4"></i><b>(4)</b>
           consumer:
               threadsCount: 2 #default: 1 <i class="conum" data-value="5"></i><b>(5)</b>
               retryCount: 2 #default: 1 <i class="conum" data-value="6"></i><b>(6)</b>
               manualAck: true # default: false <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Unique name of the stream group. All fields are optional.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Stream consumer timeout - how long to wait for the message in 1 iteration.
If no message is received in the stream for this number of ms,
it will close the connection and reopen a new connection in a new iteration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Maximum size of stream messages.
Each time a new message is inserted, it deletes older messages from the stream,
even if they have or have not been processed.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>(Coff:ee 1.6.0+) Stream message expiration time.
On inserting each new message, discard older messages from the stream,
even if they have or have not been processed.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The number of independent threads to start in a given group (sampleGroup) consumer.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>(Coff:ee 1.4.0+) The number of times the given group (sampleGroup) consumer should retry on <code>BaseException</code>.
For other errors not resulting from <code>BaseException</code> this setting is ignored.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If true, an explicit <code>XACK</code> call is required at the end of message processing.
If an exception is thrown during processing, this is omitted and the message can be reprocessed manually.
If false, then an automatic ack occurs already during message processing. Default: <code>false</code>.
See redis <a href="https://redis.io/commands/xreadgroup/">XREADGROUP documentation</a>:</td>
</tr>
</table>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The NOACK subcommand can be used to avoid adding the message to the PEL in cases where reliability is not a requirement
and the occasional message loss is acceptable. This is equivalent to acknowledging the message when it is read.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When specifying <code>&#8230;&#8203;producer.maxlen</code> and <code>&#8230;&#8203;producer.ttl</code> at the same time
the parameter <code>&#8230;&#8203;producer.ttl</code> will not be taken into account!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This includes an EE level setting,
which is needed if the default is not enough to start extra threads (e.g. maximum thread count).
These settings vary by application server, e.g:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Wildfly 21:</p>
<div class="ulist">
<ul>
<li>
<p>use <a href="https://docs.wildfly.org/21/Developer_Guide.html#managed-executor-service" class="bare">https://docs.wildfly.org/21/Developer_Guide.html#managed-executor-service</a></p>
</li>
<li>
<p>configuration <a href="https://docs.wildfly.org/21/Admin_Guide.html#managed-executor-services" class="bare">https://docs.wildfly.org/21/Admin_Guide.html#managed-executor-services</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">MDC</div>
<p>The system logs at MDC level as "retryCounter",
the number of iterations of the retry
(<code>coffee.redisstream.sampleGroup.consumer.retryCount</code> configuration).</p>
</div>
<div class="sect4">
<h5 id="_redisstreamservice">RedisStreamService</h5>
<div class="paragraph">
<p>All Redis stream operations are handled by the
<code>hu.icellmobilsoft.coffee.module.redisstream.service.RedisStreamService</code>
class.
If needed, it can be accessed directly via CDI,
but it is more practical to use the classes created for <em>Producer</em> and <em>Consumer</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_producer">Producer</h5>
<div class="paragraph">
<p>To send messages to a stream, use the
<code>hu.icellmobilsoft.coffee.module.redisstream.publisher.RedisStreamPublisher</code>
class, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
@RedisStreamProducer(configKey = "streamConfigKey", group = "streamGroup") <i class="conum" data-value="1"></i><b>(1)</b>
private RedisStreamPublisher redisStreamPublisher;
...
redisStreamPublisher.publish("message"); <i class="conum" data-value="2"></i><b>(2)</b>
// or
redisStreamPublisher.publish("alternativeGroup", "message");
redisStreamPublisher.publish(List.of("message-1", "message-2"));
redisStreamPublisher.publish("alternativeGroup", List.of("message-1", "message-2"));
redisStreamPublisher.publishPublications(List.of(
        RedisStreamPublication.of("group-1", "message-1"),
        RedisStreamPublication.of("group-2", "message-2")
// parameterization of the message
long expiry = Instant.now().plus(5, ChronoUnit.MINUTES).toEpochMilli();
Map&lt;String, String&gt; map = Map.ofEntries(RedisStreamPublisher.parameterOf(StreamMessageParameter.TTL, expiry));
redisStreamPublisher.publish("message", parameters); <i class="conum" data-value="3"></i><b>(3)</b>

// or
RedisStreamPublication publication = RedisStreamPublication.of(id).withTTL(defaultTTL).withParameter(StreamMessageParameter.FLOW_ID_EXTENSION, id))
redisStreamPublisher.publishPublication(publication); <i class="conum" data-value="4"></i><b>(4)</b>

// In case of many records, it might be a better option to publish messages through pipeline
List&lt;RedisStreamPublication&gt; redisStreamPublicationsPipelined = new ArrayList&lt;&gt;();
for (int i = 0; i &lt; 1000; i++) {
    redisStreamPublicationsPipelined.add(RedisStreamPublication.of("alternativeGroup", "pipelined - " + i, parameters));
}
publisher.publishPublicationsPipelined(redisStreamPublicationsPipelined);
// or
List&lt;String&gt; ids = IntStream.range(0, 1000).mapToObj(i -&gt; RandomUtil.generateId()).toList();
publisher.publishPipelined(ids); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>"group" is not mandatory in all cases</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The "message" content itself will be stored in a kind of coffee stream message structure,
which is the key of <code>IRedisStreamConstant.Common.DATA_KEY_MESSAGE</code>.
The message itself is supplemented with extra information, such as a process identifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is also possible to specify custom project specific parameters.
The options provided by the system are described in <code>hu.icellmobilsoft.coffee.module.redisstream.config.StreamMessageParameter</code>
enum class</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>RedisStreamPublication</code> plays an all-in-one role in the message sending process,
parameters set override the <em>group</em> set in <code>redisStreamPublisher</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Each <code>publish</code> call is made on a separate Jedis connection, so given
In some cases, you may want to collect the messages and pass them as a list.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">RedisStreamPublication</div>
<p>If you need to submit several messages at once, you may want to use the
<code>hu.icellmobilsoft.coffee.module.redisstream.publisher.RedisStreamPublication</code> class,
which is prepared to add its own parameters to each message,
or even send messages to other streams,
than what happens with the <code>RedisStreamPublisher</code> inject.</p>
</div>
<div class="paragraph">
<p>Examples are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StreamMessageParameter.TTL</code> - Message expiry time</p>
</li>
<li>
<p><code>StreamMessageParameter.FLOW_ID_EXTENSION</code> - Role to complement the SID logging
for easier browsing of logs</p>
</li>
<li>
<p>+ other custom settings</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_consumer">Consumer</h5>
<div class="paragraph">
<p>Use SampleConsumer for the above config:</p>
</div>
<div class="listingblock">
<div class="title">IRedisStreamConsumer.class</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package hu.icellmobilsoft.redis.consume;

import javax.enterprise.context.Dependent;
import javax.inject.Inject;

import hu.icellmobilsoft.coffee.dto.exception.BaseException;
import hu.icellmobilsoft.coffee.module.redisstream.annotation.RedisStreamConsumer;
import hu.icellmobilsoft.coffee.module.redisstream.consumer.IRedisStreamConsumer;
import hu.icellmobilsoft.coffee.se.logging.Logger;
import hu.icellmobilsoft.sample.requestScope.Counter;
import hu.icellmobilsoft.sample.dependent.CounterDependent;
import hu.icellmobilsoft.sample.applicationScope.CounterApplication;
import redis.clients.jedis.StreamEntry;

@Dependent
@RedisStreamConsumer(configKey = "redisConfigKey", group = "sampleGroup")
public class SampleConsumer implements IRedisStreamConsumer {

    @Inject
    private Logger log;

    @Inject
    private Counter counter; <i class="conum" data-value="1"></i><b>(1)</b>

    @Inject
    private CounterDependent counterDependent; <i class="conum" data-value="2"></i><b>(2)</b>

    @Inject
    private CounterApplication counterApplication; <i class="conum" data-value="3"></i><b>(3)</b>

    @Override
    public void onStream(StreamEntry streamEntry) throws BaseException {
        log.info("Processing streamEntry [{0}]", streamEntry);
        counter.print();
        counterDependent.print();
        counterApplication.print();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Counter class works in RequestScope</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The CounterDependent class works as Dependent</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The CounterApplication class operates in ApplicationScope</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">IRedisStreamPipeConsumer.class</div>
<p>There is a more complex <code>IRedisStreamPipeConsumer</code>,
which is designed to allow extended stream consumption.
Compared to the <code>IRedisStreamConsumer</code> there are so many changes,
the return value of <code>Map&lt;String, Object&gt; onStream(StreamEntry streamEntry)</code> is
is the input of <code>void afterAck(StreamEntry streamEntry, Map&lt;String, Object&gt; onStreamResult)</code>.
The two functions run completely separate in their own requestScope.</p>
</div>
<div class="paragraph">
<p>In an EE environment, it is necessary to add other logic to the consumer,
such as the process identifier, unique metadata,
therefore it is recommended to use the
<code>hu.icellmobilsoft.coffee.module.redisstream.consumer.AbstractStreamConsumer</code>
which will prepare the implementing consumer.
This logic is used to send messages to the
<code>hu.icellmobilsoft.coffee.module.redisstream.publisher.RedisStreamPublisher</code>
class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import javax.enterprise.inject.Model;
import javax.inject.Inject;

import hu.icellmobilsoft.coffee.dto.exception.BaseException;
import hu.icellmobilsoft.coffee.module.redisstream.annotation.RedisStreamConsumer;
import hu.icellmobilsoft.coffee.module.redisstream.consumer.AbstractStreamConsumer;

@Model
@RedisStreamConsumer(configKey = "redisConfigKey", group = "redisGroup")
public class SampleConsumer extends AbstractStreamConsumer {

    @Inject
    private Provider&lt;Sample&gt; sample;

    @Override
    public void doWork(String text) throws BaseException { <i class="conum" data-value="1"></i><b>(1)</b>
        sample.process(text);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The content can be string or json,
which from <em>StreamEntry</em> is the value of the key RedisStreamConstant.Common#DATA_KEY_MAIN</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_how_does_it_work">How does it work?</h6>
<div class="paragraph">
<p>At application startup, for example (there are several options), it looks for the CDI <code>@Observes @Initialized(ApplicationScoped.class)</code> event
all classes that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.module.redisstream.consumer.IRedisStreamConsumer</code>
interface</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.redisstream.annotation.RedisStreamConsumer</code>
annotated with</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From the annotation of the classes found, the redis connection key and the stream group name are known,
from which the name of the stream key and the settings are added.
It iterates through the classes and creates as many instances as each one is configured to create,
which it runs in separate threads using <code>hu.icellmobilsoft.coffee.module.redisstream.consumer.RedisStreamConsumerExecutor</code>.</p>
</div>
<div class="paragraph">
<p>In an infinite loop in each thread, the algorithm queries Redis for messages.
First it checks if there is a specified group and stream, if not it creates one.
In subsequent rounds it does not check this.
If a message is received, it creates an automatically handled RequestScope to execute the business:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>so that our usual RequestScope logic can be used to process the message</p>
</li>
<li>
<p>each message is actually a real request, except that it does not come in REST</p>
</li>
<li>
<p>this logic also follows the JMS scope handling</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After successful message processing, it closes the RequestScope and issues the ACK command.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_starter">Starter</h5>
<div class="paragraph">
<p>There are several ways to start a consumer,
CDI event, CDI extension, manual/delayed start, etc&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>For these, a
<code>hu.icellmobilsoft.coffee.module.redisstream.bootstrap.BaseRedisConsumerStarter</code>
class and a
<code>hu.icellmobilsoft.coffee.module.redisstream.bootstrap.ConsumerStarterExtension</code>
CDI extension pattern (this can be a problem for example for JNDI bindings used in consumers)</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
coffee does not start consumers by itself, this has to be done by everyone in the project based on their own needs.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_non_acked_messages">4.9.4. Non-ACKed messages</h4>
<div class="paragraph">
<p>This implementation does not deal with retrieved but not ACKed messages.
These need to be handled locally on a case by case basis as to what to do with them.
The <code>hu.icellmobilsoft.coffee.module.redisstream.service.RedisStreamService</code> class
contains query and handling methods for this purpose,
which can be used in the stuck business process.</p>
</div>
</div>
<div class="sect3">
<h4 id="_graceful_shutdown_support">4.9.5. Graceful shutdown support</h4>
<div class="paragraph">
<p>The Redis consumers got stuck during service shutdown and stalled during processing. To support graceful shutdown, the hu.icellmobilsoft.coffee.module.redisstream.bootstrap.ConsumerLifeCycleManager class was created, which waits for the consumers to complete their ongoing operations.</p>
</div>
<div class="paragraph">
<p>By default, it is enabled, but it can be disabled in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import jakarta.enterprise.context.ApplicationScoped;
import jakarta.enterprise.context.BeforeDestroyed;
import jakarta.enterprise.event.Observes;
import jakarta.enterprise.inject.Specializes;

import hu.icellmobilsoft.coffee.module.redisstream.bootstrap.ConsumerLifeCycleManager;

@ApplicationScoped
@Specializes
public class ProjectConsumerLifeCycleManager extends ConsumerLifeCycleManager {
    public void stop(@Observes @BeforeDestroyed(ApplicationScoped.class) Object init) {
        //
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_metric_information">4.9.6. Metric information</h4>
<div class="paragraph">
<p>The <code>BaseRedisConsumerStarter</code> class sends event(s) about the number of threads associated with the stream group name, which can be used to create metrics in the project.</p>
</div>
<div class="listingblock">
<div class="title">example metric registration with MP metrics</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject private MetricsRegistry metricyRegistry;

private void onEventRegisterRedisStreamMetrics(@ObservesAsync RedisStreamMetricEventMessage message) {
    metricRegistry.gauge(
            Metadata.builder()
                    .withName("redis_stream_consumer_max")
                    .withDescription("Maximum number of redis stream counters")
                    .withType(MetricType.GAUGE)
                    .build(),
            () -&gt; message.getCount(),
            new Tag("group", message.getGroup()));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-redispubsub">4.10. coffee-module-redispubsub</h3>
<div class="paragraph">
<p>Module is designed to implement "topic" messaging using the <a href="https://redis.io/docs/manual/pubsub/">Redis Pub/Sub</a> function
on the basis of <a href="https://download.eclipse.org/microprofile/microprofile-reactive-messaging-2.0.1/microprofile-reactive-messaging-spec-2.0.1.html">microprofile-reactive-messaging</a>.</p>
</div>
<div class="sect3">
<h4 id="_redis_pubsub">4.10.1. Redis Pub/Sub</h4>
<div class="paragraph">
<p>The Pub/Sub function implements classic publisher-subscriber messaging. Publishers send a message
to a given Redis pub/sub channel, which is received by all subscribers who have just subscribed.
Unlike Redis streams, messages are not even stored in-memory on the channel,
if a subscriber subscribes to the channel afterwards, he will not receive the previous messages, and therefore the subscription will not be
by repeated requests (e.g. <code>XREAD</code>), but on a reserved grpc connection.</p>
</div>
</div>
<div class="sect3">
<h4 id="_redisconnection_3">4.10.2. RedisConnection</h4>
<div class="paragraph">
<p>The coffee-module-redispubsub module uses the <a href="#coffee-module-redis">[coffee-module-redis]</a> module to handle Redis connection.
The Redis connection setup is the same as described in <a href="#coffee-module-redis">[coffee-module-redis]</a>,
it is based on the "key" there.</p>
</div>
</div>
<div class="sect3">
<h4 id="_microprofile_reactive_messaging">4.10.3. Microprofile-reactive-messaging</h4>
<div class="paragraph">
<p>The module integrates the Pub/Sub solution using the microprofile reactive messaging API,
thus configuration and message sending/receiving is done according to the specification
(therefore, with minimal code modification, the module can be used as a replacement for existing connectors (e.g. Kafka, MQTT, Google Pub/Sub&#8230;&#8203;)).
Integration is done via the <code>PubSubConnector</code> class, which is used to register subscribers,
and is used to send messages</p>
</div>
<div class="sect4">
<h5 id="_wildfly_configuration">Wildfly configuration</h5>
<div class="paragraph">
<p>To use this module, you need to activate <code>microprofile-reactive-streams-operators-smallrye</code> under wildfly,
<code>microprofile-reactive-messaging-smallrye</code> subsystems:</p>
</div>
<div class="listingblock">
<div class="title">jboss-cli.sh</div>
<div class="content">
<pre class="highlight"><code>/extension=org.wildfly.extension.microprofile.reactive-messaging-smallrye:add
/extension=org.wildfly.extension.microprofile.reactive-streams-operators-smallrye:add
/subsystem=microprofile-reactive-streams-operators-smallrye:add
/subsystem=microprofile-reactive-messaging-smallrye:add</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_subscriberconsumer_creation">4.10.4. Subscriber(consumer) creation</h4>
<div class="paragraph">
<p>Subscriber creation is done with the configurations and annotations defined by microprofile-reactive-messaging.</p>
</div>
<div class="listingblock">
<div class="title">mp reactive incoming config</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  redis:
    pubsubredis: <i class="conum" data-value="1"></i><b>(1)</b>
    #...
      pool:
        pubsubpool:
        #...

mp:
  messaging:
    incoming:
      test-in: <i class="conum" data-value="2"></i><b>(2)</b>
        connector: coffee-redis-pubsub <i class="conum" data-value="3"></i><b>(3)</b>
        connection-key: pubsubredis <i class="conum" data-value="4"></i><b>(4)</b>
        pool-key: pubsubpool <i class="conum" data-value="5"></i><b>(5)</b>
        pub-sub-channel: channel1 <i class="conum" data-value="6"></i><b>(6)</b>
        retry-seconds: 60 <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Redis connection and pool settings to use</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Incoming mp channel key, in code you can refer to it to process the message.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The channel uses the module connector, fixed to <code>coffee-redis-pubsub</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Coffee redis module connection key coffee.redis.*, required parameter</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Coffee redis pool key coffee.redis.*.pool.*, optional, default value <code>default</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Optional parameter, redis Pub/Sub channel name,
if not specified, the incoming mp channel key (key &lt;1&gt; - <code>test-in</code>) is taken as redis channel by default,
for a more detailed description of when it might be necessary to specify this parameter: <a href="#common_module_coffee-module-redispubsub_same_channel_pub_sub">Same channel publisher and subscriber within a service</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Optional parameter, in case of subscribe failure, how many seconds to wait before retrying, default 30s</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">subscriber method</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class TestListener {


    @Incoming("test-in") <i class="conum" data-value="2"></i><b>(2)</b>
    void consume(String test) {
        //logic
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>microprofile-reactive-messaging only allows <code>Dependent</code> or <code>ApplicationScoped</code> beans for consumer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>work with the mp channel key specified in the config</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_publisher_creation">4.10.5. Publisher creation</h4>
<div class="paragraph">
<p>Publisher creation is also done with the configurations and annotations defined by microprofile-reactive-messaging.</p>
</div>
<div class="listingblock">
<div class="title">mp reactive outgoing config</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  redis:
    pubsubredis: <i class="conum" data-value="1"></i><b>(1)</b>
    #...
      pool:
        pubsubpool:
        #...


mp:
  messaging:
    outgoing:
      test-out: <i class="conum" data-value="2"></i><b>(2)</b>
        connector: coffee-redis-pubsub <i class="conum" data-value="3"></i><b>(3)</b>
        connection-key: pubsubredis <i class="conum" data-value="4"></i><b>(4)</b>
        pool-key: pubsubpool <i class="conum" data-value="5"></i><b>(5)</b>
        pub-sub-channel: channel1 <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The redis connection and pool settings to use</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Outgoing mp channel key, in code you can refer to it to process the message.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The channel uses the module connector, fixed to <code>coffee-redis-pubsub</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Coffee redis module connection key coffee.redis.*, mandatory parameter</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Coffee redis module pool key coffee.redis.*.pool.*, optional, default value <code>default</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Optional parameter, redis Pub/Sub channel name,
if not specified, then by default the outgoing mp channel key (key &lt;1&gt; - <code>test-out</code>) is taken as redis channel,
for a more detailed description of when it might be necessary to specify this parameter: <a href="#common_module_coffee-module-redispubsub_same_channel_pub_sub">Same channel publisher and subscriber within a service</a>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">publishing method</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Model
public class TestAction {


    @Inject
    @Channel("test-out") <i class="conum" data-value="1"></i><b>(1)</b>
    private Emitter&lt;String&gt; emitter;


    void sendMessage(String test) {
        //logic
        emitter.send(test); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>work with the mp channel key specified in the config</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>send message, returning with completionStage.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_message">4.10.6. Message</h4>
<div class="paragraph">
<p>The module wraps all messages in a <code>PubSubMessage</code> object, this contains the sender SID, which is read by the consumer and set in MDC.
The class implements <code>org.eclipse.microprofile.reactive.messaging.Message</code> so that the consumer method parameter
as described in the documentation
<a href="https://download.eclipse.org/microprofile/microprofile-reactive-messaging-2.0.1/microprofile-reactive-messaging-spec-2.0.1.html#_methods_consuming_data">Methods consuming data</a>.</p>
</div>
<div class="listingblock">
<div class="title">message example</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "context": {
        "extSessionId": "3VUTBZCQOIHUAM07"
    },
    "payload": "test0"
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_setoverride_sid_in_message">set/override SID in message</h5>
<div class="paragraph">
<p>If you want to manually set the SID of the message, you have to send <code>PubSubMessage</code> to the emitter instead of payload.</p>
</div>
<div class="listingblock">
<div class="title">example for own sid</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Model
public class TestAction {

    @Inject
    @Channel("test")
    private Emitter&lt;PubSubMessage&gt; emitter;

    void sendMessage() {
        //logic
        emitter.send(PubSubMessage.of("test", Map.of(LogConstants.LOG_SESSION_ID, "customSID")));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mp_reactive_messaging_own_shares">4.10.7. mp-reactive-messaging own shares</h4>
<div class="sect4">
<h5 id="common_module_coffee-module-redispubsub_same_channel_pub_sub">Same channel publisher and subscriber within a service</h5>
<div class="paragraph">
<p>Within a microservice, microprofile-reactive-messaging does not allow to create both publisher and subscriber
for the same key, but if such a need should arise, it can be separated using the <code>pub-sub-channel</code> attribute
the name of the microprofile channel within the service and the name of the associated redis pub/sub channel, example: <a href="#common_module_coffee-module-redispubsub_same_pub_sub">Subscriber and producer on same service</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_multiple_producers_on_the_same_channel">Using multiple producers on the same channel</h5>
<div class="paragraph">
<p>By default, a message can be sent to a channel from a single location within the service,
if you want to have multiple beans, you can do so by activating the <code>mp.messaging.outgoing.test-out.merge=true</code> config.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_key_constraints">Configuration key constraints</h5>
<div class="paragraph">
<p>If the microprofile-reactive-messaging subtype is activated and there is any <code>mp.messaging.*</code> in mp-config then
there must be a corresponding subscriber or producer in the deployment! This can cause problems with shared config files.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_examples">4.10.8. Examples</h4>
<div class="sect4">
<h5 id="common_module_coffee-module-redispubsub_seperated_pub_sub">Subscriber and producer on separate service</h5>
<div class="imageblock">
<div class="content">
<img src="pic/seperated_pub_sub.drawio.svg" alt="seperated pub sub.drawio">
</div>
</div>
<div class="sect5">
<h6 id="_publisher">Publisher</h6>
<div class="listingblock">
<div class="title">publisher config</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  redis:
    sample: <i class="conum" data-value="1"></i><b>(1)</b>
      database: 0
      host: bs-sample-redis
      port: 6379
mp:
  messaging:
    outgoing:
      test: <i class="conum" data-value="2"></i><b>(2)</b>
        connector: coffee-redis-pubsub
        connection-key: sample <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>redis connection setup</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>emitter key</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">publishing method</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Model
public class TestAction {

    @Inject
    @Channel("test") <i class="conum" data-value="1"></i><b>(1)</b>
    private Emitter&lt;String&gt; emitter;

    void sendMessage() {
        //logic
        emitter.send("test123");
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>mp.messaging.outgoing</code> key</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_subscriber">Subscriber</h6>
<div class="listingblock">
<div class="title">config</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  redis:
    sample: <i class="conum" data-value="1"></i><b>(1)</b>
      database: 0
      host: bs-sample-redis
      port: 6379
mp:
  messaging:
    incoming:
      test: <i class="conum" data-value="2"></i><b>(2)</b>
        connector: coffee-redis-pubsub
        connection-key: sample <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>redis connection setup</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>subscriber key</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">subscriber method</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class TestListener {

    @Incoming("test") <i class="conum" data-value="1"></i><b>(1)</b>
    void consume(String test) {
        //logic
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>mp.messaging.incoming</code> key</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="common_module_coffee-module-redispubsub_same_pub_sub">Subscriber and producer on same service</h5>
<div class="imageblock">
<div class="content">
<img src="pic/same_pub_sub.drawio.svg" alt="same pub sub.drawio">
</div>
</div>
<div class="listingblock">
<div class="title">config</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
  redis:
    sample: <i class="conum" data-value="1"></i><b>(1)</b>
      database: 0
      host: bs-sample-redis
      port: 6379
mp:
  messaging:
    incoming:
      test-in: <i class="conum" data-value="2"></i><b>(2)</b>
        connector: coffee-redis-pubsub
        connection-key: sample <i class="conum" data-value="1"></i><b>(1)</b>
        pub-sub-channel: test <i class="conum" data-value="4"></i><b>(4)</b>
    outgoing:
      test-out: <i class="conum" data-value="3"></i><b>(3)</b>
        connector: coffee-redis-pubsub
        connection-key: sample <i class="conum" data-value="1"></i><b>(1)</b>
        pub-sub-channel: test <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>redis connection setup</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>subscriber key</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>emitter key</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>redis channel name</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">publishing method</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Model
public class TestAction {

    @Inject
    @Channel("test-out") <i class="conum" data-value="1"></i><b>(1)</b>
    private Emitter&lt;String&gt; emitter;

    void sendMessage() {
        //logic
        emitter.send("test");
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>mp.messaging.outgoing</code> key</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">subscriber method</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class TestListener {

    @Incoming("test-in") <i class="conum" data-value="1"></i><b>(1)</b>
    void consume(String test) {
        //logic
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>mp.messaging.incoming</code> key</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_shortcomings_possibilities_for_further_development">4.10.9. Shortcomings, possibilities for further development</h4>
<div class="ulist">
<ul>
<li>
<p>Multi-threaded async processing</p>
<div class="paragraph">
<p>Since all subscribers receive the message, it makes sense to subscribe one thread per redis channel,
currently the logic after message arrival is also implemented on a single thread (similar to the JMS topic mdb&#8217;s). Consumer side
multi-threading can be solved, for this you could have Util/Helper class (e.g. for MDC setup, number of threads etc&#8230;&#8203;)</p>
</div>
<div class="listingblock">
<div class="title">multi-threaded processing</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class TestListener {

    @Resource(name = "java:jboss/ee/concurrency/executor/default")
    private ExecutorService executorService;

    @Incoming("test")
    CompletionStage&lt;Void&gt; consume(Message&lt;String&gt; test){
        return CompletableFuture.runAsync(() -&gt; {
            //logic
        }, executorService);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Support for Redis Pub/Sub <code>PSUBSCRIBE</code> operation, allowing to subscribe to patterns, e.g. with <code>PSUBSCRIBE ch*</code>
the subscribing client will also receive messages sent to <code>ch1</code>,<code>ch2</code>,<code>cha</code> channels.</p>
</li>
<li>
<p>Project level override possibility e.g. with service loader mechanism</p>
</li>
<li>
<p>Tracing how to</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-ruleng">4.11. coffee-module-ruleng</h3>
<div class="paragraph">
<p>The purpose of this module is to support a universal rule system evaluation.</p>
</div>
<div class="paragraph">
<p>There is a growing need to perform multiple evaluations on a single data set,
the results of which determine the output of the overall processing. Example use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>submitted invoice processing</p>
<div class="ulist">
<ul>
<li>
<p>invoice header checks (simple data, external dependency)</p>
</li>
<li>
<p>invoice item checks (scroll through list)</p>
</li>
<li>
<p>invoice summary checks (calculated data)</p>
</li>
<li>
<p>special checks (combination of the above)</p>
</li>
</ul>
</div>
</li>
<li>
<p>rent, discount checks</p>
<div class="ulist">
<ul>
<li>
<p>real owner, maturity, issuer (external dependency)</p>
</li>
<li>
<p>discount rate, eligibility for use (calculated data)</p>
</li>
</ul>
</div>
</li>
<li>
<p>loan application</p>
<div class="ulist">
<ul>
<li>
<p>check application data</p>
</li>
<li>
<p>reviews</p>
</li>
</ul>
</div>
</li>
<li>
<p>many other use cases</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_principles">4.11.1. Principles</h4>
<div class="paragraph">
<p>It works entirely on the basis of CDI, focusing on the following needs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>modularizable according to CDI principles, almost all framework operations can be individually modified</p>
</li>
<li>
<p>1 rule 1 independent class</p>
</li>
<li>
<p>the internal logic of the rule follows the KISS (keep is simple, stupid) principle</p>
</li>
<li>
<p>traditional unlimited EE logic can be used</p>
</li>
<li>
<p>the rule evaluation must be fault-tolerant, null-safe, only focusing on its own data,
not interested in evaluating another rule</p>
</li>
<li>
<p>possibility to sort and group rules (parallel evaluation)</p>
</li>
<li>
<p>possibility to interrupt the processing in the queue while the processing of the other group is independent</p>
</li>
<li>
<p>evaluation result can be positive or negative, logic does not matter how it is used</p>
</li>
<li>
<p>disable/enable rule according to versioned data</p>
</li>
<li>
<p>all rules must end with the same class type</p>
</li>
<li>
<p>multiple evaluations are possible within 1 rule (to be avoided, but sometimes required)</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_rule">4.11.2. Rule</h4>
<div class="paragraph">
<p>Many types of rule evaluation are possible, starting from the following pattern</p>
</div>
<div class="listingblock">
<div class="title">Sample Rule</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import javax.enterprise.inject.Model;
import javax.inject.Inject;

import hu.icellmobilsoft.coffee.cdi.annotation.Range;
import hu.icellmobilsoft.coffee.cdi.annotation.Version;
import hu.icellmobilsoft.coffee.dto.exception.BaseException;
import hu.icellmobilsoft.coffee.dto.exception.TechnicalException;
import hu.icellmobilsoft.coffee.dto.exception.enums.CoffeeFaultType;
import hu.icellmobilsoft.coffee.module.ruleng.rule.IRule;
import hu.icellmobilsoft.project.enums.ValidatorFaultType;
import hu.icellmobilsoft.project.rule.RuleException;
import hu.icellmobilsoft.project.rule.CustomRuleResult;
import hu.icellmobilsoft.project.rule.DataHelper;
import hu.icellmobilsoft.project.annotation.Ac;
import hu.icellmobilsoft.project.schemas.data.LineType;

@Model
@Version(include = @Range(from = "1.1")) // Optional <i class="conum" data-value="1"></i><b>(1)</b>
@Ac // Rule category <i class="conum" data-value="2"></i><b>(2)</b>
public class AcExampleRule implements
    IRule&lt;LineType, CustomRuleResult&gt;, <i class="conum" data-value="3"></i><b>(3)</b>
    IRuleSelector { // Optional <i class="conum" data-value="4"></i><b>(4)</b>

    @Inject
    private DataHelper dataHelper; <i class="conum" data-value="5"></i><b>(5)</b>

    @Override
    public CustomRuleResult apply(LineType input) throws RuleException, BaseException { <i class="conum" data-value="6"></i><b>(6)</b>
        if (input == null) {
            throw new TechnicalException(CoffeeFaultType.WRONG_OR_MISSING_PARAMETERS, "input is null");
        }

        if (input.getSub() != null &amp;&amp; !input.getSub().getData() ! = null <i class="conum" data-value="7"></i><b>(7)</b>
            &amp;&amp; input.getSub().getData().compareTo(dataHelper.getValue()) == 0) {
            return new CustomRuleResult(ValidatorFaultType.INVALID_SUB_DATA);
        }
        return null; <i class="conum" data-value="8"></i><b>(8)</b>
    }

    @Override
    public int order() { <i class="conum" data-value="9"></i><b>(9)</b>
        return 0;
    }

    @Override
    public Enum&lt;?&gt; group() { <i class="conum" data-value="10"></i><b>(10)</b>
        return RuleGroup.NONE;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Rule activation by data version - NOT REQUIRED</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Rule category. This is an annotation of type @Qualifier</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>IRule&lt;InputType, CustomRuleResult&gt; - input data type and output</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Rule grouping and ordering options - NOT REQUIRED</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This is how to input the precalculated data to be used by the rule for evaluation</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>RuleException - thrown when an interrupt is needed in the rule evaluation</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>null-safe checks</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Can return a positive workaround if required</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Rule order, 0 by default</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Rule group, by default NONE</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">How it works:</div>
<ul>
<li>
<p>AcExampleRule will be activated on data with version 1.1+.
This is determined by the <code>hu.icellmobilsoft.coffee.tool.version.ComparableVersion</code> class.</p>
<div class="ulist">
<ul>
<li>
<p>It is possible to specify different version intervals</p>
</li>
</ul>
</div>
</li>
<li>
<p>AcExampleRule is a rule of category "Ac" with input LineType (can be anything)
and a CustomRuleResult (<code>extends hu.icellmobilsoft.coffee.module.ruleng.rule.RuleResult</code>) is evaluated</p>
</li>
<li>
<p>Currently also uses IRuleSelector, which is optional.
The implemented methods use the default values in the example. If you have multiple rules
for the same combination of category and implementation, the system will group and implement them accordingly</p>
<div class="ulist">
<ul>
<li>
<p>order() - will apply the evaluation in ascending order.</p>
</li>
<li>
<p>group() - rule group. If a rule in the group is caught by a RuleException,
then the subsequent rules in the order will not be executed. No other group is affected by the interruption,
groups are independent of each other</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you do not put an IRuleSelector interface on the rule, the rules will run by default according to Class.SimpleName,
and will belong to RuleGroup.NONE
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Check the input data, focus only on whether the data to check exists</p>
</li>
<li>
<p>The data is evaluated and the role of the rule ends here</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The evaluation CustomRuleResult can be customized to the needs of the project, the condition is that <code>hu.icellmobilsoft.coffee.module.ruleng.rule.RuleResult</code> is the ancestor
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_validator">4.11.3. Validator</h4>
<div class="paragraph">
<p>It is intended to handle rules belonging to the rule category.</p>
</div>
<div class="listingblock">
<div class="title">Sample validator</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import java.lang.annotation.Annotation;

import javax.enterprise.inject.Model;
import javax.enterprise.util.TypeLiteral;

import hu.icellmobilsoft.coffee.module.ruleng.rule.IRule;
import hu.icellmobilsoft.coffee.module.ruleng.evaluator.AbstractEvaluator;
import hu.icellmobilsoft.project.schemas.data.LineType;
import hu.icellmobilsoft.sample.common.system.validator.rule.CustomRuleResult;
import hu.icellmobilsoft.sample.invoice.common.action.evaluator.annotation.Ac;

@Model
public class ACEvaluatorLineType extends AbstractEvaluator&lt;LineType, CustomRuleResult&gt; {

    @Override
    protected Annotation cdiSelectLiteral() {
        return new Ac.Literal(); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    @Override
    protected TypeLiteral&lt;IRule&lt;LineType, CustomRuleResult&gt;&gt; cdiTypeLiteral() {
        return new TypeLiteral&lt;IRule&lt;LineType, CustomRuleResult&gt;&gt;() { <i class="conum" data-value="2"></i><b>(2)</b>
            private static final long serialVersionUID = 1L;
        };
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Rule category Qualifier annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>IRule&lt;LineType, CustomRuleResult&gt; implemeted rules of type CDI literal</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">How it works:</div>
<ul>
<li>
<p>There can also be more than one validator, each rule category and implementation must have its own.</p>
</li>
<li>
<p>The first thing it does is read from the CDI container the category and implementation rules it handles.</p>
<div class="ulist">
<ul>
<li>
<p>It tries to group them by the IRuleSelector mentioned above and then sorts them by order and then by class name</p>
</li>
</ul>
</div>
</li>
<li>
<p>Runs through the categorized rules, collects the results</p>
</li>
<li>
<p>Returns in response the results of all rules run</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-mp-opentracing">4.12. coffee-module-mp-opentracing</h3>
<div class="paragraph">
<p>The purpose of this module is to support microprofile opentracing which includes the following principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Coffee compatibility - allows coffee modules to provide trace information. The included interceptor can handle the modules of coff:ee, it can be enhanced by introducing its own members, which are contained in the coffee-cdi module.</p>
</li>
<li>
<p>It complements metrics and logging for full observability.</p>
</li>
<li>
<p>Currently we use our own classes as it is not possible to manage well at extension level which component should provide trace information.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_microprofile_opentracing">4.12.1. microprofile-opentracing</h4>
<div class="paragraph">
<p>Based on <a href="https://github.com/eclipse/microprofile-opentracing" class="bare">https://github.com/eclipse/microprofile-opentracing</a> and the
<a href="https://github.com/opentracing-contrib/java-interceptors" class="bare">https://github.com/opentracing-contrib/java-interceptors</a> project.
We use our own binding instead of the <code>org.eclipse.microprofile.opentracing.Traced</code> annotation, as this way we can completely decouple the traceability of our modules.</p>
</div>
</div>
<div class="sect3">
<h4 id="_core">4.12.2. Core</h4>
<div class="paragraph">
<p>The bindings in the extension are used to make the different technologies of the modules traceable.</p>
</div>
<div class="sect4">
<h5 id="_opentraceinterceptor">OpenTraceInterceptor</h5>
<div class="paragraph">
<p>The interceptor handles methods annotated with <code>hu.icellmobilsoft.coffee.cdi.trace.annotation.Traced</code>. This is used by the <code>OpenTraceInterceptor</code>. With this solution, it becomes easy to later replace/modify the trace interceptor&#8217;s behavior. It automatically handles the trace flow for rest, redis, redis-stream, etcd and gRPC.</p>
</div>
</div>
<div class="sect4">
<h5 id="_coffee_module_redis_trace">coffee-module-redis trace</h5>
<div class="paragraph">
<p>The <code>OpenTraceInterceptor</code> works with span values filled in the <code>@Traced</code> annotation. If the value of <code>@Traced.component</code> in the annotation is 'Jedis'
then the interceptor will take the functionName parameter as the basis for determining the span name, otherwise the class name of the annotated method will be used. This value decides whether the Jedis client operation should join an existing trace stream, rather than start a new trace stream by itself. This operation is implemented via the <code>RedisManager</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_coffee_module_redisstream_trace">coffee-module-redisstream trace</h5>
<div class="paragraph">
<p>Annotated the <code>AbstractStreamConsumer.onStream</code> method and the <code>AbstractStreamPipeConsumer.onStream</code> method.
A new trace is started with the tag values specified via the <code>@Traced</code> annotation. It automatically includes Rest calls and Jedis operations outgoing from here. The span operation name will be the name of the class containing the annotated method.</p>
</div>
</div>
<div class="sect4">
<h5 id="_coffee_module_etcd_trace">coffee-module-etcd trace</h5>
<div class="paragraph">
<p>The <code>ConfigEtcdHandler</code> has been annotated, the method calls in it will return trace data.</p>
</div>
</div>
<div class="sect4">
<h5 id="_coffee_deltaspike_data_trace">coffee-deltaspike-data trace</h5>
<div class="paragraph">
<p>The <code>OpenTraceHandler</code> manages the channeling of database operations in the repository layer into the trace flow.</p>
</div>
</div>
<div class="sect4">
<h5 id="_opentraceerrorresponsefilter">OpenTraceErrorResponseFilter</h5>
<div class="paragraph">
<p>Other operations that return an HTTP500 or higher error code will not appear as errors in the trace.
This filter should handle it, but it is currently exception based, which will not happen in the trace.
<a href="https://github.com/opentracing-contrib/java-jaxrs/blob/master/opentracing-jaxrs2/src/main/java/io/opentracing/contrib/jaxrs2/server/SpanFinishingFilter.java" class="bare">https://github.com/opentracing-contrib/java-jaxrs/blob/master/opentracing-jaxrs2/src/main/java/io/opentracing/contrib/jaxrs2/server/SpanFinishingFilter.java</a>
The filter is supposed to handle this case.</p>
</div>
</div>
<div class="sect4">
<h5 id="_wildfly_based_project_config">Wildfly based project config</h5>
<div class="paragraph">
<p>Default is using the Jaeger trace implementation.
<a href="https://docs.wildfly.org/20/wildscribe/subsystem/microprofile-opentracing-smallrye/jaeger-tracer/index.html" class="bare">https://docs.wildfly.org/20/wildscribe/subsystem/microprofile-opentracing-smallrye/jaeger-tracer/index.html</a>
.pom.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-opentracing&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-mp-metrics">4.13. coffee-module-mp-metrics/micrometer</h3>
<div class="paragraph">
<p>The purpose of the modules is to support <a href="https://github.com/eclipse/microprofile-metrics">microprofile metrics</a>
and <a href="https://github.com/micrometer-metrics/micrometer">micrometer</a>,
which includes the following principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Coffee Compatibility - provides the opportunity for Coffee modules
to provide metric information.
The interceptor within it is capable of handling Coffee modules and is extensible.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_coffee_core">4.13.1. coffee-core</h4>
<div class="paragraph">
<p>Contains a metric-independent <code>Noop*</code> implementation that is activated by default
when no specific metric implementation is plugged in.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_redis">4.13.2. coffee-module-redis</h4>
<div class="paragraph">
<p>The module <a href="#coffee_module_redis-metrics">contains metrics</a>
that can be activated based on the metric implementation:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-redis&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-micrometer&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/dependency&gt;
&lt;!-- or --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-metrics&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Micrometer metric implementation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Microprofile-metrics metric implementation</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-mp-restclient">4.14. coffee-module-mp-restclient</h3>
<div class="paragraph">
<p>The purpose of this module is to support a microprofile restclient which includes the following principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Coffee compatibility - copying original request headers, passing log MDC keys, exception handling</p>
</li>
<li>
<p>Business process traceability - request/response logging</p>
</li>
<li>
<p>HTTP communication customization - internal/external HTTP communication modifiability (e.g. between services
different REST http than say when sending request to XY, different headers,
content, content-type, etc..), TLS encryption, URL and behaviour (timeout, repeat, etc&#8230;&#8203;) override</p>
</li>
<li>
<p>Exception customization - locally modifiable error handling</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_microprofile_rest_client">4.14.1. microprofile-rest-client</h4>
<div class="paragraph">
<p>The starting point is <a href="https://github.com/eclipse/microprofile-rest-client">microprofile-rest-client</a>
which is a member of the <a href="https://microprofile.io/">micropfile.io</a> group. It can do many things
off our shoulders, it can be used on its own but needs to be extended to meet the needs of projects
some useful features.</p>
</div>
</div>
<div class="sect3">
<h4 id="_core_2">4.14.2. Core</h4>
<div class="paragraph">
<p>Most of the above principles are implemented in the <a href="https://github.com/eclipse/microprofile-rest-client">microprofile-rest-client</a>
the rest is done by the next few classes.</p>
</div>
<div class="sect4">
<h5 id="_defaultloggerclientrequestfilter">DefaultLoggerClientRequestFilter</h5>
<div class="paragraph">
<p>This is a default REST client <strong>REQUEST logger</strong>,
which takes into account if <code>LogSpecifier</code> is specified with <code>CLIENT_REQUEST</code> target (<a href="#common_core_coffee-rest_LogSpecifier">LogSpecifier</a>).
So it will log the HTTP <strong>request</strong> data sent by the client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HTTP method, URL address</p>
</li>
<li>
<p>HTTP headers</p>
</li>
<li>
<p>cookies</p>
</li>
<li>
<p>Entity</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It sends all this to the logger at INFO level.</p>
</div>
</div>
<div class="sect4">
<h5 id="_defaultloggerclientresponsefilter">DefaultLoggerClientResponseFilter</h5>
<div class="paragraph">
<p>This is a default REST client <strong>RESPONSE logger</strong>,
which takes into account if you have specified <code>LogSpecifier</code> with <code>CLIENT_RESPONSE</code> target (<a href="#common_core_coffee-rest_LogSpecifier">LogSpecifier</a>).
So it will log the HTTP <strong>request response</strong> data sent by the client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HTTP status + accessories</p>
</li>
<li>
<p>HTTP headers</p>
</li>
<li>
<p>cookies</p>
</li>
<li>
<p>locale, location values</p>
</li>
<li>
<p>Entity</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All this is sent to the logger at INFO level</p>
</div>
</div>
<div class="sect4">
<h5 id="_defaultsettingclientrequestfilter">DefaultSettingClientRequestFilter</h5>
<div class="paragraph">
<p>This is a default REST client "REST setting copy".
Its job is to bind the REST call through <strong>services</strong>,
so that, for example, the basics of logging and <strong>authentication</strong> can work.</p>
</div>
<div class="paragraph">
<p>In other words, when a REST request comes into the service,
processing in the microservice requires a call through to another microservice,
then that HTTP call needs to include those HTTP headers in the same way,
which were entered in the service request, so that the authentication there can be successful.
Specifically, the setting of the authentication MDC variables will be included in the HTTP headers sent out.</p>
</div>
</div>
<div class="sect4">
<h5 id="_defaultbaseexceptionresponseexceptionmapper">DefaultBaseExceptionResponseExceptionMapper</h5>
<div class="paragraph">
<p>Its purpose is to process the error received in the response,
from the usual coffee BaseException <code>hu.icellmobilsoft.coffee.dto.exception.RestClientResponseException</code>
class.</p>
</div>
</div>
<div class="sect4">
<h5 id="common_module_coffee-module-mp-restclient_DefaultRestClientBuilderListener">DefaultRestClientBuilderListener</h5>
<div class="paragraph">
<p>This is a <strong>default "activator" for connecting the above listed classes</strong>.
This class can be used directly or configured freely.
Additionally, the HTTP client timeout values are defined in this class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5 sec connect timeout</p>
</li>
<li>
<p>1 min read timeout</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If there is any operational change request,
it can be influenced through this central "activator" class,
further options are mentioned below,
which are done according to the rules of <a href="https://github.com/eclipse/microprofile-rest-client">microprofile-rest-client</a>.</p>
</div>
<div class="paragraph">
<p>That "activator" should also be taken into account in the
<a href="https://github.com/eclipse/microprofile-rest-client">microprofile-rest-client</a>
must be registered in the following file:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/services/org.eclipse.microprofile.rest.client.spi.RestClientBuilderListener</div>
<div class="content">
<pre class="highlight"><code class="language-txt" data-lang="txt"># coffee default
hu.icellmobilsoft.coffee.module.mp.restclient.provider.DefaultRestClientBuilderListener
# projects customized
#hu.icellmobilsoft.sample.invoice.service.provider.ProjectRestClientBuilderListener</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a plain txt file without postfix and extension.</p>
</div>
</div>
<div class="sect4">
<h5 id="_faulttypeparserextension">FaultTypeParserExtension</h5>
<div class="paragraph">
<p>Gathers enum classes implementing the <code>IFaultType</code> interface and annotated with <code>@hu.icellmobilsoft.coffee.cdi.annotation.FaultTypeCode</code>.
Based on this, <code>FaultTypeParser</code> is able to parse the response String faultCode in mp rest client calls to enum and map it to the corresponding exception.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">IMPORTANT</dt>
<dd>
<p>It can only parse enums accessible by the container, this requires that <code>beans.xml</code> is present in the implementation module.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The read implementations can be ordered by the <code>@Priority</code> annotation, the default priority is 500.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_in_the_project_2">4.14.3. Implementation in the project</h4>
<div class="sect4">
<h5 id="_pom_xml_2">pom.xml</h5>
<div class="listingblock">
<div class="title">Coffee module activation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee.module.mp.restclient&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-restclient&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_usage_examples">4.14.4. Usage examples</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For a complete detailed description of the usage itself, see
<a href="https://github.com/eclipse/microprofile-rest-client">microprofile-rest-client</a>
relese releases. We will mention a few examples here locally.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_sample_usage">Sample usage</h5>
<div class="sect5">
<h6 id="_initialization">Initialization</h6>
<div class="paragraph">
<p>In the class where the REST operations are defined
(if you follow the company recommended REST structure then this is the REST interface) you need to add the
@RegisterRestClient annotation.
This basically tells the microprofile-rest-client system
to refer to the REST endpoints defined in it as HTTP REST clients.
In the client itself you will be able to use the types and annotations used here,
the burden falls on the separate settings for these (e.g. text/xml, application/json, entity class, etc&#8230;&#8203;)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Tag(name = IInvoiceTestRest.TAG_TEST, description = "SYSTEM REST test operations required for Invoice Processor")
@Path(InvoicePath.TEST_INVOICE_SERVICE)
@RegisterRestClient <i class="conum" data-value="1"></i><b>(1)</b>
public interface IInvoiceTestRest {

    static final String TAG_TEST = "Test";
    ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>add the @RegisterRestClient annotation.
Usually nothing else is needed (unless there are some special needs), old functionality is not affected</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_using_http_client">Using HTTP client</h6>
<div class="paragraph">
<p>The most used instances of HTTP REST client in the code:</p>
</div>
<div class="listingblock">
<div class="title">CDI inject</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import javax.enterprise.inject.Model;
import javax.inject.Inject;

import org.eclipse.microprofile.rest.client.inject.RestClient;

import hu.icellmobilsoft.coffee.dto.exception.BaseException;
import hu.icellmobilsoft.coffee.module.mp.restclient.util.MPRestClienUtil;

@Model
public class TestAction {

    @Inject
    @RestClient <i class="conum" data-value="1"></i><b>(1)</b>
    private IInvoiceTestRest iInvoiceTestRest; <i class="conum" data-value="2"></i><b>(2)</b>

    public String test() throws BaseException {
        try {
            iInvoiceTestRest.postValidatorTest(entityClass); <i class="conum" data-value="3"></i><b>(3)</b>
        } catch (Exception e) { <i class="conum" data-value="4"></i><b>(4)</b>
            throw MPRestClientUtil.toBaseException(e); <i class="conum" data-value="5"></i><b>(5)</b>
        }
        return null;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mp-rest-client @Qualifier annotation that creates the HTTP client wrapper</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>interface marked with the @RegisterRestClient annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>HTTP REST client call - this is where the configuration settings (URL, HTTP header, timeout, etc&#8230;&#8203;) come into play</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>general HTTP management. The operation itself is defined as BaseException but it is at the service level,
we are using it as a client and at &lt;1&gt; we wrapped it in a wrapper,
which may return with other RuntimeException errors</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Coffee level pre-written Exception compiler</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In fact, a boilerplate wrapper will be created for the whole thing to simplify the coding even more.</p>
</div>
<div class="listingblock">
<div class="title">inline</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import java.net.URI;

import javax.enterprise.inject.Model;
import javax.inject.Inject;

import org.eclipse.microprofile.rest.client.RestClientBuilder;

import hu.icellmobilsoft.coffee.dto.exception.BaseException;
import hu.icellmobilsoft.coffee.module.mp.restclient.util.MPRestClienUtil;

@Model
public class TestAction {

    public String doWorkAgainstApi(URI uri, Object entity) {
        try {
            IInvoiceTestRest iInvoiceTestRest = RestClientBuilder //
                    .newBuilder() <i class="conum" data-value="1"></i><b>(1)</b>
                    .baseUri(uri) <i class="conum" data-value="2"></i><b>(2)</b>
                    .build(IInvoiceTestRest.class); <i class="conum" data-value="3"></i><b>(3)</b>
            return iInvoiceTestRest.postValidatorTest(entity);
        } catch (Exception e) { <i class="conum" data-value="4"></i><b>(4)</b>
            throw MPRestClientUtil.toBaseException(e); <i class="conum" data-value="5"></i><b>(5)</b>
        }
        return null;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>here calls <a href="#common_module_coffee-module-mp-restclient_DefaultRestClientBuilderListener">DefaultRestClientBuilderListener</a>,
any setting of which can be overridden.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>override the URI defined in the configs</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>interface marked with the @RegisterRestClient annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>general error handling. The operation itself has BaseException defined but the builder wrapped it in a wrapper,
which may return other RuntimeException errors</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Exception compiler pre-written in Coffee</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This use case is very specific,
if possible, strive for a CDI and configuration level solution.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_options">Configuration options</h5>
<div class="paragraph">
<p>Configurations can be specified at the same time as annotations,
but of course the options of microprofile-config are also given now.
I will also list some of the most common configuration patterns.
The syntax itself is the covariate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-txt" data-lang="txt">category-key-name/mp-rest/key

or

full-class-name/mp-rest/key</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>category-key-name</strong> - keyword we choose in our code
and used in the <code>@RegisterRestClient(configKey="invoiceService")</code> annotation,
which in our case is for example "invoiceService"</p>
</li>
<li>
<p><strong>full-class-name</strong> - class (in our case, rather interface) name,
where the @RegisterRestClient annotation is loaded. Avoid <strong>this kind of configuration</strong> if possible,
as later refactoring may cause hidden errors in the configurations</p>
</li>
<li>
<p><strong>/mp-rest</strong> - microprofile-rest-client default keyword</p>
</li>
<li>
<p><strong>/key</strong> - the key itself supported by microprofile-rest-client, e.g.: url, providers, readTimeout, etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">project-default.yml - sample configuration</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">"invoiceService/mp-rest/url": http://localhost:8083
"invoiceService/mp-rest/providers": hu.icellmobilsoft.project.invoice.CustomProvider

#or the other option

"hu.icellmobilsoft.project.invoice.service.rest.IInvoiceTestRest/mp-rest/url": http://localhost:8083
"hu.icellmobilsoft.project.invoice.service.rest.IInvoiceTestRest/mp-rest/providers": hu.icellmobilsoft.project.invoice.CustomProvider</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-totp">4.15. coffee-module-totp</h3>
<div class="paragraph">
<p>The purpose of this module is to create and verify Time-based one-time passwords (TOTP) according to the standard.
We have implemented the algorithm described in RFC 6238, supplemented by the microprofile-config we use.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The algorithm in rfc-6238
<a href="https://tools.ietf.org/html/rfc6238" class="bare">https://tools.ietf.org/html/rfc6238</a>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_implementation_in_the_project_3">4.15.1. Implementation in the project</h4>
<div class="sect4">
<h5 id="_pom_xml_3">pom.xml</h5>
<div class="listingblock">
<div class="title">Coffee module activation</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee.module.totp&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-totp&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Table 1 shows the configuration keys used by the module.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. configuration parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">parameter name</th>
<th class="tableblock halign-left valign-top">default value</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">totp.password.digits.length</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of the password generated by our method (max. 9)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">totp.password.timestep.millisec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of the time window in milliseconds associated with the currently generated password</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">totp.password.hash.algorithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HmacSha1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use this hash algorithm to generate the password</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">totp.password.secret.length</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A secret of this length is generated/used</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">totp.verify.additional.windows.count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This parameter is used to extend the password verification to adjacent time windows</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The default values are set so that the module generates the same otp as google authenticator, but of course you can deviate from this.</p>
</div>
<div class="ulist">
<div class="title">The main methods</div>
<ul>
<li>
<p>TOTPVerifier.verify</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This allows us to validate the resulting OTP by extending the validity check to additional time windows.
You can specify all the data needed for the verification in a parameter, but you can also use the overload methods, where the stored/default values in the configuration are used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TOTPGenerator.generateBase32Secret</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This generates a (shared) secret for the user, by default 16 bytes long. The desired length can be passed as a parameter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TOTPGenerator.generatePassword</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we need an OTP, we can use the generatePassword method for this, also specifying all the parameters needed to generate it, or based on the configured/default values.</p>
</div>
<div class="listingblock">
<div class="title">Usage:</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Inject
private TOTPVerifier totpVerifier;
@Inject
private TOTPGenerator totpGenerator;

//secretKey generation, you can optionally specify the length of the secret in a parameter, but 16 is usually sufficient
String secretKeyBase32Encoded1 = totpGenerator.generateBase32Secret();
String secretKeyBase32Encoded2 = totpGenerator.generateBase32Secret(32);

//check the received password
//throws TechnicalExceptiont with error code CoffeeFaultType.INVALID_ONE_TIME_PASSWORD in case of wrong password
totpVerifier.verify(secretKey, clientOtp, currentUTCTimestamp, codeDigits, hashAlgorithm);
//if we use default configuration, we can call methods with less parameters
totpVerifier.verify(secret, clientOtp);
totpVerifier.verify(secret, clientOtp, currentUTCTimestamp);


//totp generation
//output of the following methods is the generated password
String otp1 = totpGenerator.generatePassword(secret, currentUTCTimestamp, digits, TOtpAlgorithm);
//if we use default configuration, we can call methods with less parameters
String otp2 = totpGenerator.generatePassword(secret);
String otp3 = totpGenerator.generatePassword(secret, currentUTCTimestamp);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is advisable to persist the last validated and accepted OTP at the project level, so that it cannot be reentered.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Coffee implements a default TOTPGenerator (DefaultTOTPGneratorImpl) and a TOTPVerifier (DefaultTOTPVerifierImpl) class, which can be overridden in the project using CDI if required.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-docgen-config">4.16. coffee-module-docgen-config</h3>
<div class="paragraph">
<p>The purpose of this module is to generate documentation from classes containing configuration keys</p>
</div>
<div class="sect3">
<h4 id="_usage_2">4.16.1. Usage</h4>
<div class="paragraph">
<p>To use it, the sub-dependency must be added to <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;.
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-docgen-config&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_for_static_configuration_keys">For static configuration keys</h5>
<div class="paragraph">
<p>Next, the classes containing the configuration keys must be annotated with the <code>@ConfigDoc</code> annotation.</p>
</div>
<div class="paragraph">
<p>If this is done by default, the generated asciidoc will be included in the <code>.jar</code> file at compile time as <code>META-INF/config_keys.adoc</code>.
The keys are displayed in separate tables according to the prefix before the first dot character.</p>
</div>
<div class="sect5">
<h6 id="_example">Example</h6>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ConfigDoc <i class="conum" data-value="1"></i><b>(1)</b>
public interface ConfigDocExample {

    /**
     * test prefix
     */
    @ConfigDoc(exclude = true) <i class="conum" data-value="2"></i><b>(2)</b>
    String PREFIX = "test.";

    /**
     * test2
     */
    String test2 = "test2.xxx";

    /**
     * Lorem ipsum dolor sit amet, consectetur adipisicing elit. Illo, placeat!
     */
    String foo = PREFIX + "foo";

    /**
     * Lorem ipsum dolor sit amet, consectetur adipisicing elit. Iusto, sapiente?
     */
    @ConfigDoc(description = "Override...") <i class="conum" data-value="3"></i><b>(3)</b>
    String bar = PREFIX + "bar";

    /**
     * Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ipsam, similique?
     * @since 3.14159 <i class="conum" data-value="4"></i><b>(4)</b>
     */
    @ConfigDoc(defaultValue = "5000") <i class="conum" data-value="5"></i><b>(5)</b>
    String baz = PREFIX + "baz";

    /**
     * Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ipsam, similique?
     *
     * @since 3.14159
     */
    @ConfigDoc(defaultValue = "999", isStartupParam = true, isRuntimeOverridable = true) <i class="conum" data-value="6"></i><b>(6)</b>
    String features = PREFIX + "features";

    /**
     * Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ipsam, similique?
     *
     * @since 3.14159
     */
    @ConfigDoc(defaultValue = "1234", title = "Title Test") <i class="conum" data-value="7"></i><b>(7)</b>
    String titleTest = PREFIX + "title";

    /**
     * Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ipsam, similique?
     *
     * @since 3.14159
     */
    @ConfigDoc(defaultValue = "1234", title = "Title Test", titleHeadingLevel = 1) <i class="conum" data-value="8"></i><b>(8)</b>
    String titleHeadingLevelTest = PREFIX + "titleHeadingLevelTest";
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Generation is activated on a class with the annotation <code>@ConfigDoc</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>exclude</code> field can be used to exclude fields from the generation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By default, the javadoc description is included in the generated file, which can be overwritten with the <code>description</code> field of the annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>since</code> column of the generated table can be retrieved from the <code>@since</code> javadoc tag</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The default value for the configuration can be specified</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>isStartupParam</code> marks if the parameter is for startup.
The <code>isRuntimeOverridable</code> marks if the parameter can be overridden at runtime.
Both of the parameters are going to be shown under the `Features`column represented as emojis:
<div class="ulist">
<ul>
<li>
<p>For <code>isStartupParam</code> true the emoji is: 🚀</p>
</li>
<li>
<p>For <code>isRuntimeOverridable</code> true the emoji is: ⏳</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>With the <code>title</code> parameter we can overwrite the default title for the generated tables(optional).</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>With the <code>titleHeadingLevel</code> parameter we can set the heading level for the title of the generated table(optional).
Note that if multiple values are given for the same title on multiple parameters the smallest value will be selected and it also needs to be in the range of [0,5] if not we use the value of 3 as fallback.</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/coffee-module-docgen-config-example1.png" alt="coffee module docgen config example1">
</div>
<div class="title">Figure 1. The result of the above example code</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_for_dynamic_configuration_keys">For dynamic configuration keys</h5>
<div class="paragraph">
<p>For configs with dynamic keys (e.g. redis, mongo db),
the keys must be included in a MessageFormat format,
then the class containing the keys must be annotated with the <code>@DynamicConfigTemplate</code> annotation,
and the class or its variables with the already known <code>@ConfigDoc</code> annotation.</p>
</div>
<div class="paragraph">
<p>From the classes annotated with <code>@DynamicConfigTemplate</code>, a template adoc corresponding to the <code>@ConfigDoc</code> annotation will be created,
in the <code>META-INF/config-templates</code> folder, under the name <code>fully-qualified-class-name.adoc</code>.</p>
</div>
<div class="paragraph">
<p>After that, the qualifier and/or injection point for the config must be annotated in the <code>@DynamicConfigDocs</code>
annotation, where templateClass is the class containing the keys.</p>
</div>
<div class="paragraph">
<p>When processing the <code>@DynamicConfigDocs</code> annotation, both the injection point and the qualifier
are read, with preference given to the injection point.</p>
</div>
<div class="paragraph">
<p>If this is done by default, the compiled <code>.jar</code> file will include the generated asciidoc in the `META-INF/</p>
</div>
<div class="listingblock">
<div class="title">Template class</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ConfigDoc
@DynamicConfigTemplate <i class="conum" data-value="1"></i><b>(1)</b>
public interface DynamicConfigTemplateExample {

    /**
     * test prefix
     */
    @ConfigDoc(exclude = true) <i class="conum" data-value="2"></i><b>(2)</b>
    String PREFIX = "test.";

    /**
     * Lorem ipsum dolor sit amet, consectetur adipisicing elit. Illo, placeat!
     */
    String foo = PREFIX + "{0}.foo"; <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Template generation is activated on a class with the annotation <code>@ConfigDoc</code> and <code>@DynamicConfigTemplate</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>On the fields, <code>@ConfigDoc</code> can be used to generate the template</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Part of the key variable with MessageFormat placeholders</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">qualifier</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@DynamicConfigDocs( <i class="conum" data-value="1"></i><b>(1)</b>
        template = DynamicConfigTemplateExample.class, <i class="conum" data-value="2"></i><b>(2)</b>
        title = "Dynamic config {0} config keys", <i class="conum" data-value="3"></i><b>(3)</b>
        description = "Dyn configuration keys" <i class="conum" data-value="4"></i><b>(4)</b>
)
public @interface DynamicConfigurationQualifierExample {

    /**
     * Config key of the desired dynamic configuration
     *
     * @return config key
     */
    String configKey();

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>@DynamicConfigDocs annotation containing default values for qualifier</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The template to use for dynamic config</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Default address for the config (may contain placeholders)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Default description of the config (may contain placeholders)</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Injection point</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class DynamicConfigInjectionPointExample {

    @Inject
    @DynamicConfigDocs(templateVariables = "abc") <i class="conum" data-value="1"></i><b>(1)</b>
    @DynamicConfigurationQualifierExample(configKey = "abc")
    private Object injectedConfig;

    @Inject
    @DynamicConfigDocs(templateVariables = "xyz", title = "Title override for config key {0}") <i class="conum" data-value="2"></i><b>(2)</b>
    @DynamicConfigurationQualifierExample(configKey = "xyz")
    private Object otherConfig;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The config key to insert into the template in the qualifier is <code>abc</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Second config with different key: <code>xyz</code>, with overwritten address</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/coffee-module-docgen-config-dynamic-example1.png" alt="coffee module docgen config dynamic example1">
</div>
<div class="title">Figure 2. result of the above example code</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration">4.16.2. Configuration</h4>
<div class="paragraph">
<p>Since the generation uses an annotation processor, it can be configured at compile time with <code>-A</code>.
This can be specified via <code>maven-compiler-plugin</code> for maven:</p>
</div>
<div class="listingblock">
<div class="title">example pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
                &lt;compilerArgs&gt;
                    &lt;arg&gt;-Acoffee.docgen.config.outputDir=${project.basedir}/../docs/&lt;/arg&gt; <i class="conum" data-value="1"></i><b>(1)</b>
                    &lt;arg&gt;-Acoffee.docgen.config.outputFileName=${project.name}_config.adoc&lt;/arg&gt; <i class="conum" data-value="2"></i><b>(2)</b>
                    &lt;arg&gt;-Acoffee.docgen.config.outputToClassPath=false&lt;/arg&gt; <i class="conum" data-value="3"></i><b>(3)</b>
                    &lt;arg&gt;-Acoffee.docgen.config.dynamicOutputFileName=dynamic_${project.name}_config.adoc&lt;/arg&gt; <i class="conum" data-value="4"></i><b>(4)</b>
                    &lt;arg&gt;-Acoffee.docgen.config.columns=key,since,description&lt;/arg&gt; <i class="conum" data-value="5"></i><b>(5)</b>
                &lt;/compilerArgs&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The folder where the generated file will be placed. Default: <code>META-INF/</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Name of the generated file. Default: <code>config_keys.adoc</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Whether the generated file should be put on the classpath, i.e. whether we want it to be included in the generated jar file. Default: <code>true</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of the generated file for dynamic configurations. Default: <code>dynamic_config_keys.adoc</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The columns displayed in the generated table in the order specified. Default: <code>key, source, description, default_value, since</code> (all columns)</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-docgen-sqlcatalog">4.17. coffee-module-docgen-sqlcatalog</h3>
<div class="paragraph">
<p>The purpose of this module is to generate sql catalog from repository classes</p>
</div>
<div class="sect3">
<h4 id="_usage_3">4.17.1. Usage</h4>
<div class="paragraph">
<p>To use it, the sub-dependency must be added to <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;.
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-docgen-sqlcatalog&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_sql_catalog">SQL catalog</h5>
<div class="paragraph">
<p>SQL catalog will be generated based on the repository methods which are annotated with the <code>@Query</code> annotation.</p>
</div>
<div class="paragraph">
<p>By default, the generated asciidoc will be included in the <code>.jar</code> file at compile time as <code>META-INF/sql_catalog.adoc</code>.
The SQL catalog is display in one table which contains repository class name, method name, query in jpql format and an optional comment.</p>
</div>
<div class="sect5">
<h6 id="_example_2">Example</h6>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Repository
public interface ExampleRepository {

    @Query("SELECT o From Object o WHERE o.id = :id")
    Object findById(String id);

    @Query(value = "SELECT o From Object o WHERE o.name = :name", hints = { @QueryHint(name = HibernateHints.HINT_COMMENT, value = "EXAMPLE-ID"),
            @QueryHint(name = HibernateHints.HINT_READ_ONLY, value = true + "") })
    Object findByName(String name);
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/coffee-module-docgen-sqlcatalog-example.png" alt="coffee module docgen sqlcatalog example">
</div>
<div class="title">Figure 3. The result of the above example code</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_2">4.17.2. Configuration</h4>
<div class="paragraph">
<p>Since the generation uses an annotation processor, it can be configured at compile time with <code>-A</code>.
This can be specified via <code>maven-compiler-plugin</code> for maven:</p>
</div>
<div class="listingblock">
<div class="title">example pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
                &lt;compilerArgs&gt;
                    &lt;arg&gt;-Acoffee.docgen.sql.catalog.outputDir=${project.basedir}/../docs/&lt;/arg&gt; <i class="conum" data-value="1"></i><b>(1)</b>
                    &lt;arg&gt;-Acoffee.docgen.sql.catalog.outputFileName=${project.name}_sql_catalog.adoc&lt;/arg&gt; <i class="conum" data-value="2"></i><b>(2)</b>
                    &lt;arg&gt;-Acoffee.docgen.sql.catalog.outputToClassPath=false&lt;/arg&gt; <i class="conum" data-value="3"></i><b>(3)</b>
                &lt;/compilerArgs&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The folder where the generated file will be placed. Default: <code>META-INF/</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Name of the generated file. Default: <code>sql_catalog.adoc</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Whether the generated file should be put on the classpath, i.e. whether we want it to be included in the generated jar file. Default: <code>true</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-wildfly">4.18. coffee-module-wildfly</h3>
<div class="paragraph">
<p>The purpose of this module is to use wildfly specific functions.</p>
</div>
<div class="listingblock">
<div class="title">AbstractWildflySystemRest</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SystemRest extends AbstractWildflySystemRest {

    @Inject
    private EvictAction evictAction;

    @Override
    public hu.icellmobilsoft.coffee.dto.common.config.evict.EvictResponse getEvict() throws BaseException {
        return wrapNoParam(evictAction::evict, "evict");
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_module_coffee-module-quarkus">4.19. coffee-module-quarkus</h3>
<div class="paragraph">
<p>The purpose of this module is to use quarkus specific functions.</p>
</div>
<div class="listingblock">
<div class="title">SystemRest</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SystemRest extends AbstractWildflySystemRest { <i class="conum" data-value="1"></i><b>(1)</b>

    @Inject
    private EvictAction evictAction;

    @Override
    public hu.icellmobilsoft.coffee.dto.common.config.evict.EvictResponse getEvict() throws BaseException {
        return wrapNoParam(evictAction::evict, "evict");
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>AbstractWildflySystemRest or AbstractQuarkusSystemRest depends on the appserver</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>/versionInfo</code> endpoint determines the application name using the <code>quarkus.application.name</code> property. If this property is not specified, it falls back to the <code>coffee.app.name</code> variable. Additionally, it looks for this value as the Implementation-Version in the displayed META-INF/MANIFEST.MF file.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order for the <code>/versionInfo</code> endpoint to work in native mode with Quarkus, we need to retain our MANIFEST.MF file during the build by using the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">quarkus:
  native:
    resources:
      includes:
        - META-INF/MANIFEST.MF</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common_coffee-quarkus-extensions">5. Coffee Quarkus extensions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_general">5.1. General</h3>
<div class="paragraph">
<p>In the case of Quarkus, several CDI elements need to be handled differently.</p>
</div>
<div class="paragraph">
<p>The most important article where it is summarized what is involved is on the quarkus page: <a href="https://quarkus.io/guides/writing-extensions">Quarkus.io - WRITING YOUR OWN EXTENSION</a>.
It describes the philosophy behind Quarkus extensions.</p>
</div>
<div class="paragraph">
<p>Quarkus extension building basics help: <a href="https://quarkus.io/guides/building-my-first-extension">Quarkus.io - BUILDING MY FIRST EXTENSION</a></p>
</div>
<div class="paragraph">
<p>List of extensions built specifically for Quarkus: <a href="https://quarkus.pro/extensions">Link</a></p>
</div>
</div>
<div class="sect2">
<h3 id="common_coffee-quarkus-extensions-module-mp-restclient">5.2. coffee-module-mp-restclient-extension</h3>
<div class="paragraph">
<p>The purpose of this module is that if coffee-module-mp-rest-client is used in quarkus, it replaces the elements in it that are not supported by quarkus.</p>
</div>
<div class="paragraph">
<p>Quarkus does not support Extensions as FaultyType enum classes are bundled together in the module, so this needs to be resolved in Quarkus Extension.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
currently Quarkus version 3.2.x is used in extensions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use the module, you should not use coffee-module-mp-rest-client in the dependencies, but use the extension that contains the module.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;.
        &lt;groupId&gt;hu.icellmobilsoft.coffee.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;coffee-module-mp-restclient-extension&lt;/artifactId&gt;
        &lt;version&gt;${version.hu.icellmobilsoft.coffee}&lt;/version&gt;
        &lt;type&gt;pom&lt;/type&gt;
        &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_coffee-quarkus-extensions-module-etcd">5.3. coffee-module-etcd-extension</h3>
<div class="paragraph">
<p>The purpose of this module is to extend the <code>coffee-module-etcd</code> module with Quarkus native runtime support.</p>
</div>
<div class="paragraph">
<p>The Quarkus native compiler (GraalVM) removes classes at build time that are not directly referenced.
This extension explicitly registers the classes referenced via reflection in the <code>coffee-module-etcd</code> module, to prevent them from being removed by the compiler.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
currently, version 3.2.x of Quarkus is used in the extensions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use this module, you should add the extension dependency instead of <code>coffee-module-etcd</code>, as it already includes the <code>coffee-module-etcd</code> module.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
        &lt;groupId&gt;hu.icellmobilsoft.coffee.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;coffee-module-etcd-extension&lt;/artifactId&gt;
        &lt;version&gt;${version.hu.icellmobilsoft.coffee}&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="common_coffee-quarkus-extensions-tool">5.4. coffee-tool-extension</h3>
<div class="paragraph">
<p>The purpose of this module is to extend the <code>coffee-tool</code> module with Quarkus native runtime support.</p>
</div>
<div class="paragraph">
<p>The Quarkus native compiler (GraalVM) removes classes at build time that are not directly referenced.
This extension explicitly registers the classes referenced via reflection in the <code>coffee-tool</code> module, to prevent them from being removed by the compiler.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
currently, version 3.2.x of Quarkus is used in the extensions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use this module, you should add the extension dependency instead of <code>coffee-tool</code>, as it already includes the <code>coffee-tool</code> module.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
        &lt;groupId&gt;hu.icellmobilsoft.coffee.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;coffee-tool-extension&lt;/artifactId&gt;
        &lt;version&gt;${version.hu.icellmobilsoft.coffee}&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="migration" class="sect0">Migration descriptions</h1>
<div class="paragraph">
<p>Older migration descriptions are available at
<a href="https://github.com/i-Cell-Mobilsoft-Open-Source/coffee/blob/master/docs/migration/v1/index.adoc">here</a></p>
</div>
<div class="sect1">
<h2 id="_v2_0_0">1. v2.0.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The major version jump was made from coff:ee v1.13.x,
later features may already differ between V1 and V2 versions.</p>
</div>
<div class="paragraph">
<p>coff:ee v1.13.x &#8594; v2.0.0 migration description, new features, changes</p>
</div>
<div class="sect2">
<h3 id="_changes">1.1. Changes</h3>
<div class="sect3">
<h4 id="_general_2">1.1.1. General</h4>
<div class="paragraph">
<p>This version aims to implement Jakarta EE 10,
which follows the change from java import javax.* &#8594; jakarta.* throughout the project.</p>
</div>
<div class="paragraph">
<p>Since almost all dependencies have been updated,
so listing them one by one is redundant.
Mostly cosmetic version changes, or EE10 implementations.</p>
</div>
<div class="paragraph">
<p>The content of the beans.xml files has been updated:</p>
</div>
<div class="listingblock">
<div class="title">beans.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="https://jakarta.ee/xml/ns/jakartaee"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="
      https://jakarta.ee/xml/ns/jakartaee
      https://jakarta.ee/xml/ns/jakartaee/beans_4_0.xsd"&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Include Jandex-maven-plugin on all modules.
Consolidated the use of classLoader across several modules, using Thread.currentThread().getContextClassLoader() everywhere except in the coffee-deltaspike module!</p>
</div>
<div class="sect4">
<h5 id="_bom_version_elevations">BOM version elevations:</h5>
<div class="paragraph">
<p>Major changes were:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>org.jboss.resteasy.resteasy-jaxrs 3.6.2.Final &#8594; org.jboss.resteasy.resteasy-core 6.2.1.Final - went through resteasy dependency breakdown,
this should be noted on projects</p>
</li>
<li>
<p>org.hibernate.hibernate-core 5.4.24.Final &#8594; 6.1.5.Final</p>
</li>
<li>
<p>org.apache.activemq.activemq-client 5.15.13 &#8594; org.apache.activemq.artemis-jakarta-client 2.27.0 - this is a big jump in drivers,
a lot of changes have been made.
You have to be very careful when implementing changes in projects.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dto">1.1.2. coffee-dto</h4>
<div class="ulist">
<ul>
<li>
<p>The jakarta conversion is <code>/coffee-dto-gen/src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/bindings.xjb</code>
file requires modification of the header:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;jaxb:bindings version="3.0"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:jaxb="https://jakarta.ee/xml/ns/jaxb"
    xmlns:xjc="http://java.sun.com/xml/ns/jaxb/xjc"
    xmlns:annox="http://annox.dev.java.net"
    jaxb:extensionBindingPrefixes="xjc annox"&gt;
...
&lt;/jaxb:bindings&gt;</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">IMPORTANT</dt>
<dd>
<p>In the JAXB 4.0 specification, the version of the jaxb xml schema, remains <code>3.0</code>!
<a href="https://jakarta.ee/specifications/xml-binding/4.0/">Jakarta XML Binding 4.0</a></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For XSD &#8594; DTO generation, the project uses a forked jaxb4 maven plugin:
<a href="https://github.com/phax/maven-jaxb2-plugin/tree/v016">phax/maven-jaxb2-plugin#v016</a>.
The plugin is a fork of the previously used jaxb2 plugin, a dependency swap is sufficient
<code>com.helger.maven:jaxb40-maven-plugin:0.16.0</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">WARNING</dt>
<dd>
<p>No jaxb3 or jaxb4 versions of the <code>org.jvnet.jaxb2_commons:jaxb2-basics-annotate</code> plugin are currently available,
In coffee, the earlier one works with the 4.0 plugin, but may cause problems in projects or later.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_deltaspike">1.1.3. coffee-deltaspike</h4>
<div class="paragraph">
<p>The coffee-deltaspike subproject has been created for this purpose,
to replace the functionality that was lost by dropping the deltaspike dependency
there is nothing to replace it with.
This could be a permanent solution, time will tell.</p>
</div>
<div class="paragraph">
<div class="title">coffee-deltaspike-message</div>
<p>Contains the classes responsible for the language,
1:1 correspondence to the solution used so far - at class name level.
The language is a "lite" copy of the original
(<a href="https://deltaspike.apache.org/documentation/core.html#Messagesandi18n" class="bare">https://deltaspike.apache.org/documentation/core.html#Messagesandi18n</a>),
without @MessageBundle and @MessageTemplate.
The MessageContext and Locale resolvers are completely as in the original.
The <code>DefaultMessageResolver</code> and the <code>DefaultMessageContext</code> are interleaved on several threads,
fixed via <code>DefaultMessageResolve</code>.</p>
</div>
<div class="paragraph">
<div class="title">coffee-deltaspike-data</div>
<p>Replaces the original
<a href="https://deltaspike.apache.org/documentation/data.html">deltaspike-data-module</a>
functionality, except for a few things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deactivating Repositories</p>
</li>
<li>
<p>Transactions</p>
</li>
<li>
<p>Multiple entityManager</p>
</li>
<li>
<p>Auditing</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Changes from the original deltaspike code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>EntityRepositoryHandler got a @Dependent annotation,
It is not yet known why it was not included.
It was originally on CriteriaSupportHandler for a similar purpose,
without it, <code>DelegateQueryBuilder.lookup</code> (line 111) could not find it
the correct server class for the <code>EntityRepository</code> interface.</p>
</li>
<li>
<p>The asm dependency has been removed, instead repository calls are made via dynamic proxies.</p>
</li>
<li>
<p>New extension <code>hu.icellmobilsoft.coffee.deltaspike.data.extension.RepositoryExtension</code> which handles repository interfaces and their associated proxies.
The extension&#8217;s job is to channel the resulting proxy calls to the central QueryHandler class.</p>
</li>
<li>
<p><code>QueryHandler</code> interface lookup has been partially changed due to the new proxies.
This is necessary in order to be able to use the processed repository metadata,
so it is not necessary to rewrite the deltaspike core logic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Migration</div>
<p>On implementing projects, possible deltaspike message and data dependency
should be replaced by the <code>coffee-deltaspike-message</code> and <code>coffee-deltaspike-data</code> dependency respectively.
The <code>org.apache.deltaspike.jpa.api.transaction.Transactional</code>
annotation is replaced by <code>hu.icellmobilsoft.coffee.jpa.annotation.Transactional</code>,
must be replaced everywhere.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest">1.1.4. coffee-rest</h4>
<div class="paragraph">
<div class="title">Project stage management</div>
<p>Deltaspike core after ejecting <code>org.apache.deltaspike.core.api.projectstage.ProjectStage</code>
was removed and replaced by <code>hu.icellmobilsoft.coffee.rest.projectstage.ProjectStage</code>.
It searches for the correct keys in all configs.</p>
</div>
<div class="paragraph">
<div class="title">Migration</div>
<p>Replace <code>org.apache.deltaspike.core.api.projectstage.ProjectStage</code> &#8594;
<code>hu.icellmobilsoft.coffee.rest.projectstage.ProjectStage</code> class.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_model_base_2">1.1.5. coffee-model-base</h4>
<div class="paragraph">
<p>The deltaspike data dependency has been removed.
The former deltaspike data CurrentUser has been replaced by
<code>hu.icellmobilsoft.coffee.model.base.annotation.CurrentUser</code> annotation. The AuditProvider, TimestampsProvider classes are replaced by the former deltaspike data
Instead of implementing the PrePersistAuditListener and PreUpdateAuditListener interfaces, they are implemented as methods with the java-like PrePersist and PreUpdate annotations
have been provided. The deltaspike AuditEntityListener has been removed from AbstractEntity, and the AbstractAuditEntity classes have been replaced by the following
annotation: @EntityListeners({ TimestampsProvider.class, AuditProvider.class }).</p>
</div>
<div class="paragraph">
<div class="title">Migration</div>
<p>Change the annotation of deltaspike data <code>org.apache.deltaspike.data.api.audit.CurrentUser</code> to <code>hu.icellmobilsoft.coffee.model.base.annotation.CurrentUser</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_jpa">1.1.6. coffee-jpa</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>deltaspike-jpa-module</code> has been discarded, it is no longer needed.</p>
</li>
<li>
<p>BatchService has been updated with the new features of hibernate 6, full type conversion.<br>
BatchService&#8217;s type handling itself has been rethought and handles the more problematic types separately.
For more information see <a href="#BatchService">BatchService</a>.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Migration</div>
<ul>
<li>
<p>Since hibernate 6 has rethought the type handling and coffee has done the same for BatchService,
so special attention must be paid to projects to ensure that all types in the entity work as expected.
If any methods are overwritten, they should be checked first,
if it works without the overrides.
This is important because the type changes in hibernate 6 itself and the re-thought BatchService type handling
brought a lot of new features and high type handling.
If you do need to override projects for whatever reason,
they will probably need to be updated.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_artemis">1.1.7. coffee-module-artemis</h4>
<div class="paragraph">
<p>The driver <em>jakarta EE 10</em> and the changes to <em>Jakarta Messaging 3.1</em> in it have changed a lot:
<a href="https://blogs.apache.org/activemq/entry/activemq-artemis-embraces-jakarta-ee">ActiveMQ Artemis embraces Jakarta EE</a>.</p>
</div>
<div class="paragraph">
<p>You should test the <strong>JmsHandler.createTextMessage</strong>
and <strong>JmsUtil.newJmsException</strong> functions,
where the change was specifically affected,
changed the original concept with delay messages.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_notification">1.1.8. coffee-module-notification</h4>
<div class="paragraph">
<p>Unfortunately there is no java-compatible release of the Apache commons-email dependency yet,
so the <code>coffee-module-notification</code> module has been removed from the coffee modules.
Next issue handles: <a href="https://issues.apache.org/jira/browse/EMAIL-203">EMAIL-203</a> or
<a href="https://github.com/apache/commons-email/pull/133">commons-email Gihub PR</a> pull request.</p>
</div>
<div class="paragraph">
<div class="title">Migration</div>
<p>coffee-module-notification module has been removed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_mp_opentracing">1.1.9. coffee-module-mp-opentracing</h4>
<div class="paragraph">
<p>Module has been optimized, so some classes (e.g. <code>OpenTraceExtension</code>) have become redundant.
The <code>@hu.icellmobilsoft.coffee.cdi.trace.annotation.Traced</code> annotation replaces all functions,
which can still be used to trace the individual modules of coffee.</p>
</div>
<div class="paragraph">
<div class="title">Migration</div>
<p>The former <code>@Traceable</code> annotation should be replaced by <code>@hu.icellmobilsoft.coffee.cdi.trace.annotation.Traced</code>
annotation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_junit_tests">1.1.10. junit tests</h4>
<div class="paragraph">
<p>Parameterized junit tests with <code>@ParameterizedTest</code> annotation
(e.g. <code>hu.icellmobilsoft.coffee.rest.projectstage.ProjectStageProducerTest</code>)
are annotated with <code>@ExplicitParamInjection</code>.
Without this, the CDI managed parameter injection will not work.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_csv">1.1.11. coffee-module-csv</h4>
<div class="paragraph">
<p>During csvUtil csv generation, the line separator was replaced: ICSVWriter.DEFAULT_LINE_END (\n) &#8594; System.lineSeparator().
Thus, an operating system dependent line separator is used.</p>
</div>
<div class="paragraph">
<div class="title">Migration</div>
<p>The changes do not result in any changeover work, it is backwards compatible.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_se_logging">1.1.12. coffee-se-logging</h4>
<div class="paragraph">
<p>In JbossMDCAdpater, there was an error in logging the parameter, which has been fixed.</p>
</div>
<div class="paragraph">
<div class="title">Migration</div>
<p>Changes do not result in migration work, backwards compatible.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coffee_module_etcd">1.2. coffee-module-etcd</h3>
<div class="ulist">
<ul>
<li>
<p>The CONNECT_TIMEOUT_MILLIS parameter has been introduced in <code>hu.icellmobilsoft.coffee.module.etcd.util.EtcdClientBuilderUtil</code>,
this prevents ramp-up timeout errors caused by a mismatch between the query and the timeout parameter to the etcd server.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration">Migration</h5>
<div class="paragraph">
<p>The changes do not result in any migration work, it is backwards compatible.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_0_0_v2_1_0">2. v2.0.0 → v2.1.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.0.0 &#8594; v2.1.0 migration description, news, changes</p>
</div>
<div class="sect2">
<h3 id="_whats_new">2.1. What&#8217;s new</h3>
<div class="paragraph">
<p>THe gRPC support has been introduced.
Thanks to this, a new subproject collector named <code>coffee-grpc</code> was created.</p>
</div>
<div class="sect3">
<h4 id="_coffee_grpc">2.1.1. coffee-grpc</h4>
<div class="paragraph">
<p>The following feature supports have been added to the system:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>coffee-grpc-api</code>: General gRPC handling for the Coff:ee API, including annotations and versioning.</p>
</li>
<li>
<p><code>coffee-grpc-base</code>: Collector of protobuf and gRPC stubs for general usage.</p>
</li>
<li>
<p><code>coffee-grpc-protoc</code>: Support for generating classes from proto files.</p>
</li>
<li>
<p><code>coffee-dto/coffee-dto-xsd2proto</code>: Generated proto files generated from the <code>coffee-dto-xsd</code> XSD files.</p>
</li>
<li>
<p><code>coffee-dto/coffee-dto-stub-gen</code>: Generated classes from Coff:ee proto files.</p>
</li>
<li>
<p><code>coffee-grpc-server-extension</code> - Support for CDI gRPC server implementation.</p>
</li>
<li>
<p><code>coffee-grpc-client-extension</code> - Support for CDI gRPC client implementation.</p>
</li>
<li>
<p><code>coffee-grpc-traces-api</code> - Coffee tracing API (annotations&#8230;&#8203;)</p>
</li>
<li>
<p><code>coffee-grpc-opentracing-impl</code> - gRPC <a href="https://github.com/eclipse/microprofile-opentracing">microprofile-opentracing</a> implementation</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_changes_2">2.2. Changes</h3>
<div class="ulist">
<ul>
<li>
<p>Bump com.google.guava:guava <a href="https://github.com/google/guava/releases/tag/v31.1">31.1-jre</a>
&#8594; <a href="https://github.com/google/guava/releases/tag/v32.1.1">32.1.1-jre</a>
(<a href="https://github.com/advisories/GHSA-7g45-4rm6-3mm3">CVE-2023-2976</a>)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_coffee_module_etcd_2">2.2.1. coffee-module-etcd</h4>
<div class="ulist">
<ul>
<li>
<p>Bump io.etcd:jetcd-core 0.6.1 &#8594; 0.7.5</p>
</li>
<li>
<p>In case of multiple classloaders, the <code>DefaultEtcdConfigImpl</code> class was unable to find the values defined in the microprofile-config.properties file.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_2">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_2">2.2.2. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p>An <code>OptimisticLockException</code> has been introduced, with the default error code <code>CoffeeFaultType.OPTIMISTIC_LOCK_EXCEPTION</code>.</p>
</li>
<li>
<p>The error handling in the <code>DefaultBaseExceptionMapper</code> class has been redesigned:</p>
</li>
<li>
<p>Business error - for BusinessException, a status code of 422 is given instead of the previous 500 status codes.</p>
</li>
<li>
<p>For a technical error - OptimisticLockException, a status code of 409 is given instead of the previous 500 status codes.</p>
</li>
<li>
<p><code>JsonMessageBodyReaderBase</code> uses the charset attribute coming in HTTP header <code>Content-Type</code> when deserializing the JSON request. Proper use of header: <code>Content-Type: application/json; charset=utf-8</code>. If charset is not specified the deserialization uses UTF-8 by default!</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_3">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>To keep the exception status code handling as before, it is necessary to create a separate ExceptionMapper on projects.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_mp_restclient">2.2.3. coffee-module-mp-restclient</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>DefaultBaseExceptionResponseExceptionMapper</code> sets the HTTP status code in the <code>RestClientResponseException</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_4">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_tool">2.2.4. coffee-tool</h4>
<div class="ulist">
<ul>
<li>
<p>NPE fix in AnnotationUtil.getAnnotation(Class&lt;?&gt; clazz, Class&lt;A&gt; annotationClass) method</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_5">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_jpa_2">2.2.5. coffee-jpa</h4>
<div class="ulist">
<ul>
<li>
<p>NoSuchMethodException fix in JPAUtil.toNativeSQL(NoEx) which has been caused by the hibernate 6.x upgrade.</p>
</li>
<li>
<p>Possible integer-overflow fix in PagingUtil.getPagingResult* methods. XSD validation and some internal checks have been added.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_6">Migration</h5>
<div class="paragraph">
<p>PagingUtil methods may throw BaseException from now on, which may need to be handled in the calling application. (though probably not necessary)</p>
</div>
<div class="paragraph">
<p>The rest of changes are backwards compatible and doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_batchservice">2.2.6. BatchService</h4>
<div class="ulist">
<ul>
<li>
<p>Even the native insert/update methods (batchMergeNative, batchInsertNative, batchUpdateNative) take the insertable and updateable flags into account.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_7">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_cdi">2.2.7. coffee-cdi</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>hu.icellmobilsoft.coffee.cdi.trace.constants.Tags</code> has received new values for passing relational database trace data.</p>
</li>
<li>
<p>New package for modularizing tracing operations, <code>hu.icellmobilsoft.coffee.cdi.trace.spi</code></p>
</li>
<li>
<p><code>IOpenTraceHandler</code> Enables the integration of dynamic tracing implementation.</p>
</li>
<li>
<p><code>OpenTraceHandlerProducer</code> Provides the activated tracing module and gives default behavior if no tracing module is plugged in.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_8">Migration</h5>
<div class="paragraph">
<p>The changes do not result in any migration work, it is backwards compatible.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_deltaspike_data">2.2.8. coffee-deltaspike-data</h4>
<div class="ulist">
<ul>
<li>
<p>The repository layer received dynamic trace handling, provided that the tracing module is active.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_9">Migration</h5>
<div class="paragraph">
<p>The changes do not result in any migration work, it is backwards compatible.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_mp_opentracing_2">2.2.9. coffee-module-mp-opentracing</h4>
<div class="ulist">
<ul>
<li>
<p><code>OpenTraceHandler</code> Facilitates the placement of modules into the trace flow where reliance on the existing OpenTraceInterceptor is not possible.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_10">Migration</h5>
<div class="paragraph">
<p>The changes do not result in any migration work, it is backwards compatible.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_1_0_v2_2_0">3. v2.1.0 → v2.2.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.1.0 &#8594; v2.2.0 migration description, news, changes</p>
</div>
<div class="sect2">
<h3 id="_whats_new_2">3.1. What&#8217;s new</h3>
<div class="sect3">
<h4 id="_coffee_tool_2">3.1.1. coffee-tool</h4>
<div class="ulist">
<ul>
<li>
<p>JsonUtil is able to deserialize generic types as well.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_11">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_jpa_3">3.1.2. coffee-jpa</h4>
<div class="ulist">
<ul>
<li>
<p>microprofile-health support</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_12">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_redis_2">3.1.3. coffee-module-redis</h4>
<div class="ulist">
<ul>
<li>
<p>microprofile-health support</p>
</li>
<li>
<p>Jedis connection metrics support</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_13">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_etcd_3">3.1.4. coffee-module-etcd</h4>
<div class="ulist">
<ul>
<li>
<p>microprofile-health support</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_14">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_base">3.1.5. coffee-module-base</h4>
<div class="ulist">
<ul>
<li>
<p>The ClassFieldsAndMethodsCache caused a ConcurrentModificationException error under high load.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_15">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_2_0_v2_3_0">4. v2.2.0 → v2.3.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.2.0 &#8594; v2.3.0 migration description, news, changes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java 21 support - Coffee runs on Java 21 and is now supported with CI.</p>
</li>
<li>
<p>Bump parent pom 1.2.0 &#8594; 1.4.0 - maven plugin versions updated</p>
</li>
<li>
<p>The project assumes that <code>beans.xml</code> is set to the default <code>bean-discovery-mode="annotated"</code>.
Therefore, we have removed all "@Vetoed" comments from previously managed classes.</p>
</li>
<li>
<p>The Javadoc was updated with the introduction of "default constructors",
which was published at: <a href="https://bugs.openjdk.org/browse/JDK-8071961">java 16</a>
and <a href="https://bugs.openjdk.org/browse/JDK-8249634">java 18</a>
with new functions.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_coffee_model_base_3">4.1. coffee-model-base</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>AbstractEntity.toString()</code> function uses the type of the column instead of the value in case of <code>java.sql.Blob</code> and <code>java.sql.Clob</code>.
It used the value of the field in such cases, for e.g. it read the stream in case of logging.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_16">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_tool_3">4.2. coffee-tool</h4>
<div class="ulist">
<ul>
<li>
<p>New <code>ParamValidatorUtil</code> helper class for uniform validation of parameters of public functions.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_17">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_etcd_4">4.3. coffee-module-etcd</h4>
<div class="ulist">
<ul>
<li>
<p>The configuration parameters for establishing the ETCD connection used in EtcdClientBuilder have been extracted as microprofile-config parameters.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_18">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_3_0_v2_4_0">5. v2.3.0 → v2.4.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.3.0 &#8594; v2.4.0 migration description, news, changes</p>
</div>
<div class="sect3">
<h4 id="_coffee_rest_3">5.1. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p><strong>RequestResponseLogger memory tuning</strong>: Based on the <code>hu.icellmobilsoft.coffee.rest.log.BaseRestLogger</code> class an optimized version was created: <a href="#common_core_coffee-rest_optimized_BaseRestLogger">hu.icellmobilsoft.coffee.rest.log.optimized.BaseRestLogger</a>. With its help applications use less memory while logging request and response bodies.
In addition, the <code>hu.icellmobilsoft.coffee.rest.log.optimized.RequestResponseLogger</code> class was created as well (Temporarily with the <code>@Named("optimized_RequestResponseLogger")</code> annotation. This way we keep the old implementation which will be removed later), based on the <code>hu.icellmobilsoft.coffee.rest.log.RequestResponseLogger</code>, where the request and response entity log limits are determined according to whether the request or response entity is <code>application/octet-stream</code> or <code>multipart/form-data</code> and the REST interface is not annotated with the LogSpecifier then we limit the log size.
Also, in this version, the <code>BYTECODE_MAX_LOG</code> constant has been renamed to <code>ENTITY_MAX_LOG</code>.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_19">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>When switching to the optimized <code>BaseRestLogger</code>, it is advisable to switch to the <code>ENTITY_MAX_LOG</code> constant instead of <code>BYTECODE_MAX_LOG</code>, if it is used, as the former may be deleted over time.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_4_0_v2_5_0">6. v2.4.0 → v2.5.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.4.0 &#8594; v2.5.0 migration description, news, changes</p>
</div>
<div class="sect2">
<h3 id="_global">6.1. Global</h3>
<div class="ulist">
<ul>
<li>
<p>jandex-maven-plugin - test classes were excluded from indexing</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_metric_independency">6.2. Metric independency</h3>
<div class="paragraph">
<p>Development involving several modules,
the goal of which is to implement metrics with several types be able to function.</p>
</div>
<div class="sect3">
<h4 id="_coffee_jpa_coffee_module_redis">6.2.1. coffee-jpa &amp; coffee-module-redis</h4>
<div class="ulist">
<ul>
<li>
<p>The modules were independent from the metric implementation,
you can freely choose between microprofile-metrics or micrometer</p>
</li>
<li>
<p>moved <code>hu.icellmobilsoft.coffee.jpa.health.DatabaseHealthConstant.DEFAULT_DATASOURCE_NAME</code> &#8594;
<code>hu.icellmobilsoft.coffee.cdi.config.IConfigKey.DATASOURCE_DEFAULT_NAME_VALUE</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_20">Migration</h5>
<div class="paragraph">
<p>At the dependency level, you need to choose the metric implementation
that the service should use.
Otherwise, everything else is backward compatible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-redis&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-micrometer&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/dependency&gt;
&lt;!-- or --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-metrics&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Micrometer metric implementation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Microprofile-metrics metric implementation</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_metrics_impl">6.2.2. coffee-grpc-metrics-impl</h4>
<div class="paragraph">
<p>Renames coffee-grpc-metrics-impl &#8594; coffee-grpc-metrics-mpmetrics</p>
</div>
<div class="sect4">
<h5 id="_migration_21">Migration</h5>
<div class="paragraph">
<p>Without rename changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_developments">6.3. Other developments</h3>
<div class="sect3">
<h4 id="_coffee_tool_4">6.3.1. coffee-tool</h4>
<div class="ulist">
<ul>
<li>
<p>Added tool class for "AES/CBC/PKCS5PADDING" de/cipher
(<code>hu.icellmobilsoft.coffee.tool.utils.crypto.AesCbcCryptoUtil</code>)</p>
</li>
<li>
<p>Added SHA3-512 message digest to <code>hu.icellmobilsoft.coffee.tool.utils.string.EncodeUtil</code> class,
deprecating old <code>Sha512(String str)</code>.</p>
</li>
<li>
<p>In MavenURLHandler class, fix getting resource over class to current thread-based getting</p>
</li>
<li>
<p>The <code>ResponseEntityCollectorOutputStream</code> has been modified. Previously, it stored characters represented by multiple bytes (e.g., UTF-8 Hungarian accented characters) by casting them to char, which could result in incorrect text. From now on, we store them as bytes. It is the responsibility of the caller to use the appropriate character encoding when converting these bytes into text.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_22">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_redisstream">6.3.2. coffee-module-redisstream</h4>
<div class="ulist">
<ul>
<li>
<p>The Redis consumers received functionality to assist graceful shutdown
(<code>hu.icellmobilsoft.coffee.module.redisstream.bootstrap.ConsumerLifeCycleManager</code>)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_23">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_4">6.3.3. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p>If version is not defined in the validateXMLs annotation, it won&#8217;t attempt to read the requestVersion from the request body.</p>
</li>
<li>
<p>The <code>hu.icellmobilsoft.coffee.rest.validation.xml.annotation.ValidateXML</code> and <code>hu.icellmobilsoft.coffee.rest.validation.xml.annotation.ValidateXMLs</code> annotations are moved to the coffee-cdi module.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_24">Migration</h5>
<div class="paragraph">
<p>As a result of the move, if these annotations are also used on the usage project, the imports must be updated:</p>
</div>
<div class="paragraph">
<p><code>hu.icellmobilsoft.coffee.rest.validation.xml.annotation.ValidateXML</code> &#8594; <code>hu.icellmobilsoft.coffee.cdi.annotation.xml.ValidateXML</code>
<code>hu.icellmobilsoft.coffee.rest.validation.xml.annotation.ValidateXMLs</code> &#8594; <code>hu.icellmobilsoft.coffee.cdi.annotation.xml.ValidateXMLs</code></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_etcd_5">6.3.4. coffee-module-etcd</h4>
<div class="ulist">
<ul>
<li>
<p>Removed classes and methods annotated with <code>@Deprecated(since = "1.3.0", forRemoval = true)</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_25">Migration</h5>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.module.etcd.service.BaseEtcdService</code> removed.
Its full-fledged replacement is the <code>hu.icellmobilsoft.coffee.module.etcd.service.EtcdService</code> class,
which works explicitly with String values.</p>
</li>
<li>
<p>Method <code>getList()</code> has been removed from <code>hu.icellmobilsoft.coffee.module.etcd.service.ConfigEtcdService</code>. Use the compatible <code>getAll()</code> method.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_jpa_4">6.3.5. coffee-jpa</h4>
<div class="ulist">
<ul>
<li>
<p>Added <code>@Dependent</code> annotation to <code>hu.icellmobilsoft.coffee.jpa.sql.batch.BatchService</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_26">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_configdoc">6.3.6. coffee-module-configdoc</h4>
<div class="ulist">
<ul>
<li>
<p>Nullpointer thrown during compile time when javadoc was missing before annotation <code>@ConfigDoc</code>.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_27">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_mp_restclient_2">6.3.7. coffee-module-mp-restclient</h4>
<div class="ulist">
<ul>
<li>
<p>FaultTypeParserExtension has been modified, it looks for FaultType enums annotated with <code>@hu.icellmobilsoft.coffee.cdi.annotation.FaultTypeCode</code>.</p>
</li>
<li>
<p>IFaultType interface marked as deprecated. (Use the <code>@FaultTypeCode</code> instead)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_28">Migration</h5>
<div class="paragraph">
<p>If you have a FaultType enum in your project, annotate it with the <code>@FaultTypeCode</code> annotation and remove the <code>IFaultType</code> interface. <code>beans.xml</code> must be existed in the META-INF directory!</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trace_detachment">6.4. Trace detachment</h3>
<div class="paragraph">
<p>Development involving multiple modules with the aim of enabling tracing to work with various implementations.</p>
</div>
<div class="sect3">
<h4 id="_coffee_cdi_2">6.4.1. coffee-cdi</h4>
<div class="ulist">
<ul>
<li>
<p>Renaming hu.icellmobilsoft.coffee.cdi.trace.constants.Tags to hu.icellmobilsoft.coffee.cdi.trace.constants.SpanAttribute</p>
</li>
<li>
<p>Received basic OpenTelemetry standard constants.</p>
</li>
<li>
<p>The @Traced annotation provides trace with the default INTERNAL kind type if not specified when using the annotation.</p>
</li>
<li>
<p>Renaming hu.icellmobilsoft.coffee.cdi.trace.spi.IOpenTraceHandler to hu.icellmobilsoft.coffee.cdi.trace.spi.ITraceHandler</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_29">Migration</h5>
<div class="paragraph">
<p>At the dependency level, you need to choose which tracing implementation the service should use; otherwise, everything else is backward compatible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-opentracing&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/dependency&gt;
&lt;!-- or --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-mp-telemetry&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>microprofile-opentracing implementation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>microprofile-telemetry implementation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the values of <code>hu.icellmobilsoft.coffee.cdi.trace.constants.Tags</code> were used, you can find the constants in the <code>hu.icellmobilsoft.coffee.cdi.trace.constants.SpanAttribute</code> class instead.</p>
</div>
<div class="paragraph">
<p>You should inject <code>ITraceHandler</code> instead of <code>IOpenTraceHandler</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_opentracing_impl">6.4.2. coffee-grpc-opentracing-impl</h4>
<div class="ulist">
<ul>
<li>
<p>Rename coffee-grpc-opentracing-impl to coffee-grpc-traces-mpopentracing</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_30">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>Use the dependency coffee-grpc-tracing-opentracing instead of coffee-grpc-opentracing-impl</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_traces_api">6.4.3. coffee-grpc-traces-api</h4>
<div class="ulist">
<ul>
<li>
<p><code>ITracesInterceptor</code> has been discontinued for simpler interceptor search.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_31">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>When creating a custom interceptor, use the built-in <code>io.grpc.ServerInterceptor</code> instead of <code>ITracesInterceptor</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_mongodb">6.4.4. coffee-module-mongodb</h4>
<div class="ulist">
<ul>
<li>
<p>Removed classes and method annotated with <code>@Deprecated(forRemoval = true, since = "1.1.0")</code></p>
</li>
<li>
<p>Removed unimplemented and unused method: <code>hu.icellmobilsoft.coffee.module.mongodb.service.MongoService#getMongoCollectionName()</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_32">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>Instead of <code>hu.icellmobilsoft.coffee.module.mongodb.annotation.MongoConfiguration</code> use: <code>hu.icellmobilsoft.coffee.module.mongodb.extension.MongoClientConfiguration</code></p>
</li>
<li>
<p>Instead of <code>hu.icellmobilsoft.coffee.module.mongodb.config.MongoDbConfig</code> use: <code>hu.icellmobilsoft.coffee.module.mongodb.extension.MongoConfigHelper</code></p>
</li>
<li>
<p>Instead of <code>hu.icellmobilsoft.coffee.module.mongodb.config.MongoDbConfigImpl</code> use: <code>hu.icellmobilsoft.coffee.module.mongodb.extension.MongoClientConfiguration</code></p>
</li>
<li>
<p>Instead of <code>hu.icellmobilsoft.coffee.module.mongodb.handler.MongoDbHandler</code> use: <code>hu.icellmobilsoft.coffee.module.mongodb.extension.MongoDbClient</code></p>
</li>
<li>
<p>Instead of <code>hu.icellmobilsoft.coffee.module.mongodb.producer.MongoFactory</code> use: <code>hu.icellmobilsoft.coffee.module.mongodb.extension.MongoDbClientFactory</code></p>
</li>
<li>
<p>Instead of <code>hu.icellmobilsoft.coffee.module.mongodb.service.MongoServiceImpl</code> use: <code>hu.icellmobilsoft.coffee.module.mongodb.extension.MongoDbClient</code></p>
</li>
<li>
<p>Instead of <code>hu.icellmobilsoft.coffee.module.mongodb.service.MongoService#getMongoCollection()</code> use: <code>hu.icellmobilsoft.coffee.module.mongodb.extension.MongoDbClient#initRepositoryCollection(java.lang.String)</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_5_0_v2_6_0">7. v2.5.0 → v2.6.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.5.0 &#8594; v2.6.0 migration description, news, changes</p>
</div>
<div class="sect2">
<h3 id="_global_2">7.1. Global</h3>
<div class="sect3">
<h4 id="_coffee_bom">7.1.1. Coffee BOM</h4>
<div class="paragraph">
<p>💥 <strong><strong>BREAKING CHANGE</strong></strong> 💥</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">Global change that coffee-bom was used to import coffee dependency on projects. This has been changed to coffee-bom-project.

You then need to import the project elements as follows:

&lt;dependencyManagement&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
        &lt;artifactId&gt;coffee-bom-project&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;version&gt;${version.hu.icellmobilsoft.coffee}&lt;/version&gt;
        &lt;type&gt;pom&lt;/type&gt;
        &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencyManagement&gt;

This also means that the transitive dependencies that were previously put on projects from coffee-bom, are now removed.
Because of this, these dependencies will be reported as not found by maven, so they will need to be defined in the project using coffee.</code></pre>
</div>
</div>
<div class="paragraph">
<p>coffee-bom &#8594; coffee-bom-project -re változott</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jandex index config fix.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_hibernate">7.1.2. Hibernate</h4>
<div class="ulist">
<ul>
<li>
<p>Bump hibernate-core <a href="https://github.com/hibernate/hibernate-orm/releases/tag/6.1.5">6.1.5.Final</a> &#8594; <a href="https://github.com/hibernate/hibernate-orm/releases/tag/6.2.13">6.2.13.Final</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_33">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>It is necessary to read the <a href="https://github.com/hibernate/hibernate-orm/blob/6.2/migration-guide.adoc">Hibernate 6.2.x migration documentation</a> and update the affected parts of the project.</p>
</li>
<li>
<p>The <a href="https://github.com/hibernate/hibernate-orm/blob/6.2/migration-guide.adoc#timezone-and-offset-storage">Timezone and offset storage</a> now default to <code>DEFAULT</code>, therefore the time zones are also saved.
Since we haven&#8217;t saved the time zone so far and the <code>BatchService</code> is also designed not to save, this is causing us problems.
To ensure that no time zones are saved, it is necessary to include the following property in <code>persistence.xml</code>: <code>&lt;property name="hibernate.timezone.default_storage" value="NORMALIZE"/&gt;</code>.</p>
</li>
<li>
<p>The <a href="https://github.com/hibernate/hibernate-orm/blob/6.2/migration-guide.adoc#bytecharacter-mapping-changes">Byte[] and Character[] types mapping changed</a>.
The Byte[] types were handled until now, but due to hibernate changes, one of the following is required:</p>
<div class="ulist">
<ul>
<li>
<p>Replace Byte[] with byte[]</p>
</li>
<li>
<p>For the old behavior, it is necessary to enable the legacy array processing in the <code>persistence.xml</code> with the following property: <code>&lt;property name="hibernate.type.wrapper_array_handling" value="legacy"/&gt;</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_changes_3">7.2. Changes</h3>
<div class="sect3">
<h4 id="_coffee_jpa_5">7.2.1. coffee-jpa</h4>
<div class="sect4">
<h5 id="_batchservice_2">BatchService</h5>
<div class="ulist">
<ul>
<li>
<p>Based on the Hibernate 6.2.x changes, the <code>Insert</code>, <code>Update</code> and <code>Delete</code> SQL statements have been updated.</p>
</li>
<li>
<p>Since Hibernate 6.2.x, the EnumType is deprecated, because they are processing enum values differently, so the handling of the EnumType in <code>BatchService</code> has been deleted.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_migration_34">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
<div class="sect4">
<h5 id="_jpautil">JpaUtil</h5>
<div class="ulist">
<ul>
<li>
<p>Since Hibernate 6.2.x, the <code>JdbcSelect</code> class was renamed to <code>JdbcOperationQuerySelect</code>, and the <code>getSql()</code> method used from it to  <code>getSqlString()</code>, so we updated the <code>JpaUtil</code> with these changes.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_migration_35">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transactional_annotation">Transactional annotation</h5>
<div class="paragraph">
<p>In the  <code>hu.icellmobilsoft.coffee.jpa.annotation.Transactional</code> annotation the annotation @Stereotype has been removed and in @Target the annotation ElementType.TYPE too.</p>
</div>
</div>
<div class="sect4">
<h5 id="_migration_36">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_5">7.2.2. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p>fix javax.annotation.processing.Processor file (rename back to javax.annotation.processing.Processor, because it hasn&#8217;t changed to javax)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_requestversionreader">RequestVersionReader</h5>
<div class="paragraph">
<p>RequestVersionReader has been rewritten. The stream mark() and reset() may have caused errors in some cases.</p>
</div>
</div>
<div class="sect4">
<h5 id="_migration_37">Migration</h5>
<div class="paragraph">
<p><code>IXmlRequestVersionReader</code> and <code>IJsonRequestVersionReader</code> have been removed, in case you used it update the interface to <code>IRequestVersionReader</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_jsonb_config">Jsonb Config</h5>
<div class="paragraph">
<p>Added the definition of the Jsonb configuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="_migration_38">Migration</h5>
<div class="paragraph">
<p>The changes do not result in migration work, backwards default values are set for correct usage.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_mp_restclient_3">7.2.3. coffee-module-mp-restclient</h4>
<div class="sect4">
<h5 id="_jsonb_config_2">Jsonb Config</h5>
<div class="paragraph">
<p>Added the definition of the Jsonb configuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="_migration_39">Migration</h5>
<div class="paragraph">
<p>The changes do not result in migration work, backwards default values are set for correct usage.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_quarkus_extensions">7.2.4. Coffee Quarkus Extensions</h4>
<div class="paragraph">
<p>A new module called Coffee Quarkus extension has been created, which adds other elements needed for Quarkus to some of the coffee modules.
First element is coffee-module-mp-restclient-extension
Second element is coffee-deltaspike-data-extension</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_deltaspike_message">7.2.5. coffee-deltaspike-message</h4>
<div class="ulist">
<ul>
<li>
<p>Changed the pacakage of <code>org.apache.deltaspike.core.util</code> to <code>org.apache.deltaspike.core.util.message</code>, since 2 separate modules have the same original package, which is sensitived by Quarkus.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_40">Migration</h5>
<div class="ulist">
<ul>
<li>
<p><code>org.apache.deltaspike.core.util.ClassUtils</code> &#8594; <code>org.apache.deltaspike.core.util.message.ClassUtils</code></p>
</li>
<li>
<p><code>org.apache.deltaspike.core.util.PropertyFileUtils</code> &#8594; <code>org.apache.deltaspike.core.util.message.PropertyFileUtils</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_coffee_module_csv_2">coffee-module-csv</h5>
<div class="paragraph">
<p>Added new methods for changing the csv format. For example csv separator, escape char.</p>
</div>
</div>
<div class="sect4">
<h5 id="_migration_41">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_model_base_4">7.2.6. coffee-model-base</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>AbstractEntity.toString()</code> function uses the type of the property instead of the value in case of <code>java.io.InputStream</code>, <code>java.io.OutputStream</code>, <code>java.io.Reader</code> and <code>java.io.Writer</code>.
It used the value of the property in such cases, for e.g. it read the stream in case of logging.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_42">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_6">7.2.7. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>XsdHelper</code> provides the opportunity to delete the schema and JAXB context cache.</p>
</li>
<li>
<p><code>EmptyRequestVersionReader</code> now has Dependent scope, so Quarkus bean discovery will now be able to find it.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_43">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_redisstream_2">7.2.8. coffee-module-redisstream</h4>
<div class="sect4">
<h5 id="_consumerlifecyclemanager">ConsumerLifeCycleManager</h5>
<div class="ulist">
<ul>
<li>
<p>If the <code>ConsumerLifeCycleManager.CONSUMER_COUNTER</code> less than one, the <code>ConsumerLifeCycleManager.SEMAPHORE.acquire();</code> call will be skipped in the <code>ConsumerLifeCycleManager.stop()</code> method so in those cases where the container didn&#8217;t contain any consumer, for e.g. in tests, the shutdown phase won&#8217;t be stacked.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_migration_44">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_6_0_v2_7_0">8. v2.6.0 → v2.7.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.6.0 &#8594; v2.7.0 migration description, news, changes</p>
</div>
<div class="sect2">
<h3 id="_global_3">8.1. Global</h3>
<div class="sect3">
<h4 id="_coffee_se_api">8.1.1. coffee-se-api</h4>
<div class="paragraph">
<p>A new module that defines a basic Coffee API such as enums, DTOs, exceptions, which can only have Java SE dependencies.</p>
</div>
<div class="paragraph">
<p>Contents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.se.api.exception.BaseException</code> (based on <code>hu.icellmobilsoft.coffee.dto.exception.BaseException</code>)</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.api.exception.enums.Severity</code> (based on <code>hu.icellmobilsoft.coffee.dto.exception.enums.Severity</code>)</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.api.exception.BusinessException</code> (based on <code>hu.icellmobilsoft.coffee.dto.exception.BusinessException</code>)</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.api.exception.DtoConversionException</code> (based on <code>hu.icellmobilsoft.coffee.dto.exception.DtoConversionException</code>)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_se_function">8.1.2. coffee-se-function</h4>
<div class="paragraph">
<p>A new module which contains functional interfaces used in Coffee, which can only have Java SE and such Coffee modules that
can also only have Java SE dependencies.</p>
</div>
<div class="paragraph">
<p>Contents: (based on <code>hu.icellmobilsoft.coffee.tool.common.FunctionalInterfaces</code>, but declares the new
<code>hu.icellmobilsoft.coffee.se.api.exception.BaseException</code>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionConsumer</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionFunction</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionFunction2</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionFunction3</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionFunction4</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionFunction5</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionFunction6</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionRunner</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.se.function.BaseExceptionSupplier</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_tool_5">8.1.3. coffee-tool</h4>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.tool.common.FunctionalInterfaces</code> has become deprecated. The wrapped functional interfaces
extends the new interfaces declared in <code>coffee-se-function</code> module.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_45">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration. However, if a new functional interface
implemented, then the new <code>hu.icellmobilsoft.coffee.se.api.exception.BaseException</code> must be handled in the given locations
e.g. exception mappers, type checks like <code>e instanceof BaseException</code>, try-catch blocks.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dto_base_2">8.1.4. coffee-dto-base</h4>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.dto.exception.enums.Severity</code> has become deprecated.</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.dto.exception.BaseException</code> has become deprecated.</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.dto.exception.BusinessException</code> has become deprecated.</p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.dto.exception.DtoConversionException</code> has become deprecated.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_46">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>The <code>hu.icellmobilsoft.coffee.se.api.exception.enums.Severity</code> enum defined in the <code>coffee-se-api</code> module should be used
instead of the old <code>hu.icellmobilsoft.coffee.dto.exception.enums.Severity</code>.</p>
</li>
<li>
<p>Deprecated Exceptions are replaced with <code>hu.icellmobilsoft.coffee.se.api.exception.*</code>
package (<code>hu.icellmobilsoft.coffee.dto.exception.BaseException</code> &#8594;
<code>hu.icellmobilsoft.coffee.se.api.exception.BaseException</code>).</p>
<div class="ulist">
<ul>
<li>
<p>The original <code>getSeverity()</code> function returns with the new <code>hu.icellmobilsoft.coffee.se.api.exception.enums.Severity</code> type.
Use the <code>getOldSeverity()</code> function to get the original type.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_cdi_3">8.1.5. coffee-cdi</h4>
<div class="paragraph">
<p>💥 <strong><strong>BREAKING CHANGE</strong></strong> 💥</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.cdi.trace.spi.ITraceHandler</code> changes:</p>
<div class="ulist">
<ul>
<li>
<p>The <code>runWithTrace()</code> function has been renamed to <code>runWithTraceNoException()</code>, which expects
<code>java.util.function.Supplier</code> or <code>java.lang.Runnable</code> as an argument. Functions traced in this way can only throw RTE.</p>
</li>
<li>
<p>The original <code>runWithTrace()</code> function&#8217;s argument is replaced to
<code>hu.icellmobilsoft.coffee.se.function.BaseExceptionSupplier</code> or <code>hu.icellmobilsoft.coffee.se.function.BaseExceptionRunner</code>,
which can throw <code>hu.icellmobilsoft.coffee.se.api.exception.BaseException</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_47">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>The original <code>ITraceHandler.runWithTrace()</code> calls must handle the new <code>hu.icellmobilsoft.coffee.se.api.exception.BaseException</code>.</p>
</li>
<li>
<p>If we trace a function that can only throw RTE, then we must use the <code>runWithTraceNoException()</code> function.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_7">8.1.6. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p>The classes found in the <code>hu.icellmobilsoft.coffee.rest.exception</code> package use the new <code>hu.icellmobilsoft.coffee.se.api.exception.BaseException</code>.
Such as <code>DefaultBaseExceptionMapper</code>, <code>DefaultExceptionMessageTranslator</code>, <code>DefaultGeneralExceptionMapper</code> and <code>IExceptionMessageTranslator</code>.</p>
</li>
<li>
<p>The <code>hu.icellmobilsoft.coffee.rest.log.optimized.BaseRestLogger</code> has been improved so the HTTP GET calls are logged now.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_48">Migration</h5>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.ws.rs.ext.ExceptionMapper</code> and <code>hu.icellmobilsoft.coffee.rest.exception.IExceptionMessageTranslator</code>
implementations must use the new <code>hu.icellmobilsoft.coffee.se.api.exception.BaseException</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_2">8.1.7. coffee-grpc</h4>
<div class="ulist">
<ul>
<li>
<p>New <code>hu.icellmobilsoft.coffee.grpc.base.converter.ProtoConverter</code> interface,
which support anyDto &#8592;&#8594; protoDto conversion</p>
</li>
<li>
<p>New util class for support proto date conversion
(<code>hu.icellmobilsoft.coffee.grpc.base.util.ProtoDateUtil</code>)</p>
</li>
<li>
<p>Improved <code>hu.icellmobilsoft.coffee.grpc.server.interceptor.ServerRequestInterceptor</code>
and <code>hu.icellmobilsoft.coffee.grpc.server.interceptor.ServerResponseInterceptor</code> logging interceptors,
which can be parameterized with <code>@LogSpecifiers</code> and <code>@LogSpecifier</code> annotations.</p>
</li>
<li>
<p>Improved <code>hu.icellmobilsoft.coffee.grpc.server.interceptor.ErrorHandlerInterceptor</code>
now can handle additional error information into Grpc response:</p>
<div class="ulist">
<ul>
<li>
<p>Business error code (FaultType)</p>
</li>
<li>
<p>Translated error code</p>
</li>
<li>
<p>Debug information (stacktrace)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Expanded <code>coffee-grpc-client-extension</code> module:</p>
<div class="ulist">
<ul>
<li>
<p>Bugfix in <code>GrpcClientExtension</code> to only produce virtual beans for clients of type <code>AbstractBlockingStub</code>.</p>
</li>
<li>
<p><code>GrpcClientConfig</code> extended with the <code>maxInboundMetadataSize</code> parameter,
which serves to set the size of incoming grpc headers in the possible response
(for example, due to the size of debug information).</p>
</li>
<li>
<p>New <code>GrpcClienResponseException</code> which handles coffee Grpc server error response</p>
</li>
<li>
<p>New <code>GrpcClientHeaderHelper</code> which handles sending Grpc message header</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_49">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_redis_3">8.1.8. coffee-module-redis</h4>
<div class="ulist">
<ul>
<li>
<p>Jedis driver version bump 4.2.3 &#8594; 5.1.2</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The new version supports redis from version 6.0!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_migration_50">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module">8.1.9. coffee-module</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>@ConfigDoc</code> annotation got two new parameters(optionals), <code>isStartupParam</code> and <code>isRuntimeOverridable</code>.
In the generated table there is a new column named <code>Features</code>. In this column we can see each of the new parameters represented as emojis in the case of <code>true</code> value(default is false).</p>
<div class="ulist">
<ul>
<li>
<p>For <code>isStartupParam</code> true the emoji is: 🚀</p>
</li>
<li>
<p>For <code>isRuntimeOverridable</code> true the emoji is: ⏳</p>
</li>
</ul>
</div>
</li>
<li>
<p>The <code>@ConfigDoc</code> annotation got two new parameters(optionals), <code>title</code> and <code>titleHeadingLevel</code>.
these two give the possibility of overwriting the generated table names if we don&#8217;t want to use the default with the <code>title</code> parameter and we can set it&#8217;s heading level with the <code>titleHeadingLevel</code> parameter.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_51">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>Changes are backwards compatible doesn&#8217;t need any migration, although it is now possible to use these three new parameters in the <code>@ConfigDoc</code> annotation.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_model">8.1.10. coffee-model</h4>
<div class="ulist">
<ul>
<li>
<p>The TimestampsProvider got a new parameter which can be set as an ENV variable for manipulating the timezone(optional).</p>
<div class="ulist">
<ul>
<li>
<p><code>COFFEE_MODEL_BASE_JAVA_TIME_TIMEZONE_ID</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_52">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_deltaspike_data_2">8.1.11. coffee-deltaspike-data</h4>
<div class="ulist">
<ul>
<li>
<p>Tracing has been added to <code>org.apache.deltaspike.data.impl.builder.MethodQueryBuilder</code>.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_53">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_7_0_v2_8_0">9. v2.7.0 → v2.8.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.7.0 &#8594; v2.8.0 migration description, news, changes</p>
</div>
<div class="sect2">
<h3 id="_global_4">9.1. Global</h3>
<div class="paragraph">
<p>Dependency replacement: <code>org.hibernate:hibernate-core</code> &#8594; <code>org.hibernate.orm:hibernate-core</code> (the former artifact was just a proxy).</p>
</div>
<div class="sect3">
<h4 id="_coffee_jpa_6">9.1.1. coffee-jpa</h4>
<div class="paragraph">
<p>💥 <strong><strong>BREAKING CHANGE</strong></strong> 💥</p>
</div>
<div class="paragraph">
<p>The <code>hu.icellmobilsoft.coffee.jpa.sql.batch.BatchService</code> has been deleted.</p>
</div>
<div class="sect4">
<h5 id="_migration_54">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>Add the new <code>hu.icellmobilsoft.frappee:frappee-jpa-batch-api</code> module to the Maven dependencies.</p>
</li>
<li>
<p>The <code>hu.icellmobilsoft.frappee.jpa.batch.IJpaBatchService</code> must be used instead of the former <code>BatchService</code>.</p>
</li>
<li>
<p>The <code>HibernateBatchService</code> Hibernate specific implementation of the <code>IJpaBatchService</code> can be found in the
<code>hu.icellmobilsoft.frappee:frappee-hiberante-batch</code> module.</p>
</li>
<li>
<p>The JakartaEE 10 producer of the <code>HibernateBatchService</code> can be found in the <code>frappee-hiberante-batch-jee10</code>
module.</p>
</li>
<li>
<p>If the former <code>BatchService</code> is extended by your project the new <code>HibernateBatchService</code> must be extended and a new
producer must be created. For more information check the <a href="https://i-cell-mobilsoft-open-source.github.io/frappee/#HibernateBatchService">Frapp:EE documentation</a>. An example can be found in the <code>backend-sampler</code> project:
<a href="https://github.com/i-Cell-Mobilsoft-Open-Source/backend-sampler/blob/main/common/common-system-jpa/src/main/java/hu/icellmobilsoft/sampler/common/system/jpa/service/CustomHibernateBatchService.java#L40">CustomHibernateBatchService</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dto_base_3">9.1.2. coffee-dto-base</h4>
<div class="paragraph">
<p>The <code>TechnicalException</code> has been deprecated. The new <code>hu.icellmobilsoft.coffee.se.api.exception.TechnicalException</code>
 should be used instead from the <code>coffee-se-api</code> module.</p>
</div>
<div class="sect4">
<h5 id="_migration_55">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration. It is recommended to use the new
 <code>hu.icellmobilsoft.coffee.se.api.exception.TechnicalException</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_tool_6">9.1.3. coffee-tool</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>RandomUtil</code> has been deprecated. The new <code>hu.icellmobilsoft.coffee.se.util.string.RandomUtil</code> should be used
instean from the <code>coffee-se-util</code> module.</p>
</li>
<li>
<p>The <code>MavenURLHandler</code> is optimized for Quarkus packaging.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_56">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration. It is recommended to use the new
 <code>hu.icellmobilsoft.coffee.se.util.string.RandomUtil</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_se_api_2">9.1.4. coffee-se-api</h4>
<div class="paragraph">
<p>Intorducing the new <code>hu.icellmobilsoft.coffee.se.api.exception.TechnicalException</code>.</p>
</div>
<div class="sect4">
<h5 id="_migration_57">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_se_util">9.1.5. coffee-se-util</h4>
<div class="paragraph">
<p>New coff:ee module. Collection of utility classes.</p>
</div>
<div class="paragraph">
<p>Introducing the new <code>hu.icellmobilsoft.coffee.se.util.string.RandomUtil</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The generateToken() method has been made <code>public</code> unlike in the old RandomUtil class.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_58">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_mode_base">9.1.6. coffee-mode-base</h4>
<div class="paragraph">
<p>The <code>EntityIdGenerator</code> uses the new <code>RandomUtil</code> from the <code>coffee-se-util</code> module to generate random identifiers.
 Its implementation is 100% identical to the former one.</p>
</div>
<div class="sect4">
<h5 id="_migration_59">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_8">9.1.7. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p>Support of multiple xml catalog file separated with <code>,</code></p>
</li>
<li>
<p>For marshalling, you can give <code>JaxbTool</code> multiple classes to add to <code>JAXBContext</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_60">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_3">9.1.8. coffee-grpc</h4>
<div class="ulist">
<ul>
<li>
<p>microprofile-health support</p>
</li>
<li>
<p>Use separated managed-executor-service (java:jboss/ee/concurrency/executor/grpc) for gRPC calls.
The <code>managed-executor-service</code> configuration is explained in the <code>coffee-grpc-server-extension</code> documentation.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_61">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_2">9.1.9. coffee-module</h4>
<div class="ulist">
<ul>
<li>
<p>The headline of the emoji information description was removed in the adoc file generated by the <code>@ConfigDoc</code> annotation.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_62">Migration</h5>
<div class="ulist">
<ul>
<li>
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dto_base_4">9.1.10. coffee-dto-base</h4>
<div class="paragraph">
<p>New XSD simple types are added to the <code><a href="http://common.dto.coffee.icellmobilsoft.hu/common" class="bare">http://common.dto.coffee.icellmobilsoft.hu/common</a></code> XSD namespace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DateType - xsd:date with yyyy-MM-dd pattern</p>
</li>
<li>
<p>TimestampWithoutMillisType - xsd:dateTime with yyyy-MM-ddTHH:mm:ssZ pattern</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_63">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_se_io">9.1.11. coffee-se-io</h4>
<div class="paragraph">
<p>New module.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SizeLimitExceededIOException</code>: Signals that a limit is reach while reading an InputStream.</p>
</li>
<li>
<p><code>LimitedSizeInputStream</code>: Throws <code>SizeLimitExceededIOException</code> if the limit is reached while reading the stream.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_64">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesn&#8217;t need any migration.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_8_0_v2_9_0">10. v2.8.0 → v2.9.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.8.0 &#8594; v2.9.0 migration description, news, changes</p>
</div>
<div class="sect3">
<h4 id="_documentation">10.1. documentation</h4>
<div class="paragraph">
<p>Some english translation issue has been fixed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_notification_2">10.2. coffee-module-notification</h4>
<div class="paragraph">
<p>The commons-email was updated to a Jakarta-compatible release, and the module has been re-enabled.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_grpc_4">10.3. coffee-grpc</h4>
<div class="ulist">
<ul>
<li>
<p><code>GrpcClientConfig</code> extended with the <code>requestLogSize</code> and the <code>responseLogSize</code> parameter,
which serves to set the client request and response maximum log size in characters,
the characters exceeding the limit will be truncated.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_json_library_change">10.4. json library change</h4>
<div class="paragraph">
<p>Gson library has been replaced with Eclipse Yasson JSONB implementation, due to a known issue related with unknown properties at JSON communication (see coffee-tools readme for details). This has impact for more modules and reflect the following changes:</p>
</div>
<div class="paragraph">
<p><strong>JsonUtil related changes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>change in package name: <code>hu.icellmobilsoft.coffee.tool.gson.JsonUtil</code> has been moved to <code>hu.icellmobilsoft.coffee.tool.utils.json.JsonUtil</code></p>
</li>
<li>
<p>GSON lib implementation has been changed to JSONB implementation in the following existing methods, and throws a new checked exception:</p>
<div class="paragraph">
<p><code>String toJson(Object dto) throws JsonConversionException</code></p>
</div>
<div class="paragraph">
<p><code>T toObject(String json, Class&lt;T&gt; classType) throws JsonConversionException</code></p>
</div>
</li>
<li>
<p>new methods has been introduces for returning optional value:</p>
<div class="paragraph">
<p><code>Optional&lt;String&gt; toJsonOpt(Object dto)</code></p>
</div>
<div class="paragraph">
<p><code>Optional&lt;T&gt; toObjectOpt(String json, Class&lt;T&gt; classType)</code></p>
</div>
</li>
<li>
<p>the following methods was marked as deprecated:</p>
<div class="paragraph">
<p><code>String toJsonGson(Object dto)</code></p>
</div>
<div class="paragraph">
<p><code>String toJsonEx(Object dto) throws BaseException</code></p>
</div>
<div class="paragraph">
<p><code>T toObjectEx(String json, Class&lt;T&gt; classType) throws BaseException</code></p>
</div>
<div class="paragraph">
<p><code>T toObjectGson(String json, Class&lt;T&gt; classType)</code></p>
</div>
<div class="paragraph">
<p><code>T toObjectGson(Reader reader, Class&lt;T&gt; classType)</code></p>
</div>
<div class="paragraph">
<p><code>T toObjectUncheckedEx(String json, Type typeOfT) throws BaseException</code></p>
</div>
<div class="paragraph">
<p><code>T toObjectUncheckedGson(String json, Type typeOfT)</code></p>
</div>
<div class="paragraph">
<p><code>T toObjectUncheckedGson(Reader reader, Type typeOfT)</code></p>
</div>
<div class="paragraph">
<p><code>T toObjectUnchecked(String json, Type typeOfT)</code></p>
</div>
</li>
<li>
<p>GSON was hold for backward compatibility, initialization has been optimized</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Affected modules:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coffee-rest: Request-response logger</p>
</li>
<li>
<p>coffee-rest: Rest response exception mapper</p>
</li>
<li>
<p>coffee-rest: Apache HTTPClient</p>
</li>
<li>
<p>coffee-module-redis: Redis module caching</p>
</li>
<li>
<p>coffee-module-redispubsub: PubSubSink, ReactiveJedisPubSub</p>
</li>
<li>
<p>coffee-tool: GZIPUtil</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>New config has been introduced:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>coffee.jsonb.config.nullValues</p>
</li>
<li>
<p>coffee.jsonb.config.formatting</p>
</li>
<li>
<p>coffee.jsonb.config.failOnUnknownProperties</p>
</li>
<li>
<p>coffee.jsonb.config.encoding</p>
</li>
<li>
<p>coffee.jsonb.config.strictIJSON</p>
</li>
<li>
<p>coffee.jsonb.config.propertyNamingStrategy</p>
</li>
<li>
<p>coffee.jsonb.config.propertyOrderStrategy</p>
</li>
<li>
<p>coffee.jsonb.config.dateFormat</p>
</li>
<li>
<p>coffee.jsonb.config.locale</p>
</li>
<li>
<p>coffee.jsonb.config.customAdapters</p>
</li>
<li>
<p>coffee.jsonb.config.customSerializers</p>
</li>
<li>
<p>coffee.jsonb.config.customDeserializers</p>
</li>
<li>
<p>coffee.jsonb.config.customProperties</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>JsonB related changes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>new adapters has been added</p>
</li>
<li>
<p>JsonbContextResolverProvider, JsonbProducer, FieldOnlyVisibilityStrategy and JsonbUtil has been moved from coffee-rest to coffee-tool</p>
</li>
<li>
<p>Jsonb context initialization has been optimized</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_9_0_v2_10_0">11. v2.9.0 → v2.10.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.9.0 &#8594; v2.10.0 migration description, news, changes</p>
</div>
<div class="sect3">
<h4 id="_coffee_configuration">11.1. coffee-configuration</h4>
<div class="paragraph">
<p>A misleading exception message has been clarified in ApplicationConfiguration class.</p>
</div>
<div class="sect4">
<h5 id="_migration_65">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_redisstream">11.2. coffee-redisstream</h4>
<div class="paragraph">
<p>A new function has been added to RedisStreamPublisher, which makes it possible to send multiple messages at once to Redis stream through pipeline.</p>
</div>
<div class="sect4">
<h5 id="_migration_66">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_java11_support_remove">11.3. Java11 support remove</h4>
<div class="paragraph">
<p>Java11 support has been removed from the ci build process, and the default Java version has been changed to 17.</p>
</div>
<div class="sect4">
<h5 id="_migration_67">Migration</h5>
<div class="paragraph">
<p>The minimum supported Java version is 17.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_tool_7">11.4. coffee-tool</h4>
<div class="ulist">
<ul>
<li>
<p>The default custom jsonb adapters have become null safe.</p>
</li>
<li>
<p>The order of adding custom json adapters have changed to ensure the possibility to change the default behavior.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_68">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_model_base_5">11.5. coffee-model-base</h4>
<div class="paragraph">
<p>The <code>AbstractIdentifiedEntity</code> implements the <code>IIdentifiedEntity</code> interface in the same way as the <code>AbstractIdentifiedAuditEntity</code> does.
The <code>hu.icellmobilsoft.coffee.model.base.generator.EntityIdGenerator</code> works for this entity as well.</p>
</div>
<div class="sect4">
<h5 id="_migration_69">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_9">11.6. coffee-rest</h4>
<div class="paragraph">
<p>Missing i18n translation added for key <code>hu.icellmobilsoft.coffee.se.api.exception.enums.CoffeeFaultType.OPERATION_FAILED</code>.</p>
</div>
<div class="sect4">
<h5 id="_migration_70">Migration</h5>
<div class="paragraph">
<p>The changes are backwards compatible don&#8217;t need any migration. It is recommended to remove this key at the project level, if it was previously added as a workaround.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_deltaspike_data_extension">11.7. coffee-deltaspike-data-extension</h4>
<div class="paragraph">
<p>Produce all registered Repository with nativeImageProxyDefinitionBuildItemBuildProducer, to work Repository in native image.</p>
</div>
<div class="sect4">
<h5 id="_migration_71">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_10_0_v2_11_0">12. v2.10.0 → v2.11.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.10.0 &#8594; v2.11.0 migration description, news, changes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new coffee-bom-grpc module has been added for maintaining grpc versions</p>
</li>
<li>
<p>The coffee-grpc can be built on osx-aarch_64. (see documentation for some extra configuration)</p>
</li>
<li>
<p>ETCD driver version bump to 0.8.5</p>
</li>
<li>
<p>io.grpc version bump to 1.70.0</p>
</li>
<li>
<p>com.google.protobuf version bump to 3.25.5</p>
</li>
<li>
<p>commons-lang3 version bump 3.12.0 &#8594; 3.15.0</p>
</li>
<li>
<p>commons-codec version bump 1.15 &#8594; 1.17.1</p>
</li>
<li>
<p>commons.io version bump 2.11.0 &#8594; 2.16.1</p>
</li>
<li>
<p>httpcomponents-httpclient version bump 4.5.13 &#8594; 4.5.14</p>
</li>
<li>
<p>httpcomponents-httpcore version bump 4.4.15 &#8594; 4.4.16</p>
</li>
<li>
<p>eclipse-yasson version bump 3.0.3 &#8594; 3.0.4</p>
</li>
<li>
<p>org.jboss.logging version bump 3.4.3.Final &#8594; 3.6.1.Final (Wildfly 34 support)</p>
</li>
<li>
<p>org.jboss.resteasy version bump 6.2.1.Final &#8594; 6.2.11.Final (Wildfly 34 support)</p>
</li>
<li>
<p>io.micrometer version bump 1.9.13 &#8594; 1.12.4 (Wildfly 34 support)</p>
</li>
<li>
<p>jakarta jaxb-api version bump 4.0.0 &#8594; 4.0.2 (Wildfly 34 support)</p>
</li>
<li>
<p>jakarta activation-api version bump 2.1.0 &#8594; 2.1.3 (Wildfly 34 support)</p>
</li>
<li>
<p>org.eclipse.microprofile version bump 5.0 &#8594; 6.1 (Wildfly 34 support)</p>
<div class="ulist">
<ul>
<li>
<p>microprofile-config version bump 3.0.3 &#8594; 3.1 (no incompatible changes)</p>
</li>
<li>
<p>microprofile-health version bump 4.0 &#8594; 4.0.1</p>
</li>
<li>
<p>microprofile-openapi version bump 3.0 &#8594; 3.1.2 (no incompatible changes)</p>
</li>
<li>
<p>microprofile-metrics is kept at version 4.0, as 5.1 would introduce breaking changes, but newer wf and quarkus versions will use micrometer</p>
</li>
</ul>
</div>
</li>
<li>
<p>io.opentelemetry version bump 1.20.0 &#8594; 1.29.0 (Wildfly 34 support)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_new_modules_added">12.1. new modules added</h4>
<div class="ulist">
<ul>
<li>
<p><code>coffee-module-wildfly</code> for collecting wildfly specific functions</p>
</li>
<li>
<p><code>coffee-module-quarkus</code> for collecting quarkus specific functions</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_tool_8">12.2. coffee-tool</h4>
<div class="ulist">
<ul>
<li>
<p>GZipUtil got some new method for lower memory usage and direct DTO/JSON compression</p>
</li>
<li>
<p>RandomSplitGenerator added</p>
</li>
<li>
<p>JsonbUtil#getCustomClassInstance implementation changed, using Thread.currentThread().getContextClassLoader().loadClass instead of Class.forName</p>
</li>
<li>
<p>DateUtil new functions: <code>daysBetweenLocalDates</code> and <code>tryToParseAbsoluteRelativeDate</code></p>
</li>
<li>
<p>A new AbstractEntityProcessorAction class has been added for common entity processing</p>
</li>
<li>
<p>New abstract cache implementations: AbstractCache and AbstractLoadingCache</p>
</li>
<li>
<p>New AbstractRedisStreamPipeConsumerExecutor and EventControlAction classes added to redisstream module</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_72">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_10">12.3. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p>A new AbstractEvictAction class has been added to allow uniform invocation of classes implementing Evictable for cache clearing purposes</p>
</li>
<li>
<p>AbstractWildflySystemRest and AbstractQuarkusSystemRest have been added as abstract base classes for the SystemRest endpoint on the project</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_73">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hibernate_version_upgrade">12.4. Hibernate version upgrade</h4>
<div class="paragraph">
<p>Hibernate <code>6.2.13.Final</code> &#8594; <code>6.6.1.Final</code> upgrade (Wildfly 34 support).</p>
</div>
<div class="sect4">
<h5 id="_migration_74">Migration</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/hibernate/orm/6.6/migration-guide/migration-guide.html">Hibernate 6.6 migration guide</a></p>
</li>
<li>
<p>Otherwise, no changes were made at coff:ee that would prevent the use of the previous hibernate version with a dependency exclude</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_etcd_extension">12.5. coffee-module-etcd-extension</h4>
<div class="paragraph">
<p>New Quarkus extension to support Quarkus native compatibility for the coffee-module-etcd module.
Description: <a href="#common_coffee-quarkus-extensions-module-etcd">coffee-module-etcd-extension</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_tool_extension">12.6. coffee-tool-extension</h4>
<div class="paragraph">
<p>New Quarkus extension to support Quarkus native compatibility for the coffee-tool module.
Description: <a href="#common_coffee-quarkus-extensions-tool">coffee-tool-extension</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_redisstream_3">12.7. coffee-module-redisstream</h4>
<div class="paragraph">
<p>BaseRedisConsumerStarter update with thread checking and metrics data propagation with CDI async event</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_v2_11_0_v2_12_0">13. v2.11.0 → v2.12.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>coff:ee v2.11.0 &#8594; v2.12.0 migration description, news, changes</p>
</div>
<div class="sect3">
<h4 id="_global_5">13.1. Global</h4>
<div class="ulist">
<ul>
<li>
<p>Apache commons-lang3 version bump 3.15.0 &#8594; 3.18.0</p>
</li>
<li>
<p>parent-oss-pom upgraded from <code>1.4.0</code> to <code>1.5.0</code></p>
</li>
<li>
<p>The <code>oss.sonatype.org</code> snapshot repository was replaced by <code>central.sonatype.com</code>, and module names were added for validations.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_75">Migration</h5>
<div class="paragraph">
<p>The commons-lang3 version update introduces some deprecated methods, which will need to be updated across the projects. The list can be found here: <a href="https://commons.apache.org/proper/commons-lang/apidocs/deprecated-list.html" class="bare">https://commons.apache.org/proper/commons-lang/apidocs/deprecated-list.html</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_rest_11">13.2. coffee-rest</h4>
<div class="ulist">
<ul>
<li>
<p>JaxbTool CDI dependent bean destroy fix</p>
</li>
<li>
<p>The <code>DefaultGeneralExceptionMapper</code> handles the new <code>IBaseExceptionWrapper</code> instead of the <code>BaseExceptionWrapper</code>. For more info check the <code>coffee-dto-base</code> and <code>coffee-se-api</code>.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_76">Migration</h5>
<div class="paragraph">
<p>Changes are backwards compatible doesnt need any migration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_docgen">13.3. coffee-module-docgen</h4>
<div class="ulist">
<ul>
<li>
<p>A new <code>coffee-module-docgen</code> pom module has been added for containing modules for generating documentation</p>
<div class="ulist">
<ul>
<li>
<p><code>coffee-module-configdoc</code></p>
<div class="ulist">
<ul>
<li>
<p>Renamed to <code>coffee-module-docgen-config</code> and moved in <code>coffe-module-docgen</code></p>
</li>
<li>
<p>Some class renames are also occurred</p>
</li>
</ul>
</div>
</li>
<li>
<p>General documentation generation functionality extracted to a new <code>coffee-module-docgen-common</code> module</p>
</li>
<li>
<p>A new <code>coffee-module-docgen-sqlcatalog</code> module has been added for generating sql catalog</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_migration_77">13.4. Migration</h4>
<div class="paragraph">
<p>Change maven dependency from</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-configdoc&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>to</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-module-docgen-config&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<hr>
<div class="paragraph">
<p>Change <code>maven-compiler-plugin</code> compilerArgs from</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;compilerArgs&gt;
    &lt;arg&gt;-Acoffee.configDoc.outputDir=${outputDir}&lt;/arg&gt;
    &lt;arg&gt;-Acoffee.configDoc.outputFileName=${outputFileName}&lt;/arg&gt;
    &lt;arg&gt;-Acoffee.configDoc.outputToClassPath=${outputToClassPath}&lt;/arg&gt;
    &lt;arg&gt;-Acoffee.configDoc.dynamicOutputFileName=${dynamicOutputFileName}&lt;/arg&gt;
    &lt;arg&gt;-Acoffee.configDoc.columns=${columns}&lt;/arg&gt;
&lt;/compilerArgs&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>to</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;compilerArgs&gt;
    &lt;arg&gt;-Acoffee.docgen.config.outputDir=${outputDir}&lt;/arg&gt;
    &lt;arg&gt;-Acoffee.docgen.config.outputFileName=${outputFileName}&lt;/arg&gt;
    &lt;arg&gt;-Acoffee.docgen.config.outputToClassPath=${outputToClassPath}&lt;/arg&gt;
    &lt;arg&gt;-Acoffee.docgen.config.dynamicOutputFileName=${dynamicOutputFileName}&lt;/arg&gt;
    &lt;arg&gt;-Acoffee.docgen.config.columns=${columns}&lt;/arg&gt;
&lt;/compilerArgs&gt;</pre>
</div>
</div>
<hr>
<div class="paragraph">
<p>As a result of the move and renames, if these classes are also used on the usage project, the imports must be updated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.ConfigDoc</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.ConfigDoc</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.writer.impl.AsciiDocWriter</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.writer.impl.ConfigDocAsciiDocWriter</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.config.ConfigDocColumn</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.config.ConfigDocColumn</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.config.ConfigDocConfig</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.config.ConfigDocConfig</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.processor.ConfigDocProcessor</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.processor.ConfigDocProcessor</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.processor.ConfigDocVisitor</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.processor.ConfigDocVisitor</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.data.DocData</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.data.DocData</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.writer.impl.DynamicAsciiDocWriter</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.writer.impl.DynamicAsciiDocWriter</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.DynamicConfigDocs</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.DynamicConfigDocs</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.processor.DynamicConfigDocsProcessor</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.processor.DynamicConfigDocsProcessor</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.processor.DynamicConfigDocsVisitor</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.processor.DynamicConfigDocsVisitor</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.DynamicConfigTemplate</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.DynamicConfigTemplate</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.processor.DynamicConfigTemplateProcessor</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.processor.DynamicConfigTemplateProcessor</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.data.DynamicDocData</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.config.data.DynamicDocData</code></p>
</li>
<li>
<p><code>hu.icellmobilsoft.coffee.module.configdoc.writer.IDocWriter</code> &#8594; <code>hu.icellmobilsoft.coffee.module.docgen.common.writer.IDocWriter</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_module_redis_4">13.5. coffee-module-redis</h4>
<div class="ulist">
<ul>
<li>
<p>Redis cluster support has been added to module</p>
<div class="ulist">
<ul>
<li>
<p>injectable Jedis object is replaced to UnifiedJedis object</p>
</li>
<li>
<p><code>cluster</code> configuration key has been added to redis configuration, which contains an url or url list in <code>$(host):$(port)</code> format, example:</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">coffee:
    redis:
        ...
        auth:
            ...
            cluster:
              - sample-sandbox.icellmobilsoft.hu:6380
              - sample-sandbox.icellmobilsoft.hu:6381</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_migration_78">Migration</h5>
<div class="paragraph">
<p>As the result of replacing Jedis object, in the usage project must update Jedis usages to UnifiedJedis.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_quarkus_extensions_2">13.6. coffee-quarkus-extensions</h4>
<div class="ulist">
<ul>
<li>
<p>Every groupId has been changed from <code>hu.icellmobilsoft.coffee</code> to <code>hu.icellmobilsoft.coffee.quarkus</code></p>
</li>
<li>
<p>Description: <a href="#common_coffee-quarkus-extensions">coffee-quarkus-extensions</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_migration_79">Migration</h5>
<div class="paragraph">
<p>In projects using quarkus extensions, the groupIds must be changed from <code>hu.icellmobilsoft.coffee</code> to <code>hu.icellmobilsoft.coffee.quarkus</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_dto_base_5">13.7. coffee-dto-base</h4>
<div class="paragraph">
<p><code>BaseExceptionWrapper</code> interface has been deprecated and a new alternative is introduced in <code>coffee-se-api</code>:
<code>hu.icellmobilsoft.coffee.se.api.exception.wrapper.IBaseExceptionWrapper</code>.</p>
</div>
<div class="sect4">
<h5 id="_migration_80">Migration</h5>
<div class="paragraph">
<p>The changes are backwards compatible and do not require any migration. However, it is recommended to use the new <code>IBaseExceptionWrapper</code> at the project level.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_se_api_3">13.8. coffee-se-api</h4>
<div class="paragraph">
<p>A new <code>IBaseExceptionWrapper</code> has been introduced as a replacement for <code>BaseExceptionWrapper</code>.</p>
</div>
<div class="sect4">
<h5 id="_migration_81">Migration</h5>
<div class="paragraph">
<p>The changes are backwards compatible and do not require any migration. It is recommended to use this new interface instead of <code>BaseExceptionWrapper</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffee_cdi_4">13.9. coffee-cdi</h4>
<div class="paragraph">
<p><code>hu.icellmobilsoft.coffee.cdi.trace.annotation.Traced.LITERAL</code> type changed so it can be used with <code>ITraceHandler</code>,
and initialized with default values.</p>
</div>
<div class="sect4">
<h5 id="_migration_82">Migration</h5>
<div class="paragraph">
<p>The changes are backwards compatible and do not require any migration.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_howto">14. HOWTO</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="howto_xsd-xml-validation-depend-on-version">14.1. XML XSD version dependent validation</h3>
<div class="paragraph">
<p>Implementation of incoming xml validation depending on different xsd versions.</p>
</div>
<div class="sect3">
<h4 id="_version_dependent_validation_outside_coffee_in_projects">14.1.1. Version dependent validation outside Coffee in projects</h4>
<div class="paragraph">
<p>Example of how to use validation:
The annotated endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ISampleService {

    @POST
    @Path("/customer/sample")
    @Consumes(value = { MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @Produces(value = { MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @LogSpecifier(maxResponseEntityLogSize = LogSpecifier.NO_LOG)
    SampleResponse postSampleRequest(
        @ValidateXMLs({
            @ValidateXML(version = @Version(include = @Range(from = "1.0", to = "1.9")), xsdPath = ""),
            @ValidateXML(version = @Version(include = @Range(from = "1.10")), xsdPath = "xsd_wsdl/hu/icellmobilsoft/sample/1.0/sample.xsd")
        }) SampleRequest sampleRequest) throws BaseException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ISampleService {

    @POST
    @Path("/customer/sample")
    @Consumes(value = { MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @Produces(value = { MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @LogSpecifier(maxResponseEntityLogSize = LogSpecifier.NO_LOG)
    SampleResponse postSampleRequest(
        @ValidateXML(version = @Version(include = @Range(from = "1.10")), xsdPath = "xsd_wsdl/hu/icellmobilsoft/sample/1.0/sample.xsd") SampleRequest sampleRequest) throws BaseException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ISampleService {

    @POST
    @Path("/customer/sample")
    @Consumes(value = { MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @Produces(value = { MediaType.TEXT_XML, MediaType.APPLICATION_XML })
    @LogSpecifier(maxResponseEntityLogSize = LogSpecifier.NO_LOG)
    SampleResponse postSampleRequest(
        @ValidateXML(xsdPath = "xsd_wsdl/hu/icellmobilsoft/sample/1.0/sample.xsd") SampleRequest sampleRequest) throws BaseException;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_also_prepare_the_providers">14.1.2. Also prepare the providers</h4>
<div class="paragraph">
<p>We need one for the XML</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Provider
@Consumes({MediaType.APPLICATION_XML, MediaType.TEXT_XML})
@Priority(Priorities.ENTITY_CODER)
public class XMLRequestMessageBodyReader extends XmlMessageBodyReaderBase&lt;BasicRequestType&gt; {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another one for JSON</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Provider
@Consumes({ MediaType.APPLICATION_JSON })
@Priority(Priorities.ENTITY_CODER)
public class JsonRequestMessageBodyReader extends JsonMessageBodyReaderBase&lt;BaseRequestType&gt; {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON XSD validation is done by converting the inputStream to a DTO using the JSON parser
(which is returned by the provider for further business logic processing),
and then run an XML marshaller with XSD enabled on it to validate it.
If errors occur during this process, they are handled at provider level.
Then everything is done with the errors as with the XML validation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_if_you_want_to_use_your_own_lsresourceresolver">14.1.3. If you want to use your own LSResourceResolver</h4>
<div class="paragraph">
<p>We need to implement the IXsdResourceResolver interface (with @Alternative annotation).
Then we need to register the alternative class in beans.xml e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;alternatives&gt;
    &lt;class&gt;hu.icellmobilsoft.sample.xmlvalidation.xmlutils.ProjectXsdResourceResolver&lt;/class&gt;
&lt;/alternatives&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use your own implementations of XsdHelper (IXsdHelper), XmlRequestVersionReader (IXmlRequestVersionReader), XsdValidationErrorCollector (IXsdValidationErrorCollector).</p>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting_at_project_level">14.1.4. Troubleshooting at project level</h4>
<div class="paragraph">
<p>Our ExceptionMapper implementation may also be complementary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    private Response handleException(Exception e, ReasonCodeType reasonCode, FunctionCodeType functionCode) {
        if (e instanceof XsdProcessingExceptionWrapper) {
            XsdProcessingExceptionWrapper processingException = (XsdProcessingExceptionWrapper) e;
            if (processingException.getCause() instanceof XsdProcessingException) {
                XsdProcessingException xsdEx = (XsdProcessingException) processingException.getCause();
                return restExceptionMapper.toResponse(xsdEx);
            }
        }


    public Response toResponse(BaseException e) {
        ...
        } else if (e instanceof XsdProcessingException) {
            TechnicalFault f = new TechnicalFault();
            // getLocalizedMessage-ben osszeszedjuk a hibakat
            f.setMsg(HandleXsdProcessingException.generateDetailedMessage((XsdProcessingException) e));
            f.setReasonCode(ReasonCodeType.INVALID_REQUEST);
            f.setFuncCode(FunctionCodeType.ERROR);
            return Response.status(Response.Status.BAD_REQUEST).entity(f).build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what else to watch out for: all XSD errors are returned by Coffee.
These should be extracted separately, e.g. like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static String generateDetailedMessage(XsdProcessingException invalidRequestException) {
       if (invalidRequestException == null) {
           return null;
       }
       StringBuilder msg = new StringBuilder();
       for (XMLValidationError xmlValidationError : invalidRequestException.getErrors()) {
           if (xmlValidationError != null) {
               if (msg.length() &gt; 0) {
                   msg.append('\n');
               }
               msg.append(xmlValidationError.getField()).append(" - ").append(xmlValidationError.getError());
           }
       }

	return msg.length() &gt; 0 ? invalidRequestException.getLocalizedMessage() + " errors:\n" + msg.toString() : invalidRequestException.getLocalizedMessage();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_if_there_has_been_no_xsd_validation_so_far">14.1.5. If there has been no XSD validation so far</h4>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>and you want to handle the transition period (the old version does not validate, the new one does).
Then give schemaPath an empty ("") String.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="howto_xsd_catalog">14.2. XSD Catalog and generation</h3>
<div class="paragraph">
<p>Customizable XSD generation and validation.</p>
</div>
<div class="paragraph">
<p>The XSD catalog itself is a rather complicated topic within the XSD standard.
It is not important to go deeper into it, we will only deal with what we need below,
and it is worth using it for modularization both in the framework and in projects.
The whole "XSD catalogue" is an OASIS standard, which is
<a href="https://www.oasis-open.org/committees/download.php/14809/xml-catalogs.html">xml-catalogs</a>
can be found at.</p>
</div>
<div class="sect3">
<h4 id="_general_3">14.2.1. General</h4>
<div class="paragraph">
<p>We generally use XSD to get rid of the basic valadication of DTO objects, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>input string length - how long the field value can be (character length)</p>
</li>
<li>
<p>mandatory - mandatory to fill in or not</p>
</li>
<li>
<p>minimum, maximum values - for example minimum 0, 1970-01-01, -3.14, &#8230;&#8203;</p>
</li>
<li>
<p>type mandatory - date, int, boolean, etc&#8230;&#8203;</p>
</li>
<li>
<p>defined values - ENUM</p>
</li>
<li>
<p>string, date pattern - "\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(.\d{1,3})?Z", "[a-zA-Z0-9\-@.]{6,30}", &#8230;&#8203;</p>
</li>
<li>
<p>other XSD options&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, it greatly assists object-oriented DTO generation, recycling
- a well-written XSD structure can be very easily used for coding.</p>
</div>
<div class="paragraph">
<p>It is also important that we use JAVA language but the REST interface objects we write
are defined in XSD and can be passed to a connected external client.
You can generate your own DTOs from XSD in any language without having to rewrite them manually.</p>
</div>
<div class="paragraph">
<p>We try to keep the XSD as complex and documented as possible because we use an openapi-jaxb
plugin that complements the DTOs with openapi annotations, where all data, restrictions and
description. Thanks to this Swagger can also serve as a complete REST interface documentation for the developer,
developer, tester, frontend, server and client, without the need to invest extra effort in post-documentation of the product.</p>
</div>
<div class="paragraph">
<p>Lest it seem that XSD is perfect, I will mention one of its biggest drawbacks
- if the input is not XML (e.g. JSON), we can only solve the validation by extra transformation to XML.
But the above listed advantages can save so much time that the price is
we are willing to pay - so far all problems could be solved&#8230;&#8203;</p>
</div>
</div>
<div class="sect3">
<h4 id="_sample">14.2.2. Sample</h4>
<div class="paragraph">
<p>Suppose we have a structure consisting of several XSDs. In this case we want a user DTO with
has 2 elements, <code>userName</code> and <code>password</code>, these must satisfy the following constraints:</p>
</div>
<div class="listingblock">
<div class="title">/coffee-dto-xsd/src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/common/common.xsd</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://common.dto.coffee.icellmobilsoft.hu/common"
    targetNamespace="http://common.dto.coffee.icellmobilsoft.hu/common" elementFormDefault="qualified"
    attributeFormDefault="unqualified"&gt;

...

    &lt;!-- SIMPLE TYPES --&gt;
    &lt;xsd:simpleType name="SimpleText255Type"&gt;
        &lt;xsd:restriction base="xsd:string"&gt;
            &lt;xsd:maxLength value="255" /&gt;
        &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;
    &lt;xsd:simpleType name="EmailType"&gt;
        &lt;xsd:restriction base="xsd:string"&gt;
            &lt;xsd:maxLength value="200" /&gt;
            &lt;xsd:pattern value="[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}" /&gt;
        &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

...

&lt;xsd:schema</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_traditional_solution">Traditional solution</h5>
<div class="listingblock">
<div class="title">/coffee-dto-xsd/src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/common/commonservice.xsd</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:common="http://common.dto.coffee.icellmobilsoft.hu/common" <i class="conum" data-value="1"></i><b>(1)</b>
    xmlns="http://common.dto.coffee.icellmobilsoft.hu/commonservice"
    targetNamespace="http://common.dto.coffee.icellmobilsoft.hu/commonservice"
    elementFormDefault="qualified" attributeFormDefault="unqualified"&gt;

    &lt;xsd:import namespace="http://common.dto.coffee.icellmobilsoft.hu/common" schemaLocation="common.xsd"/&gt; <i class="conum" data-value="2"></i><b>(2)</b>

...

    &lt;xsd:complexType name="UserType"&gt;
        &lt;xsd:sequence&gt;
            &lt;xsd:element name="userName" type="common:EmailType"&gt; <i class="conum" data-value="3"></i><b>(3)</b>
                &lt;xsd:annotation&gt;
                    &lt;xsd:documentation&gt;User login id.
                    &lt;/xsd:documentation&gt;
                &lt;/xsd:annotation&gt;
            &lt;/xsd:element&gt;
            &lt;xsd:element name="password"
                type="common:SimpleText255Type"&gt; <i class="conum" data-value="3"></i><b>(3)</b>
                &lt;xsd:annotation&gt;
                    &lt;xsd:documentation&gt;User login password hash.
                    &lt;/xsd:documentation&gt;
                &lt;/xsd:annotation&gt;
            &lt;/xsd:element&gt;
        &lt;/xsd:sequence&gt;
    &lt;/xsd:complexType&gt;

...

&lt;xsd:schema</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>xml namespace definition, named "common" and the import "http://common.dto.coffee.icellmobilsoft.hu/common" will be the source</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mount (import) the referenced namespace, using file path.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Reference to a type in another XSD.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Advantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Easy to manage and read addictions.</p>
</li>
<li>
<p>All XSD/XML management programs can use it natively, code assist works, native XSD validation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In code, validation under XSD requires writing a custom resolver for external dependencies.</p>
</li>
<li>
<p>The xsd file defined in the <code>schemaLocation</code> path must be locally available.</p>
</li>
<li>
<p>Within a project, an import from another module can be very cumbersome (e.g. "../../../../../../../../../../target/unpacked-files/coffee-resources/xsd/hu/icellmobilsoft/coffee/dto/common/common.xsd").</p>
</li>
<li>
<p><strong>Not customizable</strong> (explained in more detail below).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="howto_xsd_catalog_CatalogMegoldas">14.2.3. Solution with catalog</h4>
<div class="paragraph">
<p>In this case 2 files are required:</p>
</div>
<div class="listingblock">
<div class="title">/coffee-dto-xsd/src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/common/commonservice.xsd</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:common="http://common.dto.coffee.icellmobilsoft.hu/common" <i class="conum" data-value="1"></i><b>(1)</b>
    xmlns="http://common.dto.coffee.icellmobilsoft.hu/commonservice"
    targetNamespace="http://common.dto.coffee.icellmobilsoft.hu/commonservice"
    elementFormDefault="qualified" attributeFormDefault="unqualified"&gt;

    &lt;xsd:import namespace="http://common.dto.coffee.icellmobilsoft.hu/common"/&gt; <i class="conum" data-value="2"></i><b>(2)</b>

...

    &lt;xsd:complexType name="UserType"&gt;
        &lt;xsd:sequence&gt;
            &lt;xsd:element name="userName" type="common:EmailType"&gt; <i class="conum" data-value="3"></i><b>(3)</b>
                &lt;xsd:annotation&gt;
                    &lt;xsd:documentation&gt;Felhasználó bejelentkezési azonosító.
                    &lt;/xsd:documentation&gt;
                &lt;/xsd:annotation&gt;
            &lt;/xsd:element&gt;
            &lt;xsd:element name="password"
                type="common:SimpleText255Type"&gt;  <i class="conum" data-value="3"></i><b>(3)</b>
                &lt;xsd:annotation&gt;
                    &lt;xsd:documentation&gt;Felhasználó bejelentkezési jelszó hash.
                    &lt;/xsd:documentation&gt;
                &lt;/xsd:annotation&gt;
            &lt;/xsd:element&gt;
        &lt;/xsd:sequence&gt;
    &lt;/xsd:complexType&gt;

...

&lt;xsd:schema</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>xml namespace definition, named "common" and the import "http://common.dto.coffee.icellmobilsoft.hu/common" will be the source</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mount (import) the referenced namespace - only namespace reference (no file path).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Reference to a type in another XSD.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/coffee-dto-impl/src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/super.catalog.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;catalog xmlns="urn:oasis:names:tc:entity:xmlns:xml:catalog"&gt;
    &lt;public publicId="http://common.dto.coffee.icellmobilsoft.hu/common" <i class="conum" data-value="1"></i><b>(1)</b>
        uri="maven:hu.icellmobilsoft.coffee.dto.xsd:coffee-dto-xsd:jar::!/xsd/hu/icellmobilsoft/coffee/dto/common/common.xsd" /&gt;
&lt;/catalog&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>xml namespace definition, "http://common.dto.coffee.icellmobilsoft.hu/common" import namespace where to find the file source.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Advantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Customizable</strong></p>
</li>
<li>
<p>Independent XSD files can be imported that are not in the project.</p>
</li>
<li>
<p>One place for all imported XSD files.</p>
</li>
<li>
<p>Validation by XSD in code is easier than in the general solution and is universal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setting required for XSD/XML management programs, or producing your own catalog file.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_use_cases">14.2.4. Use cases</h4>
<div class="paragraph">
<p>Imagine a case where Coffee generates some very basic DTO objects.
This is important so that a common "generic" code base can be created in Coffee,
For example, a generic error handling, logging, apache client response processing, etc (where DTOs are involved).
If there is no generic class to cast types to, such boilercode is not possible
in Coffee, since only the "Object" itself could be referenced.
Nor is it a solution for Coffee to force some fixed types,
because then projects would not be able to customize and extend it (e.g. replacing XMLGregorianCalendar with java.time.OffsetDateTime).
Traditional XSD import is not appropriate in this situation,
because it looks for the import xsd path file in a fixed location, which is not part of our project but part of Coffee,
and refers to a relative path within Coffee.</p>
</div>
<div class="paragraph">
<p>The catalog file provides a solution.
The catalog is a separate file, you can make your own version of it.
In it, we only use the basic XSDs that meet our needs.
Whatever does not suit us, we have to copy the original XSD with everything and extend it with the Coffee DTO type.
If the namespace and the complexType names are not changed,
it will generate the same DTO class as in Coffee.
This will be found by JAVA via the classpath and all Coffee logic can continue to work.
If the change is very drastic you can use the CDI to replace the Coffee logic completely.</p>
</div>
<div class="sect4">
<h5 id="_generation">Generation</h5>
<div class="paragraph">
<p>The generation is done in our case with maven. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;hu.icellmobilsoft.coffee.dto.xsd&lt;/groupId&gt;
            &lt;artifactId&gt;coffee-dto-xsd&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;/dependency&gt;

        ...

        &lt;dependency&gt;
            &lt;groupId&gt;org.eclipse.microprofile.openapi&lt;/groupId&gt;
            &lt;artifactId&gt;microprofile-openapi-api&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
            &lt;version&gt;3.0.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;com.helger.maven&lt;/groupId&gt;
                &lt;artifactId&gt;jaxb40-maven-plugin&lt;/artifactId&gt; <i class="conum" data-value="3"></i><b>(3)</b>
                &lt;version&gt;0.16.0&lt;/version&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;id&gt;coffee-super&lt;/id&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;generate&lt;/goal&gt;
                        &lt;/goals&gt;
                        &lt;configuration&gt;
                            &lt;strict&gt;false&lt;/strict&gt;
                            &lt;!-- https://github.com/highsource/maven-jaxb2-plugin/wiki/Catalogs-in-Strict-Mode --&gt;
                            &lt;catalog&gt;src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/super.catalog.xml&lt;/catalog&gt;  <i class="conum" data-value="4"></i><b>(4)</b>
                            &lt;schemaIncludes&gt;
                                &lt;include&gt;xsd/hu/icellmobilsoft/coffee/dto/super.xsd&lt;/include&gt;  <i class="conum" data-value="5"></i><b>(5)</b>
                            &lt;/schemaIncludes&gt;
                            &lt;bindingIncludes&gt;
                                &lt;include&gt;xsd/hu/icellmobilsoft/coffee/dto/bindings.xjb&lt;/include&gt;  <i class="conum" data-value="6"></i><b>(6)</b>
                            &lt;/bindingIncludes&gt;
                            &lt;generateDirectory&gt;${project.build.directory}/generated-sources/src/main/java&lt;/generateDirectory&gt;  <i class="conum" data-value="7"></i><b>(7)</b>
                        &lt;/configuration&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
                &lt;configuration&gt;
                    &lt;verbose&gt;true&lt;/verbose&gt;
                    &lt;schemaDirectory&gt;src/main/resources&lt;/schemaDirectory&gt;
                    &lt;args&gt;
                        &lt;arguments&gt;-openapify&lt;/arguments&gt; <i class="conum" data-value="8"></i><b>(8)</b>
                        &lt;arguments&gt;-Xfluent-api&lt;/arguments&gt; <i class="conum" data-value="9"></i><b>(9)</b>
                        &lt;arguments&gt;-Xannotate&lt;/arguments&gt; <i class="conum" data-value="10"></i><b>(10)</b>
                    &lt;/args&gt;
                    &lt;plugins&gt;
                        &lt;plugin&gt;
                            &lt;groupId&gt;hu.icellmobilsoft.jaxb&lt;/groupId&gt;
                            &lt;artifactId&gt;openapi-jaxb-plugin&lt;/artifactId&gt; <i class="conum" data-value="8"></i><b>(8)</b>
                            &lt;version&gt;2.0.0&lt;/version&gt;
                        &lt;/plugin&gt;
                        &lt;plugin&gt;
                            &lt;groupId&gt;net.java.dev.jaxb2-commons&lt;/groupId&gt;
                            &lt;artifactId&gt;jaxb-fluent-api&lt;/artifactId&gt; <i class="conum" data-value="9"></i><b>(9)</b>
                            &lt;version&gt;2.1.8&lt;/version&gt;
                        &lt;/plugin&gt;
                        &lt;plugin&gt;
                            &lt;groupId&gt;org.jvnet.jaxb2_commons&lt;/groupId&gt;
                            &lt;artifactId&gt;jaxb2-basics-annotate&lt;/artifactId&gt; <i class="conum" data-value="10"></i><b>(10)</b>
                            &lt;version&gt;1.0.4&lt;/version&gt;
                        &lt;/plugin&gt;
                        &lt;plugin&gt;
                            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
                            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; <i class="conum" data-value="10"></i><b>(10)</b>
                            &lt;version&gt;2.9.9.1&lt;/version&gt;
                        &lt;/plugin&gt;
                    &lt;/plugins&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This package contains the XSD files</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The generated DTOs contain OpenApi annotations, and to compile the generated classes, it is necessary to include the specification</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Maven plugin which controls the generation</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>XSD catalog file path</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Main XSD to be generated.
This can actually be several small ones, but then you have to keep modifying pom.xml whenever a change occurs.
It is simpler to list them in a central xsd.
Also in such cases the global settings would have to be handled individually.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>XJB file, here you can set customized deviations, for example XMLGregorianCalendar &#8594; java.time replacement&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Where to generate the classes.
The plugin will put this automatically in the source code sources, Eclipse and IDEA will handle it automatically.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Switch to generate the OpenApi annotations, <code>hu.icellmobilsoft.jaxb:openapi-jaxb-plugin</code> by plugin.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Switch to generate the methods for fluent encoding, by <code>net.java.dev.jaxb2-commons:jaxb-fluent-api</code> plugin.
It can be very useful, it can save a lot of unnecessary lines in the business log.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Switch to use javax.annotation.* annotations
in the XSD and also generate according to it.
For more details see <a href="https://github.com/highsource/jaxb2-annotate-plugin">jaxb2-annotate-plugin</a>
and <a href="https://stackoverflow.com/questions/26430199/http-annox-dev-java-net-customizations-require-the-xannotate-switch">stackoverflow.com</a></td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_openapi_swagger">OpenApi, Swagger</h5>
<div class="paragraph">
<p>As already mentioned, the generated DTOs are part of the complete documentation.
Preferably they should contain all the information that may be needed by other developers, testers, organizers, etc&#8230;&#8203;
To do this, the XSD elements should be filled as much as possible when creating the XSD,
because the generator will use them to generate the documentation annotations.</p>
</div>
<div class="paragraph">
<p>These annotations (OpenApi) will be displayed in a user interface using a program called Swagger.</p>
</div>
<div class="listingblock">
<div class="title">xml file source</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">..
    &lt;xsd:simpleType name="EntityIdType"&gt;
        &lt;xsd:restriction base="xsd:string"&gt;
            &lt;xsd:maxLength value="30" /&gt;
            &lt;xsd:pattern value="[+a-zA-Z0-9_]{1,30}" /&gt;
        &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;
    &lt;xsd:group name="BaseAuditUserGroup"&gt;
        &lt;xsd:sequence&gt;
            &lt;xsd:element name="creatorUser" type="EntityIdType"
                minOccurs="0" /&gt;
            &lt;xsd:element name="modifierUser" type="EntityIdType"
                minOccurs="0" /&gt;
        &lt;/xsd:sequence&gt;
    &lt;/xsd:group&gt;
    &lt;xsd:group name="BaseAuditGroup"&gt;
        &lt;xsd:sequence&gt;
            &lt;xsd:group ref="BaseAuditDateGroup" /&gt;
            &lt;xsd:group ref="BaseAuditUserGroup" /&gt;
        &lt;/xsd:sequence&gt;
    &lt;/xsd:group&gt;
    &lt;xsd:complexType name="AbstractAuditDtoType"&gt;
        &lt;xsd:complexContent&gt;
            &lt;xsd:extension base="AbstractDtoType"&gt;
                &lt;xsd:sequence&gt;
                    &lt;xsd:group ref="BaseAuditGroup" /&gt;
                &lt;/xsd:sequence&gt;
            &lt;/xsd:extension&gt;
        &lt;/xsd:complexContent&gt;
    &lt;/xsd:complexType&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the generation of a class - a subset of the following:</p>
</div>
<div class="listingblock">
<div class="title">part of generated AbstractAuditDtoType.java class</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    @Schema(name = "creatorUser", title = "creatorUser", description = "creatorUser", maxLength = 30, pattern = "[+a-zA-Z0-9_]{1,30}")
    protected String creatorUser;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The documentation on the user interface shows this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="pic/XSD_catalog_swaggerUI_sample.png" alt="XSD catalog swaggerUI sample">
</div>
<div class="title">Figure 4. swagger UI</div>
</div>
<div class="paragraph">
<p>The example doesn&#8217;t include xsd:documentation because I couldn&#8217;t find a suitable tiny example,
but generating it works.</p>
</div>
</div>
<div class="sect4">
<h5 id="_xsd_editors">XSD editors</h5>
<div class="paragraph">
<p>If no catalog file is used, all XSD editors can usually handle imports.
Using catalog complicates the situation.
The catalog file itself is an additional configuration file,
does not necessarily need to be on top of the XSD files.</p>
</div>
<div class="paragraph">
<p>In XSD management software, this must be added separately to resolve the referenced namespace prefixes.
Since most of us developers use Eclipse or IDEA, we will describe these in more detail.</p>
</div>
<div class="sect5">
<h6 id="_idea">IDEA</h6>
<div class="paragraph">
<p>This does not cause any particular problems in the configuration,
as IDEA&#8217;s XSD handler seems to be able to read the project settings from maven pom.xml,
so the catalog file can be read.
True, no one has tried it with an external catalog file&#8230;&#8203;</p>
</div>
</div>
<div class="sect5">
<h6 id="_eclipse">Eclipse</h6>
<div class="paragraph">
<p>For Catalog XSD, we have to manually create our own catalog file, since that is what the generator uses,
does not correspond to the Eclipse XSD/XML plugin.
The plugin itself cannot read from a maven structure the way the generator does.
The Eclipse plugin requires a fixed absolute path in the catalog, which is unique for each developer,
it can&#8217;t work with relative paths (which I think is ruled out by the linking process itself).</p>
</div>
<div class="paragraph">
<p>For help, a sample of what you need to manually create:</p>
</div>
<div class="listingblock">
<div class="title">/coffee-dto-xsd/example.eclipse.catalog.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;catalog xmlns="urn:oasis:names:tc:entity:xmlns:xml:catalog"&gt;
    &lt;public publicId="http://common.dto.coffee.icellmobilsoft.hu/common"
        uri="/home/ss/PROJECTS/ICELL/COFFEE/workspace/coffee/coffee-dto/coffee-dto-xsd/src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/common/common.xsd" /&gt;
    &lt;public publicId="http://common.dto.coffee.icellmobilsoft.hu/commonservice"
        uri="/home/ss/PROJECTS/ICELL/COFFEE/workspace/coffee/coffee-dto/coffee-dto-xsd/src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/common/commonservice.xsd" /&gt;
    &lt;public publicId="http://common.dto.coffee.icellmobilsoft.hu/commonsecurity"
        uri="/home/ss/PROJECTS/ICELL/COFFEE/workspace/coffee/coffee-dto/coffee-dto-xsd/src/main/resources/xsd/hu/icellmobilsoft/coffee/dto/common/commonsecurity.xsd" /&gt;
&lt;/catalog&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Everyone must set their own route!</p>
</div>
<div class="sect6">
<h7 id="howto_xsd_catalog_CatalogImport">Catalog import</h7>
<div class="paragraph">
<p>The Eclipse menus are the next step:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>File</code> &#8594; <code>Import</code></p>
</li>
<li>
<p>Within the window, down <code>XML</code> &#8594; <code>XML Catalog</code></p>
</li>
<li>
<p>Then <code>Next</code> and enter the above mentioned manually processed catalog file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the paths are filled correctly Eclipse can resolve the namespace references from now on
and the code assist will work.</p>
</div>
</div>
<div class="sect6">
<h7 id="_catalog_delete">Catalog delete</h7>
<div class="paragraph">
<p>If changes are made to the XSD structure then again <a href="#howto_xsd_catalog_CatalogImport">Catalog import</a>
but first you have to delete the old one.</p>
</div>
<div class="paragraph">
<p>This should be done as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Window</code> &#8594; <code>Preferences</code></p>
</li>
<li>
<p>In the window navigate to <code>XML</code> &#8594; <code>XML Catalog</code>.</p>
</li>
<li>
<p>You will see something like this: <span class="image"><img src="pic/XSD_catalog_catalog_delete.png" alt="XSD catalog catalog delete" title="Eclipse Catalog Delete"></span></p>
</li>
<li>
<p>We select the <code>User Specified Entries</code> items, then <code>Remove</code></p>
</li>
<li>
<p>Then you can go again to <a href="#howto_xsd_catalog_CatalogImport">Catalog import</a></p>
</li>
</ol>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Do not attempt to make any changes to <code>User Specified Entries</code>,
because they will be saved incorrectly by Eclipse after saving and unlocking the Catalog will not work.
This may be some Eclipse Bug.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_xml_schema_validation">XML Schema validation</h5>
<div class="paragraph">
<p>In <a href="#howto_xsd_catalog_CatalogMegoldas">Catalog solution</a> there is an example of the super.catalog.xml file.
In it you can see that the file is accessed via maven dependency:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>uri="maven:hu.icellmobilsoft.coffee.dto.xsd:coffee-dto-xsd:jar::!/xsd/en/icellmobilsoft/coffee/dto/common/common.xsd"</pre>
</div>
</div>
<div class="paragraph">
<p>This actually refers to the following:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">...
&lt;dependency&gt;
    &lt;groupId&gt;hu.icellmobilsoft.coffee.dto&lt;/groupId&gt;
    &lt;artifactId&gt;coffee-dto&lt;/artifactId&gt;
&lt;/dependency&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>So it unpacks from the .m2/repository/hu/icellmobilsoft/coffee/dto/coffee-dto/_VERSION_/coffee-dto.jar file
the XSD file /xsd/hu/icellmobilsoft/coffee/dto/common/common.xsd.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The following solution requires <strong>java 9+!</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>maven:</code> protocol itself is unknown to java.net.URL, so we need to write a handler for it:</p>
</div>
<div class="listingblock">
<div class="title">coffee-tool/src/main/java/hu/icellmobilsoft/coffee/tool/protocol/handler/MavenURLHandler.java content gist</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/**
 * Handling URL protocol for this format:
 *
 * &lt;pre&gt;
 * maven:hu.icellmobilsoft.coffee:coffee-dto-xsd:jar::!/xsd/hu/icellmobilsoft/coffee/dto/common/common.xsd
 * &lt;/pre&gt;
 *
 * Format is: &lt;code&gt;maven:groupId:atifactId:package:version:!file_path&lt;/code&gt;
 * &lt;ul&gt;
 * &lt;li&gt;protocol - URL schema protocol, in this case "maven"&lt;/li&gt;
 * &lt;li&gt;hu.icellmobilsoft.coffee.dto.xsd - maven groupId&lt;/li&gt;
 * &lt;li&gt;coffee-dto-xsd - maven artifactId&lt;/li&gt;
 * &lt;li&gt;jar - maven package&lt;/li&gt;
 * &lt;li&gt;maven version&lt;/li&gt;
 * &lt;/ul&gt;
 *</code></pre>
</div>
</div>
<div class="paragraph">
<p>This handler still needs to be registered as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a text file named <code>java.net.spi.URLStreamHandlerProvider</code> (without extension)</p>
</li>
<li>
<p>Include the content of the handler you have created.
If you have more than one of them, you can create a new line for each one.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In our case it will look like this:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/services/java.net.spi.URLStreamHandlerProvider</div>
<div class="content">
<pre class="highlight"><code class="language-txt" data-lang="txt">hu.icellmobilsoft.coffee.tool.protocol.handler.MavenURLStreamHandlerProvider</code></pre>
</div>
</div>
<div class="paragraph">
<p>From now on, the java 9+ XSD Catalog handler can read the path known by the generator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In order for JAXB itself to be able to validate via Catalog, it was necessary to create some classes,
which are not yet Coffee ready. This will be documented later, until then you will have to look at projects.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Why do we use string type for IDs and not int? <strong>For security reasons</strong>, IDs should be non-consecutive, otherwise they can be easily guessed, <strong>for portability reasons</strong> during a db migration, IDs with int type can easily get mixed up with existing data, <strong>in terms of extensibility</strong> we have more room for manoeuvre, <strong>in terms of quantity</strong> we are not limited, <strong>in terms of information carried</strong> the amount of data is not known by the system, <strong>in terms of synchronisation</strong> string is less expensive because using a sequence can stall the process (e.g. Oracle RAC) until all nodes respond.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-10-27 11:43:10 UTC
</div>
</div>
</body>
</html>